<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>T·∫°o Nh√¢n V·∫≠t AI ‚Äî Mi·ªÖn ph√≠ & Tr·∫£ ph√≠</title>
  <style>
    :root{ --bg1:#1e3c72; --bg2:#2a5298; --accent:#ff6b6b; --glass:rgba(0,0,0,.18) }
    html,body{height:100%}
    body{font-family:system-ui,"Segoe UI",sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#fff;margin:0}
    .wrap{max-width:1000px;margin:0 auto;padding:28px}
    .card{background:var(--glass);backdrop-filter:blur(8px);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:22px}
    h1{margin:0 0 6px;font-size:clamp(22px,3vw,34px)}
    .muted{opacity:.85}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .seg{display:flex;gap:10px;margin:12px 0 18px}
    .seg .opt{display:flex;gap:10px;align-items:center;padding:10px 14px;border-radius:12px;background:rgba(255,255,255,.12);cursor:pointer;border:1px solid rgba(255,255,255,.15)}
    .seg .opt.active{box-shadow:0 0 0 2px rgba(255,255,255,.22) inset}
    .badge{font-size:12px;padding:3px 7px;border-radius:999px;background:#1f8b24}
    .badge.warn{background:#b85c00}
    input,select,button{padding:12px 14px;border:none;border-radius:10px;font-size:16px}
    input[type="text"]{min-width:min(720px,92vw);outline:none}
    button{background:var(--accent);color:#fff;cursor:pointer}
    #status{margin:6px 0 12px;display:none}
    .pill{background:rgba(255,255,255,.15);padding:8px 10px;border-radius:999px}
    .pane{display:none}
    .pane.show{display:block}
    .iframe-wrap{border-radius:14px;overflow:hidden;background:rgba(0,0,0,.12)}
    .iframe-wrap iframe{width:100%;height:72vh;border:0;display:block}
    #thumb{max-width:100%;border-radius:14px;box-shadow:0 8px 20px rgba(0,0,0,.35)}
    .center{display:flex;justify-content:center;gap:10px;margin-top:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>üßô‚Äç‚ôÇÔ∏è T·∫°o Nh√¢n V·∫≠t Fantasy</h1>
      <div class="muted">Ch·ªçn ch·∫ø ƒë·ªô: <b>Mi·ªÖn ph√≠</b> (kh√¥ng t·ªën API) ho·∫∑c <b>Tr·∫£ ph√≠</b> (ch·∫•t l∆∞·ª£ng cao).</div>

      <!-- CH·ªåN CH·∫æ ƒê·ªò -->
      <div class="seg" id="modeSeg">
        <label class="opt" data-mode="free">
          <input type="radio" name="mode" value="free" hidden />
          <div>
            <div><b>Mi·ªÖn ph√≠</b> <span class="badge">0ƒë cho b·∫°n</span></div>
            <small class="muted">Ch·∫°y tr√™n tr√¨nh duy·ªát/Space ‚Äî t·ªëc ƒë·ªô & ·ªïn ƒë·ªãnh ph·ª• thu·ªôc m√°y/Space</small>
          </div>
        </label>
        <label class="opt" data-mode="paid">
          <input type="radio" name="mode" value="paid" hidden />
          <div>
            <div><b>Tr·∫£ ph√≠</b> <span class="badge warn">ch·∫•t l∆∞·ª£ng cao</span></div>
            <small class="muted">G·ªçi GPU cloud qua API (Replicate) ‚Äî t·ªën credit</small>
          </div>
        </label>
      </div>

      <!-- PANE MI·ªÑN PH√ç -->
      <div id="paneFree" class="pane">
        <div class="muted" style="margin:8px 0 10px">
          Ch·∫ø ƒë·ªô mi·ªÖn ph√≠: nh√∫ng Space s·∫µn c√≥ (kh√¥ng c·∫ßn API). B·∫°n c√≥ th·ªÉ thay URL b√™n d∆∞·ªõi.
        </div>
        <div class="iframe-wrap">
          <!-- TODO: thay Space n√†y b·∫±ng Space b·∫°n th√≠ch (vd: SDXL/Flux demo) -->
          <iframe id="freeFrame"
            src="https://huggingface.co/spaces/hysts/SDXL"
            title="Free Space (HF)" loading="lazy"></iframe>
        </div>
      </div>

      <!-- PANE TR·∫¢ PH√ç -->
      <div id="panePaid" class="pane">
        <p class="muted">Nh·∫≠p m√¥ t·∫£ ‚Üí AI v·∫Ω. S·ª≠ d·ª•ng Replicate qua Netlify Functions (b·∫£o m·∫≠t key).</p>
        <div class="row">
          <input id="prompt" type="text" placeholder="VD: n·ªØ ph√°p s∆∞ bƒÉng, t√≥c tr·∫Øng, √°o cho√†ng xanh, c·∫ßm g·∫≠y ph√©p" />
        </div>
        <div class="row">
          <select id="model">
            <option value="black-forest-labs/flux-1.1-pro">Flux 1.1 Pro (Replicate) ‚Äî ƒë·∫πp</option>
            <option value="stability-ai/sdxl">Stable Diffusion XL (Replicate) ‚Äî ·ªïn</option>
          </select>
          <button id="btnGen">T·∫°o Nh√¢n V·∫≠t!</button>
        </div>
        <div id="status" class="pill"></div>
        <div id="result"></div>
        <div class="muted" style="margin-top:6px">·∫¢nh t·∫°o b·ªüi m√¥ h√¨nh AI tr√™n Replicate qua Netlify Functions ‚Ä¢ C√≥ t√≠nh ph√≠ theo credit.</div>
      </div>
    </div>
  </div>

  <script>
    // ======= Mode Switcher =======
    const $ = s=>document.querySelector(s);
    const seg = $("#modeSeg");
    const paneFree = $("#paneFree");
    const panePaid = $("#panePaid");

    function setMode(mode){
      localStorage.setItem("avatar_mode", mode);
      [...seg.querySelectorAll(".opt")].forEach(o=>{
        o.classList.toggle("active", o.dataset.mode===mode);
        const i = o.querySelector('input[type="radio"]');
        if(i) i.checked = (o.dataset.mode===mode);
      });
      paneFree.classList.toggle("show", mode==="free");
      panePaid.classList.toggle("show", mode==="paid");
    }
    seg.addEventListener("click", e=>{
      const opt = e.target.closest(".opt"); if(!opt) return;
      setMode(opt.dataset.mode);
    });

    setMode(localStorage.getItem("avatar_mode") || "free"); // m·∫∑c ƒë·ªãnh Free

    // ======= Paid flow (Replicate) =======
    const statusBox = $("#status");
    const resultDiv = $("#result");
    $("#btnGen").addEventListener("click", generate);

    function setStatus(text){
      if(!text){ statusBox.style.display="none"; statusBox.textContent=""; return; }
      statusBox.textContent = text; statusBox.style.display="inline-block";
    }

    async function generate(){
      const prompt = $("#prompt").value.trim();
      const model  = $("#model").value;
      if(!prompt){ alert("H√£y nh·∫≠p m√¥ t·∫£!"); return; }

      resultDiv.innerHTML = "";
      setStatus("ƒêang g·ª≠i y√™u c·∫ßu‚Ä¶");

      try{
        // Chu·∫©n h√≥a input theo model
        let input;
        if (model.includes("flux")) {
          input = { prompt, aspect_ratio: "1:1", output_format: "png", num_inference_steps: 28, guidance: 3.5 };
        } else if (model.includes("sdxl")) {
          input = { prompt, width: 1024, height: 1024, num_inference_steps: 30, guidance_scale: 7 };
        } else {
          input = { prompt };
        }

        // T·∫°o prediction qua proxy
        const resp = await fetch("/.netlify/functions/replicate-proxy", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ model, input })
        });

        if (!resp.ok) {
          const txt = await resp.text();
          throw new Error(`Replicate ${resp.status}: ${txt}`);
        }
        const start = await resp.json();
        if(!start?.id) throw new Error(start?.error || "Kh√¥ng t·∫°o ƒë∆∞·ª£c job");

        // Poll
        let data = start, tries = 0;
        while (["starting","processing","queued"].includes(data.status)) {
          setStatus(`ƒêang x·ª≠ l√Ω (${data.status})‚Ä¶`);
          await new Promise(r=>setTimeout(r, 1500));
          const r = await fetch("/.netlify/functions/replicate-get?id="+start.id);
          if (!r.ok) throw new Error("L·ªói khi l·∫•y k·∫øt qu·∫£");
          data = await r.json();
          if (++tries>240) throw new Error("Qu√° th·ªùi gian ch·ªù");
        }
        if (data.status !== "succeeded") throw new Error(data?.error || "Job kh√¥ng th√†nh c√¥ng");

        setStatus("Ho√†n t·∫•t ‚úì");
        const outs = Array.isArray(data.output) ? data.output : [data.output];
        resultDiv.innerHTML = outs.filter(Boolean).map((u,i)=>`
          <div>
            <img id="thumb" src="${u}" alt="K·∫øt qu·∫£ #${i+1}"/>
            <div class="center">
              <a class="pill" href="${u}" target="_blank" rel="noopener">M·ªü ·∫£nh g·ªëc</a>
              <a class="pill" download="avatar-ai-${Date.now()}.png" href="${u}">T·∫£i ·∫£nh</a>
            </div>
          </div>
        `).join("");

      }catch(err){
        console.error(err);
        setStatus("");
        resultDiv.innerHTML = `<p class="pill" style="background:#6d1d20">L·ªói: ${err.message || err}</p>`;
      }
    }
  </script>
</body>
</html>
