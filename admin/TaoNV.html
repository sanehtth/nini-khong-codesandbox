<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>T·∫°o Nh√¢n V·∫≠t AI</title>
  <style>
    :root { --bg1:#1e3c72; --bg2:#2a5298; --accent:#ff6b6b; }
    body {font-family: system-ui, "Segoe UI", sans-serif; background: linear-gradient(135deg,var(--bg1),var(--bg2)); color:#fff; text-align:center; padding:32px;}
    h1 {font-size: clamp(22px, 3vw, 34px); margin: 0 0 6px}
    p.muted {opacity:.85; margin: 0 0 18px}
    .card {max-width:980px;margin:0 auto;background:rgba(0,0,0,.18);border-radius:18px;padding:24px;box-shadow:0 10px 30px rgba(0,0,0,.25);backdrop-filter: blur(8px);}
    .row {display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin:10px 0 18px}
    input, select, button {padding:12px 14px;font-size:16px;border:none;border-radius:10px}
    input[type="text"]{min-width: min(720px, 92vw); outline:none}
    button {background:var(--accent); color:#fff; cursor:pointer; transition:.2s}
    button:hover {filter:brightness(1.05)}
    .loading {color:#ffd93d; font-style:italic}
    #thumb {max-width: 100%; border-radius:14px; box-shadow:0 8px 20px rgba(0,0,0,.35)}
    .grid {display:grid; grid-template-columns: 1fr; gap:14px}
    .foot {margin-top:10px; opacity:.85}
    .pill {background: rgba(255,255,255,.15); padding: 8px 10px; border-radius: 999px}
    .hide {display:none !important}
  </style>
</head>
<body>
  <div class="card">
    <h1>üßô‚Äç‚ôÇÔ∏è T·∫°o Nh√¢n V·∫≠t Fantasy</h1>
    <p class="muted">Nh·∫≠p m√¥ t·∫£ ‚Üí AI v·∫Ω ngay!</p>

    <div class="row">
      <input id="prompt" type="text" placeholder="VD: n·ªØ ph√°p s∆∞ bƒÉng, t√≥c tr·∫Øng, √°o cho√†ng xanh, c·∫ßm g·∫≠y ph√©p" />
    </div>
    <div class="row">
      <select id="model">
        <!-- B·∫°n c√≥ th·ªÉ thay model t√πy √Ω; FLUX-1.1-pro cho k·∫øt qu·∫£ t·ªët -->
        <option value="black-forest-labs/flux-1.1-pro">Flux 1.1 Pro (Replicate)</option>
        <option value="stability-ai/sdxl">Stable Diffusion XL (Replicate)</option>
      </select>
      <button id="btnGen">T·∫°o Nh√¢n V·∫≠t!</button>
    </div>

    <div id="status" class="pill hide"></div>

    <div id="result" class="grid">
      <!-- ·∫¢nh k·∫øt qu·∫£ -->
    </div>

    <div class="foot">
      <small class="muted">·∫¢nh t·∫°o b·ªüi m√¥ h√¨nh AI tr√™n Replicate qua Netlify Functions ‚Ä¢ Kh√¥ng l·ªô API key</small>
    </div>
  </div>

  <script>
    const $ = (s)=>document.querySelector(s);
    const statusBox = $("#status");
    const resultDiv = $("#result");
    $("#btnGen").addEventListener("click", generate);

    function setStatus(text){ 
      if(!text){ statusBox.classList.add("hide"); statusBox.textContent=""; return; }
      statusBox.textContent = text; statusBox.classList.remove("hide");
    }

    async function generate(){
      const prompt = $("#prompt").value.trim();
      const model  = $("#model").value;
      if(!prompt){ alert("H√£y nh·∫≠p m√¥ t·∫£!"); return; }

      resultDiv.innerHTML = "";
      setStatus("ƒêang g·ª≠i y√™u c·∫ßu‚Ä¶");

      try{
        // 1) T·∫°o prediction qua proxy serverless
        const start = await fetch("/.netlify/functions/replicate-proxy", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({
            model,
            // input chu·∫©n cho m·ªói model: m√¨nh ƒë·ªÉ m·∫∑c ƒë·ªãnh width/height 1024
            input: { prompt, width: 1024, height: 1024, guidance: 3.5, num_inference_steps: 28 }
          })
        }).then(r=>r.json());

        if(!start?.id) throw new Error(start?.error || "Kh√¥ng t·∫°o ƒë∆∞·ª£c job");

        // 2) Poll t·ªõi khi xong
        let data = start, tries = 0;
        while (["starting","processing","queued"].includes(data.status)) {
          setStatus(`ƒêang x·ª≠ l√Ω (${data.status})‚Ä¶`);
          await new Promise(r=>setTimeout(r, 1500));
          data = await fetch("/.netlify/functions/replicate-get?id="+start.id).then(r=>r.json());
          if (++tries>240) throw new Error("Qu√° th·ªùi gian ch·ªù");
        }

        if (data.status !== "succeeded") {
          throw new Error(data?.error || "Job kh√¥ng th√†nh c√¥ng");
        }

        setStatus("Ho√†n t·∫•t ‚úì");

        // 3) Hi·ªÉn th·ªã k·∫øt qu·∫£ (Replicate tr·∫£ v·ªÅ m·∫£ng URL)
        const urls = Array.isArray(data.output) ? data.output : [data.output];
        resultDiv.innerHTML = urls.filter(Boolean).map((u,i)=>`
          <div>
            <img id="thumb" src="${u}" alt="K·∫øt qu·∫£ #${i+1}" />
            <div class="row" style="justify-content:center;margin-top:10px">
              <a class="pill" href="${u}" target="_blank" rel="noopener">M·ªü ·∫£nh g·ªëc</a>
              <a class="pill" download="avatar-ai-${Date.now()}.png" href="${u}">T·∫£i ·∫£nh</a>
            </div>
          </div>
        `).join("");

      }catch(err){
        console.error(err);
        setStatus("");
        resultDiv.innerHTML = `<p class="loading" style="color:#ff9e9e">L·ªói: ${err.message || err}</p>`;
      }
    }
  </script>
</body>
</html>
