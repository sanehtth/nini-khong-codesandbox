<!doctype html>
<html lang="vi">
  <script>
(function(){
  const ENDPOINT='/.netlify/functions/theme';
  const KEY='NINI_THEME_CACHE_V1';
  const MAX_AGE=3600; // 1h

  function inject(css){
    try{
      let s=document.getElementById('themeOverride');
      if(!s){ s=document.createElement('style'); s.id='themeOverride'; document.head.appendChild(s); }
      s.textContent=css;
    }catch(_){}
  }

  try{
    const cache=JSON.parse(localStorage.getItem(KEY)||'null');
    const now=Date.now()/1000|0;
    if(cache && (now-cache.ts)<MAX_AGE){ inject(cache.css); }
    fetch(ENDPOINT, {cache:'no-store'})
      .then(r=>r.text())
      .then(css=>{
        if(css){ inject(css); localStorage.setItem(KEY, JSON.stringify({ts: now, css})); }
      }).catch(_=>{});
  }catch(_){}
})();
</script>

</head>
<body data-page="auth" style="--bg-url:url('/public/assets/bg/nini_home.webp')">
  <header class="site-header">
    <a class="brand" href="/#home" aria-label="NiNi — Funny">
      <img class="brand__logo" src="/public/assets/icons/logo_text.webp" alt="NiNi Funny">
      <div class="brand__slogan">Chơi mê ly, bứt phá tư duy</div>
    </a>
  <body>
    <div style="flex:1"></div>
    <a class="btn" href="/admin/index.html">↩ Về Admin</a>
  </header>

  <main class="shell">
    <section class="glass-card">
      <div class="toolbar">
        <strong>Avatar Builder</strong>
        <span class="muted">/public/content/avatars/<b>avatar-manifest.json</b></span>
        <button id="btnAdd" class="btn small">+ Thêm avatar</button>
        <button id="btnSave" class="btn small">Lưu nháp (trình duyệt)</button>
        <button id="btnImport" class="btn small">Import JSON</button>
        <button id="btnDownload" class="btn small">Tải manifest.json</button>
        <button id="btnFetch" class="btn small">Tải từ GitHub/site</button>
        <input type="file" id="filePicker" accept=".json" hidden>
        <span id="stat" class="muted"></span>
      </div>

      <div class="grid head">
        <div>Ảnh</div><div>ID</div><div>Tên VI</div><div>Tên EN</div>
        <div>Độ hiếm</div><div>Giá (xu)</div><div>XP cần</div><div>Ảnh URL</div>
      </div>
      <div id="rows"></div>

      <div class="note">
        Gợi ý schema:
        <code>{ id, title_vi, title_en, image, rarity, price, xp_required, tags }</code>.
        Ảnh đề xuất lưu ở <code>/public/assets/avatar/*.webp</code>.
      </div>
    </section>
  </main>

  <script>
    const LS_KEY = "ADMIN_AVATARS_DRAFT_V1";
    const REMOTE_JSON = "/public/content/avatars/avatar-manifest.json";

    const $ = s => document.querySelector(s);
    const rowsEl = $("#rows"), stat = $("#stat");
    const rarityOptions = ["common","rare","epic","legendary"];

    let avatars = loadDraft() || [
      { id:"NV1", title_vi:"NiNi – bạn nhỏ", title_en:"NiNi – buddy",
        image:"/public/assets/avatar/NV1.webp", rarity:"common", price:0, xp_required:0, tags:["starter"] }
    ];
    render();

    $("#btnAdd").onclick = () => { avatars.push(blank()); render(); };
    $("#btnSave").onclick = () => { saveDraft(); flash("Đã lưu nháp vào trình duyệt"); };
    $("#btnDownload").onclick = () => {
      const payload = manifest();
      download("avatar-manifest.json", JSON.stringify(payload, null, 2));
    };
    $("#btnImport").onclick = () => $("#filePicker").click();
    $("#filePicker").onchange = async (e)=>{
      const f = e.target.files[0]; if(!f) return;
      try{
        const text = await f.text();
        const j = JSON.parse(text);
        if (Array.isArray(j.avatars)) avatars = j.avatars; else if (Array.isArray(j)) avatars = j;
        else throw new Error("JSON không đúng định dạng.");
        render(); flash("Đã import JSON");
      }catch(err){ alert("Import lỗi: " + err.message); }
      e.target.value = "";
    };
    $("#btnFetch").onclick = async ()=>{
      try{
        const r = await fetch(REMOTE_JSON, { cache:"no-store" });
        const j = await r.json();
        if (!j) throw 0;
        avatars = Array.isArray(j.avatars) ? j.avatars : (Array.isArray(j) ? j : []);
        render(); flash("Đã tải manifest hiện có.");
      }catch{ alert("Không tìm thấy hoặc đọc được " + REMOTE_JSON); }
    };

    function blank(){
      return { id:"AVT"+String(Date.now()).slice(-5),
               title_vi:"", title_en:"",
               image:"/public/assets/avatar/NV1.webp",
               rarity:"common", price:0, xp_required:0, tags:[] };
    }
    function manifest(){ return { updatedAt: Date.now(), avatars }; }
    function saveDraft(){ localStorage.setItem(LS_KEY, JSON.stringify(avatars)); }
    function loadDraft(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||"null"); }catch{ return null; } }
    function flash(msg){ stat.textContent = msg; setTimeout(()=>stat.textContent="",1800); }
    function download(name, text){
      const blob = new Blob([text], {type:"application/json;charset=utf-8"});
      const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = name;
      document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); },0);
    }

    function render(){
      rowsEl.innerHTML = avatars.map((avt, i) => rowTpl(avt, i)).join("");
      rowsEl.querySelectorAll("[data-idx]").forEach(el=>{
        const i = Number(el.dataset.idx);
        if (el.name === "image") el.addEventListener("input", e=>update(i,"image",e.target.value,true));
        if (el.name === "id")    el.addEventListener("input", e=>update(i,"id",e.target.value));
        if (el.name === "vi")    el.addEventListener("input", e=>update(i,"title_vi",e.target.value));
        if (el.name === "en")    el.addEventListener("input", e=>update(i,"title_en",e.target.value));
        if (el.name === "rarity")el.addEventListener("change",e=>update(i,"rarity",e.target.value));
        if (el.name === "price") el.addEventListener("input", e=>update(i,"price", Number(e.target.value||0)));
        if (el.name === "xp")    el.addEventListener("input", e=>update(i,"xp_required", Number(e.target.value||0)));
      });
      rowsEl.querySelectorAll("[data-action]").forEach(btn=>{
        const i = Number(btn.dataset.i);
        const act = btn.dataset.action;
        btn.onclick = ()=>{
          if (act==="up"   && i>0)              { const [x]=avatars.splice(i,1); avatars.splice(i-1,0,x); render(); }
          if (act==="down" && i<avatars.length-1){ const [x]=avatars.splice(i,1); avatars.splice(i+1,0,x); render(); }
          if (act==="del") { if (confirm("Xóa avatar này?")) { avatars.splice(i,1); render(); } }
        };
      });
    }
    function update(i, key, val, alsoPic=false){
      avatars[i][key] = val;
      if (alsoPic){
        const img = document.querySelector(`img[data-pic="${i}"]`);
        if (img) img.src = val;
      }
    }
    function rowTpl(avt, i){
      return `
        <div class="grid">
          <div><img class="avt-img" data-pic="${i}" alt="" src="${esc(avt.image)}"></div>
          <input class="input" name="id"  data-idx="${i}" value="${esc(avt.id)}">
          <input class="input" name="vi"  data-idx="${i}" value="${esc(avt.title_vi||"")}">
          <input class="input" name="en"  data-idx="${i}" value="${esc(avt.title_en||"")}">
          <select class="input" name="rarity" data-idx="${i}">
            ${rarityOptions.map(r=>`<option value="${r}" ${avt.rarity===r?"selected":""}>${r}</option>`).join("")}
          </select>
          <input class="input" name="price" type="number" min="0" step="1" data-idx="${i}" value="${Number(avt.price||0)}">
          <input class="input" name="xp"    type="number" min="0" step="1" data-idx="${i}" value="${Number(avt.xp_required||0)}">
          <div class="row-btns">
            <input class="input" style="min-width:280px" name="image" data-idx="${i}" value="${esc(avt.image)}">
            <button class="btn small" data-action="up"   data-i="${i}" title="Lên">↑</button>
            <button class="btn small" data-action="down" data-i="${i}" title="Xuống">↓</button>
            <button class="btn small danger" data-action="del" data-i="${i}" title="Xóa">X</button>
          </div>
        </div>`;
    }
    function esc(s){ return s==null ? "" : String(s).replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c])); }
  </script>
</body>
</html>


