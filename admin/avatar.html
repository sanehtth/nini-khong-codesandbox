<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NiNi — Avatar Builder</title>
  <link rel="icon" href="/public/assets/icons/logonini.svg" type="image/svg+xml" />
  <link rel="stylesheet" href="/public/theme/nini-base.css" />
  <style>
    .grid.head{display:grid;grid-template-columns:80px 100px 1fr 1fr 120px 120px 120px 1fr;gap:8px;padding:8px 12px}
    .grid.row {display:grid;grid-template-columns:80px 100px 1fr 1fr 120px 120px 120px 1fr;gap:8px;padding:8px 12px;align-items:center}
    .avt-img{width:64px;height:64px;border-radius:12px;object-fit:cover;border:1px solid rgba(255,255,255,.3)}
    .row-btns{display:flex;gap:6px;align-items:center}
  </style>
</head>
<body style="--bg-url:url('/public/assets/bg/nini_home.webp')">
  <header class="site-header">
    <a class="brand" href="/#home" aria-label="NiNi — Funny">
      <img class="brand__logo" src="/public/assets/icons/logo_text.webp" alt="NiNi Funny" />
      <div class="brand__slogan">Chơi mê ly, bứt phá tư duy</div>
    </a>
    <div class="spacer"></div>
    <a class="btn" href="/admin/index.html">↩ Admin</a>
  </header>

  <main class="page-hero">
    <section class="panel">
      <h2>Avatar Builder</h2>
      <div class="row">
        <button id="btnAdd" class="btn">+ Thêm avatar</button>
        <button id="btnSave" class="btn">Lưu nháp</button>
        <button id="btnFetch" class="btn">Tải từ site</button>
        <button id="btnDownload" class="btn">Tải manifest.json</button>
        <input type="file" id="filePicker" accept=".json" hidden>
        <span id="stat" class="muted"></span>
      </div>

      <div class="grid head">
        <div>Ảnh</div><div>ID</div><div>Tên VI</div><div>Tên EN</div>
        <div>Độ hiếm</div><div>Giá (xu)</div><div>XP cần</div><div>Ảnh URL</div>
      </div>
      <div id="rows"></div>

      <p class="note">Schema: <code>{ id, title_vi, title_en, image, rarity, price, xp_required, tags }</code></p>
    </section>
  </main>

  <script>
    const $ = s => document.querySelector(s);
    const rowsEl = $("#rows"), stat = $("#stat");
    const LS_KEY = "ADMIN_AVATARS_DRAFT_V1";
    const REMOTE_JSON = "/public/content/avatars/avatar-manifest.json";
    const rarities = ["common","rare","epic","legendary"];

    let avatars = loadDraft() || [
      { id:"NV1", title_vi:"NiNi bạn nhỏ", title_en:"NiNi buddy",
        image:"/public/assets/avatar/NV1.webp", rarity:"common", price:0, xp_required:0, tags:["starter"] }
    ];
    render();

    $("#btnAdd").onclick = ()=>{ avatars.push(blank()); render(); };
    $("#btnSave").onclick = ()=>{ localStorage.setItem(LS_KEY, JSON.stringify(avatars)); flash("Đã lưu nháp."); };
    $("#btnFetch").onclick = async()=>{
      try{
        const r = await fetch(REMOTE_JSON, {cache:"no-store"});
        const j = await r.json();
        avatars = Array.isArray(j.avatars)? j.avatars : (Array.isArray(j)? j : []);
        render(); flash("Đã tải manifest hiện có.");
      }catch{ alert("Không đọc được " + REMOTE_JSON); }
    };
    $("#btnDownload").onclick = ()=>{
      const payload = { updatedAt: Date.now(), avatars };
      download("avatar-manifest.json", JSON.stringify(payload, null, 2));
    };

    function blank(){ return { id:`AVT${Date.now()%100000}`, title_vi:"", title_en:"", image:"/public/assets/avatar/NV1.webp", rarity:"common", price:0, xp_required:0, tags:[] }; }
    function loadDraft(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||"null"); }catch{return null;} }
    function flash(m){ stat.textContent=m; setTimeout(()=>stat.textContent="",1500); }
    function download(name, text){
      const blob = new Blob([text], {type:"application/json;charset=utf-8"});
      const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download=name;
      document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); },0);
    }
    function esc(s){ return s==null ? "" : String(s).replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c])); }

    function render(){
      rowsEl.innerHTML = avatars.map((av, i) => `
        <div class="grid row">
          <div><img class="avt-img" data-pic="${i}" alt="" src="${esc(av.image)}"></div>
          <input class="input" data-idx="${i}" name="id"  value="${esc(av.id)}">
          <input class="input" data-idx="${i}" name="vi"  value="${esc(av.title_vi||"")}">
          <input class="input" data-idx="${i}" name="en"  value="${esc(av.title_en||"")}">
          <select class="input" data-idx="${i}" name="rarity">
            ${rarities.map(r=>`<option value="${r}" ${av.rarity===r?"selected":""}>${r}</option>`).join("")}
          </select>
          <input class="input" data-idx="${i}" name="price" type="number" min="0" step="1" value="${Number(av.price||0)}">
          <input class="input" data-idx="${i}" name="xp"    type="number" min="0" step="1" value="${Number(av.xp_required||0)}">
          <div class="row-btns">
            <input class="input" style="min-width:260px" data-idx="${i}" name="image" value="${esc(av.image)}">
            <button class="btn small" data-act="up" data-i="${i}">↑</button>
            <button class="btn small" data-act="down" data-i="${i}">↓</button>
            <button class="btn small danger" data-act="del" data-i="${i}">X</button>
          </div>
        </div>
      `).join("");

      rowsEl.querySelectorAll("[data-idx]").forEach(el=>{
        const i = Number(el.dataset.idx);
        const nm = el.name;
        el.oninput = (e)=>{
          const v = (nm==="price"||nm==="xp") ? Number(e.target.value||0) : e.target.value;
          if (nm==="vi") avatars[i].title_vi = v;
          else if (nm==="en") avatars[i].title_en = v;
          else if (nm==="rarity") avatars[i].rarity = v;
          else avatars[i][nm] = v;
          if (nm==="image") {
            const pic = rowsEl.querySelector(`img[data-pic="${i}"]`);
            if (pic) pic.src = v;
          }
        };
      });

      rowsEl.querySelectorAll("[data-act]").forEach(btn=>{
        const i = Number(btn.dataset.i), act = btn.dataset.act;
        btn.onclick = ()=>{
          if (act==="up" && i>0){ const [x]=avatars.splice(i,1); avatars.splice(i-1,0,x); render(); }
          if (act==="down" && i<avatars.length-1){ const [x]=avatars.splice(i,1); avatars.splice(i+1,0,x); render(); }
          if (act==="del"){ if (confirm("Xoá avatar này?")){ avatars.splice(i,1); render(); } }
        };
      });
    }
  </script>
</body>
</html>
