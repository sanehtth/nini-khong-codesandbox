<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NiNi ‚Äî Admin</title>
  <link rel="icon" href="/public/assets/icons/logonini.webp" type="image/webp" />
  <link rel="stylesheet" href="/styles.css?v=admin-base" />
  <style>
    /* ===== N·ªÅn m·∫∑c ƒë·ªãnh (ƒë·ªìng b·ªô to√†n site) ===== */
    :root{ --bg-url: url('/public/assets/bg/nini_home.webp'); }
    body{
      min-height:100vh;
      color:#1c2024;
      background: #0b1f10 var(--bg-url) center/cover fixed no-repeat;
    }
    /* l·ªõp ph·ªß nh·∫π ƒë·ªÉ ch·ªØ r√µ h∆°n */
    body::before{
      content:""; position:fixed; inset:0; pointer-events:none;
      background: radial-gradient(ellipse at 50% 15%, rgba(255,255,255,.12), transparent 45%) ,
                  linear-gradient(to bottom, rgba(255,255,255,.10), transparent 50%);
      z-index:-1;
    }

    :root{
      --glass-bg: rgba(255,255,255,.16);
      --glass-brd: rgba(255,255,255,.35);
      --shadow: 0 12px 30px rgba(47,110,63,.28);
      --ink:#1c2024; --muted:#6b7b8c;
      --radius:18px;
      --green:#2f6e3f; --green-2:#21512d;
    }

    /* ===== Header gi·ªëng trang index ===== */
    .site-header{
      width:min(1180px,94vw); margin:14px auto 10px;
      display:flex; align-items:center; gap:14px;
      backdrop-filter: blur(10px);
      background: var(--glass-bg);
      border:1px solid var(--glass-brd);
      border-radius:14px; padding:10px 14px;
      box-shadow: var(--shadow);
    }
    .brand{display:flex;align-items:center;gap:10px;text-decoration:none}
    .brand__logo{height:34px;width:auto}
    .brand__slogan{
      font-weight:800; letter-spacing:.2px;
      background: linear-gradient(90deg,#F5D36B,#47A768,#8a5a2b);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      animation:hue 10s linear infinite;
      user-select:none;
    }
    @keyframes hue{0%{filter:hue-rotate(0)}100%{filter:hue-rotate(360deg)}}
    .spacer{flex:1}

    .btn{
      appearance:none; border:1px solid var(--glass-brd);
      background: var(--glass-bg); color:var(--ink);
      border-radius:999px; padding:8px 14px; cursor:pointer;
      box-shadow: 0 4px 10px rgba(47,110,63,.18);
      transition: transform .05s ease, box-shadow .2s ease, border-color .2s ease;
      backdrop-filter: blur(8px);
    }
    .btn:hover{ transform:translateY(-1px); box-shadow:0 10px 22px rgba(47,110,63,.32); border-color:#fff }
    .btn.small{ padding:6px 10px; }
    .btn.solid{ background:#2f6e3f; color:#fff; border-color:#2f6e3f }

    .shell{width:min(1180px,94vw); margin:16px auto 80px}

    .admin-tabs{ display:flex; gap:10px; flex-wrap:wrap; }
    .admin-tab{
      border:1px solid var(--glass-brd);
      background: var(--glass-bg);
      border-radius:999px; padding:8px 14px; cursor:pointer;
      backdrop-filter: blur(8px);
    }
    .admin-tab.is-active{
      box-shadow: 0 0 0 2px rgba(47,110,63,.25), 0 10px 26px rgba(47,110,63,.35);
      border-color:#fff;
    }

    .glass-card{
      background: var(--glass-bg);
      border:1px solid var(--glass-brd);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      margin-top:14px;
    }
    .glass-head{ padding:12px 14px; border-bottom:1px solid var(--glass-brd) }

    .panel{ display:none } .panel.is-current{ display:block }

    .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; padding:14px }

    /* B·∫£ng */
    .table-wrap{ overflow:auto; border-radius: 0 0 var(--radius) var(--radius); }
    table{ width:100%; border-collapse: collapse; color:var(--ink); }
    thead tr{ background: rgba(255,255,255,.25); }
    th,td{ padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.25); text-align:left }
    tbody tr:hover{ background: rgba(255,255,255,.08) }

    .input{
      background:transparent; border:0; outline:none; color:var(--ink);
      border-bottom:2px solid rgba(255,255,255,.55);
      padding:6px 4px; min-width: 220px;
    }
    .input:focus{ border-bottom-color:#9fc5b0; box-shadow: 0 4px 0 -2px rgba(47,110,63,.25) inset; }
    .muted{ color:var(--muted); font-size:13px }

    /* ===== Theme editor ===== */
    .editor-wrap{
      display:grid; grid-template-columns: 1fr 280px; gap:12px;
      padding:0 12px 14px 12px;
    }
    #themeEditor{
      width:100%; min-height: 58vh;
      font: 12.5px/1.5 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
      color:#0d1a10; background:rgba(255,255,255,.22);
      border:1px solid var(--glass-brd); border-radius:12px; padding:12px;
      outline:none; box-shadow: inset 0 0 0 1px rgba(255,255,255,.15);
      backdrop-filter: blur(6px);
      white-space: pre; overflow:auto;
    }
    .hint{
      background:rgba(255,255,255,.18);
      border:1px solid var(--glass-brd); border-radius:12px;
      padding:12px; font-size:13px; color:var(--ink);
      height:fit-content;
    }

    /* Back-to-home link look */
    .link{ text-decoration:none; color:var(--green-2); font-weight:700 }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="site-header">
    <a class="brand" href="/#home" aria-label="NiNi ‚Äî Funny">
      <img class="brand__logo" src="/public/assets/icons/logo_text.webp" alt="NiNi Funny" />
      <div class="brand__slogan"><span>Ch∆°i</span> <span>m√™ l√Ω</span>, <span>b·ª©t ph√°</span> <span>t∆∞ duy</span></div>
    </a>
    <div class="spacer"></div>
    <a class="btn" href="/" rel="noopener">‚Üò V·ªÅ trang ch·ªß</a>
    <button id="btnLogout" class="btn">ƒêƒÉng xu·∫•t</button>
  </header>

  <main class="shell">
    <!-- Tabs -->
    <!-- Tabs admin -->
<nav class="admin-tabs" id="adminTabs" aria-label="Admin sections">
  <button class="admin-tab is-active" data-tab="scores">B·∫£ng ƒëi·ªÉm (theo ng√†y)</button>
  <button class="admin-tab" data-tab="queue">H√†ng ƒë·ª£i c·ª•c b·ªô</button>
  <button class="admin-tab" data-tab="reports">B√°o c√°o ng√†y</button>
  <button class="admin-tab" data-tab="theme">Ch·ªânh style</button>

  <!-- C√°c tool m·ªü trang ri√™ng -->
  <a class="admin-tab" href="/admin/storybook.html" style="text-decoration:none">T·∫°o Storybook</a>
  <a class="admin-tab" href="/admin/avatar.html" style="text-decoration:none">T·∫°o Avatar JSON</a>
</nav>


    <!-- Panel: Scores -->
    <section id="p-scores" class="panel is-current glass-card" aria-labelledby="tab-scores">
      <div class="glass-head">
        <div class="muted">Ch·ªçn ng√†y ‚ûú t·∫£i d·ªØ li·ªáu (ƒë·ªçc t·ª´ Function c·ªßa b·∫°n).</div>
      </div>
      <div class="toolbar">
        <input id="pickDate" type="date" class="input" />
        <button id="btnLoad" class="btn small">T·∫£i d·ªØ li·ªáu</button>
        <button id="btnCsv"  class="btn small">T·∫£i CSV</button>
        <span id="stat" class="muted"></span>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Th·ªùi gian (UTC)</th>
              <th>User</th>
              <th>T√™n</th>
              <th>Game</th>
              <th>Session</th>
              <th>ƒêi·ªÉm</th>
              <th>T·ªëi ƒëa</th>
              <th>Gi√¢y</th>
            </tr>
          </thead>
          <tbody id="grid"></tbody>
        </table>
      </div>
    </section>

    <!-- Panel: Queue -->
    <section id="p-queue" class="panel glass-card">
      <div class="glass-head"><strong>H√†ng ƒë·ª£i c·ª•c b·ªô</strong></div>
      <div class="toolbar">
        <span class="muted">Khu v·ª±c n√†y b·∫°n c√≥ th·ªÉ g·∫Øn l·∫°i <code>queue.js</code> c·ªßa b·∫°n.</span>
      </div>
    </section>

    <!-- Panel: Reports -->
    <section id="p-reports" class="panel glass-card">
      <div class="glass-head"><strong>B√°o c√°o ng√†y</strong></div>
      <div class="toolbar">
        <span class="muted">G·ªçi Function <code>daily-rollup</code> c·ªßa b·∫°n n·∫øu ƒë√£ tri·ªÉn khai.</span>
      </div>
    </section>

    <!-- Panel: Theme Editor -->
    <section id="p-theme" class="panel glass-card">
      <div class="glass-head"><strong>üé® Ch·ªânh style (Theme CSS)</strong></div>
      <div class="toolbar">
        <button id="btnThemeLoad" class="btn small">T·∫£i style hi·ªán t·∫°i</button>
        <button id="btnThemeSave" class="btn small solid">L∆∞u style</button>
        <button id="btnThemeReset" class="btn small">M·∫´u m·∫∑c ƒë·ªãnh</button>
        <button id="btnThemeDownload" class="btn small">T·∫£i .css</button>
        <span id="themeStat" class="muted"></span>
      </div>
      <div class="editor-wrap">
        <textarea id="themeEditor" spellcheck="false"></textarea>
        <aside class="hint">
          <p><strong>H∆∞·ªõng d·∫´n nhanh</strong></p>
          <ol>
            <li>Nh·∫•n <em>T·∫£i style hi·ªán t·∫°i</em> ƒë·ªÉ l·∫•y CSS ƒëang ch·∫°y.</li>
            <li>Ch·ªânh s·ª≠a trong √¥ b√™n tr√°i ‚Üí <em>L∆∞u style</em>.<br/>
                L·∫ßn ƒë·∫ßu l∆∞u s·∫Ω h·ªèi <code>Theme Token</code> (ƒë·∫∑t ·ªü Netlify env <code>THEME_TOKEN</code>).</li>
            <li>Nh·∫•n <em>T·∫£i .css</em> ƒë·ªÉ t·∫£i v·ªÅ file d·ª± ph√≤ng.</li>
          </ol>
          <p class="muted">Token ƒë∆∞·ª£c l∆∞u ·ªü tr√¨nh duy·ªát (localStorage) d∆∞·ªõi kho√° <code>NINI_THEME_TOKEN</code>. B·∫°n c√≥ th·ªÉ xo√° ƒë·ªÉ nh·∫≠p l·∫°i.</p>
          <hr/>
          <p><strong>M·∫πo:</strong> B·∫°n c√≥ th·ªÉ th√™m/ghi ƒë√® c√°c bi·∫øn:</p>
          <pre style="white-space:pre-wrap;font-size:12px">
:root{
  --bg-url: url('/public/assets/bg/nini_home.webp');
  --glass: rgba(255,255,255,.16);
  --brand-gradient: linear-gradient(90deg,#F5D36B,#47A768,#8a5a2b);
}
          </pre>
        </aside>
      </div>
    </section>
  </main>

  <script>
    /* =======================
       0) Guard phi√™n ƒëƒÉng nh·∫≠p admin
    ======================= */
    const ADMIN_AUTH_API = "/.netlify/functions/admin-auth";
    (async () => {
      try{
        const r = await fetch(`${ADMIN_AUTH_API}/check`, { credentials: "include" });
        const j = await r.json().catch(()=>({}));
        if (!j || !j.ok) location.href = "/admin/login.html";
      }catch(_){
        location.href = "/admin/login.html";
      }
    })();
    document.getElementById("btnLogout").onclick = async () => {
      try{ await fetch(`${ADMIN_AUTH_API}/logout`, { method:"POST", credentials:"include" }); }catch(_){}
      location.href = "/admin/login.html";
    };

    /* =======================
       1) Tabs
    ======================= */
    const tabsNav = document.getElementById("adminTabs");
    tabsNav.addEventListener("click", (e)=>{
      const b = e.target.closest(".admin-tab"); if (!b || b.tagName === "A") return;
      document.querySelectorAll(".admin-tab").forEach(x=>x.classList.toggle("is-active", x===b));
      const key = b.dataset.tab;
      document.querySelectorAll(".panel").forEach(p=>p.classList.toggle("is-current", p.id === `p-${key}`));
    });

    /* =======================
       2) B·∫£ng ƒëi·ªÉm demo
    ======================= */
    const $ = s => document.querySelector(s);
    const grid = $("#grid"), stat = $("#stat"), pick = $("#pickDate");
    const today = new Date().toISOString().slice(0,10); pick.value = today;
    $("#btnLoad").onclick = loadScores; $("#btnCsv").onclick = downloadCsv;
    let rows = []; loadScores();

    async function loadScores(){
      stat.textContent = "ƒêang t·∫£i‚Ä¶"; grid.innerHTML = ""; rows = [];
      try{
        const d = pick.value || today;
        // ƒê·ªïi endpoint n√†y sang function th·∫≠t c·ªßa b·∫°n
        const r = await fetch(`/.netlify/functions/get-scores?date=${d}`, { credentials:"include" });
        const j = await r.json();
        if (!j.ok) throw new Error(j.error || "L·ªói");
        rows = j.events || [];
        stat.textContent = `Ng√†y ${d} ‚Äî ${rows.length} l∆∞·ª£t`;
        renderRows(rows);
      }catch(e){
        stat.textContent = "Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu.";
      }
    }
    function renderRows(list){
      grid.innerHTML = list.map(e=>{
        const t = new Date(e.ts).toISOString().replace('T',' ').replace('Z','');
        return `<tr>
          <td>${t}</td>
          <td>${esc(e.userId)}</td>
          <td>${esc(e.displayName)}</td>
          <td>${esc(e.gameId)}</td>
          <td title="${esc(e.sessionId)}">${esc((e.sessionId||'').slice(0,8))}‚Ä¶</td>
          <td>${e.score}</td>
          <td>${e.maxScore}</td>
          <td>${e.durationSec ?? ""}</td>
        </tr>`;
      }).join('');
    }
    function esc(s){ return s==null ? "" : String(s).replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]));}
    function toCSV(arr){
      if(!arr.length) return "";
      const cols = ["ts","userId","displayName","gameId","sessionId","score","maxScore","durationSec"];
      const wrap = s => s==null ? "" : /[",\n]/.test(s = String(s)) ? `"${s.replace(/"/g,'""')}"` : s;
      return [cols.join(","), ...arr.map(o => cols.map(c=>wrap(o[c])).join(","))].join("\n");
    }
    function downloadCsv(){
      if (!rows.length) return alert("Ch∆∞a c√≥ d·ªØ li·ªáu.");
      const csv = toCSV(rows);
      const d = (pick.value || today).replace(/-/g,"");
      const blob = new Blob([csv], { type:"text/csv;charset=utf-8" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `nini-scores-${d}.csv`;
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
    }

    /* =======================
       3) Theme editor (GET/POST Function)
    ======================= */
    const THEME_API = "/.netlify/functions/theme";
    const THEME_TOKEN_KEY = "NINI_THEME_TOKEN";
    const ed = document.getElementById("themeEditor");
    const tStat = document.getElementById("themeStat");
    const btnThemeLoad = document.getElementById("btnThemeLoad");
    const btnThemeSave = document.getElementById("btnThemeSave");
    const btnThemeReset = document.getElementById("btnThemeReset");
    const btnThemeDownload = document.getElementById("btnThemeDownload");

    const THEME_TEMPLATE = `/* ===== NiNi ‚Äî Theme CSS (m·∫´u) ===== */
:root{
  /* ·∫¢nh n·ªÅn m·∫∑c ƒë·ªãnh cho t·∫•t c·∫£ trang */
  --bg-url: url('/public/assets/bg/nini_home.webp');

  /* K√≠nh m·ªù */
  --glass-1: rgba(255,255,255,.12);
  --glass-2: rgba(255,255,255,.16);
  --glass-brd: rgba(255,255,255,.35);

  /* M√†u vƒÉn b·∫£n */
  --ink: #1c2024;
  --muted: #6b7b8c;

  /* Gradient slogan */
  --brand-gradient: linear-gradient(90deg,#F5D36B,#47A768,#8a5a2b);
}

/* BG chung */
body{
  background: #0b1f10 var(--bg-url) center/cover fixed no-repeat;
}

/* Header + th·∫ª glass */
.site-header, .card, .modal__panel, .shelf-card, .reader__panel{
  backdrop-filter: blur(10px);
  background: var(--glass-2);
  border:1px solid var(--glass-brd);
}

/* Slogan gradient */
.brand__slogan{ background: var(--brand-gradient); -webkit-background-clip:text; background-clip:text; color:transparent; }

/* N√∫t */
.btn.solid{ background:#2f6e3f; color:#fff; border-color:#2f6e3f }
`;

    btnThemeReset.onclick = () => {
      ed.value = THEME_TEMPLATE;
      tStat.textContent = "ƒê√£ n·∫°p m·∫´u m·∫∑c ƒë·ªãnh (ch∆∞a l∆∞u).";
    };

    btnThemeLoad.onclick = async () => {
      tStat.textContent = "ƒêang t·∫£i CSS‚Ä¶";
      try{
        const r = await fetch(`${THEME_API}?t=${Date.now()}`, { method:"GET" });
        if(!r.ok){ throw new Error(r.status); }
        const css = await r.text();
        ed.value = css || THEME_TEMPLATE;
        tStat.textContent = "ƒê√£ t·∫£i style hi·ªán t·∫°i.";
      }catch(e){
        ed.value = THEME_TEMPLATE;
        tStat.textContent = "Kh√¥ng t·∫£i ƒë∆∞·ª£c style hi·ªán t·∫°i ‚Äî ƒë√£ n·∫°p m·∫´u m·∫∑c ƒë·ªãnh.";
      }
    };

    btnThemeSave.onclick = async () => {
      let token = localStorage.getItem(THEME_TOKEN_KEY);
      if (!token){
        token = prompt("Nh·∫≠p Theme Token (THEME_TOKEN trong Netlify):") || "";
        if (!token.trim()){ tStat.textContent = "Hu·ª∑ l∆∞u ‚Äî thi·∫øu token."; return; }
        localStorage.setItem(THEME_TOKEN_KEY, token);
      }
      tStat.textContent = "ƒêang l∆∞u‚Ä¶";
      try{
        const r = await fetch(THEME_API, {
          method:"POST",
          headers:{
            "Content-Type":"application/json",
            "Authorization":"Bearer " + token
          },
          body: JSON.stringify({ css: ed.value })
        });
        const ok = r.ok;
        const j = await r.json().catch(()=>({}));
        if (!ok || !j?.ok) throw new Error(j?.error || "Save failed");
        tStat.textContent = "ƒê√£ l∆∞u style!";
      }catch(e){
        tStat.textContent = "L∆∞u th·∫•t b·∫°i: " + (e?.message||"");
        // Cho ph√©p nh·∫≠p l·∫°i token khi l·ªói 401
        if (String(e).includes("401") || String(e).toLowerCase().includes("unauthorized")){
          localStorage.removeItem(THEME_TOKEN_KEY);
        }
      }
    };

    btnThemeDownload.onclick = () => {
      const blob = new Blob([ed.value||""], { type:"text/css;charset=utf-8" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `nini-theme.css`;
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
    };

    // N·∫°p m·∫´u ban ƒë·∫ßu
    ed.value = THEME_TEMPLATE;
  </script>
</body>
</html>


