<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — NiNi</title>
  <link rel="icon" href="/public/assets/icons/logonini.webp" type="image/webp" />
  <link rel="stylesheet" href="/styles.css?v=11" />

  <!-- =========================================================
       BEGIN: Admin page light-glass theming (không đụng code chung)
       ========================================================= -->
  <style>
    /* Fallback khi thiếu biến trong styles.css */
    :root{
      --ink:#0b1220;           /* chữ đậm */
      --ink-dim:#5b677a;       /* chữ mờ */
      --line:rgba(17,24,39,.14);
      --accent:#2563eb;        /* xanh nhấn */
      --glassW:rgba(255,255,255,.75);
      --glassW-strong:rgba(255,255,255,.9);
    }

    /* Header kính trắng sáng như trang chủ */
    .site-header{
      position: sticky; top: 0; z-index: 20;
      display:flex; align-items:center; gap:20px;
      padding:12px min(4vw,24px);
      background: var(--glassW);
      border-bottom: 1px solid var(--line);
      backdrop-filter: blur(10px);
      color: var(--ink);
    }
    .brand{display:flex; align-items:center; gap:10px}
    .brand__logo{height:36px}
    .brand__slogan{font-weight:700; color:var(--ink)}
    .tabs .tab{color:var(--ink)}
    .auth-btn{
      margin-left:auto;
      padding:8px 14px; border-radius:999px;
      border:1px solid var(--line);
      background:#111827; color:#fff; text-decoration:none;
    }
    .auth-btn:hover{background:#0b1220}

    /* Khung trang admin */
    .admin-wrap{width:min(1100px,92vw); margin:22px auto 80px; color:var(--ink)}
    .card-glass{
      background: var(--glassW);
      border:1px solid var(--line);
      border-radius:16px;
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 40px rgba(0,0,0,.08);
    }

    /* Tabs pill */
    .admin-tabs{display:flex; gap:10px; flex-wrap:wrap; margin:14px 0}
    .admin-tab{
      padding:9px 14px; border-radius:999px; background:var(--glassW-strong);
      color:var(--ink); border:1px solid var(--line); cursor:pointer
    }
    .admin-tab:hover{background:#fff}
    .admin-tab.is-active{
      text-decoration:underline; text-underline-offset:6px; text-decoration-thickness:2px;
      border-color:var(--accent) }

    .admin-panel{ display:none }
    .admin-panel.is-current{ display:block }

    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:12px 0}
    .toolbar input{
      padding:10px 12px;border-radius:10px;border:1px solid var(--line);
      background:#fff;color:var(--ink)
    }
    .toolbar button{
      padding:10px 12px;border-radius:10px;border:1px solid var(--line);
      background:#111827;color:#fff;cursor:pointer
    }
    .toolbar button:hover{background:#0b1220}
    .toolbar .muted{color:var(--ink-dim)}

    .note{
      margin-top:10px; padding:12px 14px; border-radius:12px;
      background:#ffffff; color:#415060; border:1px dashed var(--line);
      box-shadow: 0 0 0 4px rgba(45,191,111,.06) inset;
    }

    /* Bảng dữ liệu: kính trắng, header sticky, zebra, hover */
    .table{margin-top:10px}
    table{width:100%; border-collapse:separate; border-spacing:0; color:var(--ink)}
    thead th{
      position:sticky; top:0; z-index:1;
      background:var(--glassW-strong);
      backdrop-filter: blur(6px);
      border-bottom:1px solid var(--line);
      text-align:left; font-weight:800; font-size:13px; color:#243044;
      padding:10px 12px;
    }
    tbody td{padding:10px 12px; border-bottom:1px solid rgba(17,24,39,.08)}
    tbody tr:nth-child(odd){background: rgba(255,255,255,.65)}
    tbody tr:hover{background:#fff}

    /* Bảng cuộn khi hẹp */
    .table{overflow:auto; border-radius:12px; border:1px solid var(--line)}
    .table table{min-width:900px}

    /* Tiny tweaks */
    code{background:#fff; border:1px solid var(--line); border-radius:6px; padding:2px 6px}
  </style>
  <!-- =========================================================
       END: Admin page light-glass theming
       ========================================================= -->
</head>

<body>
  <!-- =========================================================
       BEGIN: Header admin — giữ phong cách site
       ========================================================= -->
  <header class="site-header">
    <div class="brand">
      <img class="brand__logo" src="/public/assets/icons/logo_text.webp" alt="NiNi Funny">
      <div class="brand__slogan">Chơi mê ly, bứt phá tư duy</div>
    </div>
    <nav class="tabs"><a class="tab" href="/" style="text-decoration:none;color:inherit">← Về trang chủ</a></nav>
    <a class="auth-btn" id="adminLogout" href="javascript:void(0)">Đăng xuất Admin</a>
  </header>
  <!-- =========================================================
       END: Header admin
       ========================================================= -->

  <main class="admin-wrap">
    <!-- =======================================================
         BEGIN: Tabs
         ======================================================= -->
    <nav class="admin-tabs card-glass" id="adminTabs" style="padding:12px">
      <button class="admin-tab is-active" data-tab="scores">Bảng điểm (theo ngày)</button>
      <button class="admin-tab" data-tab="queue">Hàng đợi cục bộ</button>
      <button class="admin-tab" data-tab="reports">Báo cáo ngày</button>
    </nav>
    <!-- =======================================================
         END: Tabs
         ======================================================= -->

    <!-- =======================================================
         BEGIN: Panel — Scores
         ======================================================= -->
    <section class="admin-panel is-current card-glass" id="panel-scores" style="padding:16px">
      <div class="toolbar">
        <label>Ngày: <input type="date" id="pickDate"></label>
        <button id="btnLoad">Tải dữ liệu</button>
        <button id="btnCsv">Tải CSV</button>
        <span class="muted" id="stat"></span>
      </div>

      <div class="table">
        <table id="grid">
          <thead>
            <tr>
              <th>Thời gian (UTC)</th><th>User</th><th>Tên</th><th>Game</th>
              <th>Session</th><th>Điểm</th><th>Tối đa</th><th>Thời lượng(s)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <p class="note">Đọc từ <code>/.netlify/functions/get-scores?date=YYYY-MM-DD</code>.
        Mỗi lượt chơi là một dòng trong blobs <code>scores/yyyy-mm-dd.jsonl</code>.</p>
    </section>
    <!-- =======================================================
         END: Panel — Scores
         ======================================================= -->

    <!-- =======================================================
         BEGIN: Panel — Queue
         ======================================================= -->
    <section class="admin-panel card-glass" id="panel-queue" style="padding:16px">
      <div class="toolbar">
        <button id="qCount">Đếm mục</button>
        <button id="qExportCsv">Export CSV</button>
        <button id="qExportEnc">Export gói mã hoá</button>
        <button id="qUploadEnc">Upload gói mã hoá</button>
        <button id="qClear">Xoá hết hàng đợi</button>
        <span class="muted" id="qStat"></span>
      </div>
      <p class="note">Bản sao dự phòng lưu trên <strong>trình duyệt này</strong> (localStorage).</p>
    </section>
    <!-- =======================================================
         END: Panel — Queue
         ======================================================= -->

    <!-- =======================================================
         BEGIN: Panel — Reports
         ======================================================= -->
    <section class="admin-panel card-glass" id="panel-reports" style="padding:16px">
      <div class="toolbar">
        <button id="btnRoll">Tạo báo cáo “hôm qua” (giờ VN)</button>
        <span class="muted" id="rollStat"></span>
      </div>
      <p class="note">Gọi <code>/.netlify/functions/daily-rollup</code> để tạo CSV của
        <em>ngày hôm qua</em> vào blobs <code>reports/YYYY-MM-DD.csv</code>.</p>
    </section>
    <!-- =======================================================
         END: Panel — Reports
         ======================================================= -->
  </main>

  <!-- giữ nguyên các script bạn đã dùng -->
  <script src="/public/js/queue.js" defer></script>

  <!-- =========================================================
       BEGIN: Logic (giữ nguyên ID/hàm của bạn, chỉ polish nhẹ)
       ========================================================= -->
  <script defer>
    // Tabs
    const tabs = document.getElementById('adminTabs');
    tabs.addEventListener('click', e=>{
      const b = e.target.closest('.admin-tab'); if(!b) return;
      const id = b.dataset.tab;
      document.querySelectorAll('.admin-tab').forEach(x=>x.classList.toggle('is-active', x===b));
      document.querySelectorAll('.admin-panel').forEach(p=>p.classList.toggle('is-current', p.id === `panel-${id}`));
    });

    // Logout (tùy chọn backend)
    document.getElementById('adminLogout').onclick = async ()=>{
      try{ await fetch('/.netlify/functions/admin-logout',{method:'POST'}); }catch(_){}
      location.href = '/';
    };

    // Scores
    const $ = s => document.querySelector(s);
    const pick = $('#pickDate'), btnLoad = $('#btnLoad'), btnCsv = $('#btnCsv');
    const grid = $('#grid tbody'), stat = $('#stat'); let rows = [];
    const today = new Date().toISOString().slice(0,10); pick.value = today;
    btnLoad.onclick = load; btnCsv.onclick = downloadCsv; load();

    async function load(){
      const d = pick.value || today;
      stat.textContent = 'Đang tải...'; grid.innerHTML = ''; rows = [];
      try{
        const r = await fetch(`/.netlify/functions/get-scores?date=${d}`).then(r=>r.json());
        if(!r.ok) throw new Error(r.error || 'Không lấy được dữ liệu');
        rows = r.events || [];
        stat.textContent = `Ngày ${d} — ${rows.length} lượt`;
        render(rows);
      }catch(e){ stat.textContent = 'Lỗi: ' + e.message; }
    }
    function render(list){
      grid.innerHTML = list.map(e=>{
        const t = new Date(e.ts).toISOString().replace('T',' ').replace('Z','');
        return `<tr>
          <td>${t}</td>
          <td>${esc(e.userId)}</td>
          <td>${esc(e.displayName)}</td>
          <td>${esc(e.gameId)}</td>
          <td title="${esc(e.sessionId)}">${esc((e.sessionId||'').slice(0,8))}…</td>
          <td>${e.score}</td>
          <td>${e.maxScore}</td>
          <td>${e.durationSec ?? ''}</td>
        </tr>`;
      }).join('');
    }
    function esc(v){ return v==null?'':String(v).replace(/[&<>"']/g,s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s])); }
    function toCSV(arr){
      if(!arr.length) return '';
      const cols = ["ts","userId","displayName","gameId","sessionId","score","maxScore","durationSec"];
      const escCSV = s => { if(s==null) return ''; s=String(s); return /[",\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s; };
      const head = cols.join(','); const lines = arr.map(o => cols.map(c => escCSV(o[c])).join(','));
      return [head, ...lines].join('\n');
    }
    function downloadCsv(){
      if(!rows.length){ alert('Chưa có dữ liệu để tải.'); return; }
      const csv = toCSV(rows), d = (pick.value || today).replace(/-/g,'');
      const blob = new Blob([csv], { type:'text/csv;charset=utf-8' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `nini-scores-${d}.csv`;
      document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); },0);
    }

    // Queue cục bộ
    const qStat = document.getElementById('qStat');
    document.getElementById('qCount').onclick     = ()=>{ const arr = JSON.parse(localStorage.getItem('nini_queue_v1')||'[]'); qStat.textContent = `Có ${arr.length} mục.`; };
    document.getElementById('qExportCsv').onclick = ()=> Queue.exportCSV();
    document.getElementById('qExportEnc').onclick = ()=> Queue.exportEncrypted();
    document.getElementById('qUploadEnc').onclick = ()=> Queue.uploadEncrypted();
    document.getElementById('qClear').onclick     = ()=>{ if(confirm('Xoá tất cả hàng đợi cục bộ trên trình duyệt này?')){ Queue.clear(); qStat.textContent='Đã xoá.'; } };
  </script>
  <!-- =========================================================
       END: Logic
       ========================================================= -->
</body>
</html>
