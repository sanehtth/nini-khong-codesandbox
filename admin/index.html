<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NiNi — Admin</title>
  <link rel="icon" href="/public/assets/icons/logo_nini.webp" type="image/webp" />
  <link rel="stylesheet" href="/styles.css?v=admin3" />
  <style>
    :root{
      --bg-admin: url("/public/assets/bg/nini_home.webp");    /* ✅ nền */
      --glass-bg: rgba(255,255,255,.15);
      --glass-brd: rgba(255,255,255,.35);
      --glass-shadow: 0 10px 30px rgba(47,110,63,.25);
      --ink: #1c2024; --muted:#6b7b8c; --green:#2f6e3f; --green-2:#21512d; --radius: 18px;
    }
    /* ===== Background (cover, fixed) ===== */
    html,body{height:100%}
    body{
      margin:0;
      background: #e9f3ee var(--bg-admin) center/cover fixed no-repeat;
    }

    /* ===== Header giống trang index ===== */
    .site-header{
      position:sticky; top:0; z-index:50;
      display:flex; align-items:center; gap:16px;
      padding:10px 14px; margin:12px auto; width:min(1180px,94vw);
      backdrop-filter: blur(10px);
      background: var(--glass-bg);
      border:1px solid var(--glass-brd);
      border-radius: 14px;
      box-shadow: var(--glass-shadow);
    }
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none}
    .brand__logo{height:34px}
    .brand__slogan{
      font-weight:700; letter-spacing:.2px; user-select:none;
      background: linear-gradient(90deg,#F5D36B,#47A768,#8a5a2b);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      animation: hue 10s linear infinite;
    }
    @keyframes hue{0%{filter:hue-rotate(0)}100%{filter:hue-rotate(360deg)}}
    .spacer{flex:1}

    .btn,.admin-tab{
      appearance:none; border:1px solid var(--glass-brd);
      background: var(--glass-bg);
      color: var(--ink);
      border-radius: 999px; padding:8px 14px; cursor:pointer;
      box-shadow: 0 4px 10px rgba(47,110,63,.18);
      transition: transform .05s ease, box-shadow .2s ease, border-color .2s ease;
      backdrop-filter: blur(8px);
      text-decoration:none;
    }
    .btn:hover,.admin-tab:hover{ transform: translateY(-1px); box-shadow: 0 8px 18px rgba(47,110,63,.28); border-color:#fff }
    .btn:active,.admin-tab:active{ transform: translateY(0) }
    .admin-tabs{ display:flex; gap:10px; flex-wrap:wrap; }
    .admin-tab.is-active{
      box-shadow: 0 0 0 2px rgba(47,110,63,.25), 0 10px 26px rgba(47,110,63,.35);
      border-color:#fff;
    }

    .shell{width:min(1180px,94vw); margin:18px auto 90px}
    .glass-card{
      background: var(--glass-bg);
      border:1px solid var(--glass-brd);
      border-radius: var(--radius);
      box-shadow: var(--glass-shadow);
      backdrop-filter: blur(10px);
    }

    .panel{ display:none; margin-top:14px; }
    .panel.is-current{ display:block; }
    .panel .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; padding:12px 14px; }

    .input{
      background: transparent; border:0; outline:none;
      border-bottom:2px solid rgba(255,255,255,.55);
      padding:6px 4px; color:var(--ink);
      min-width: 220px;
    }
    .input:focus{ border-bottom-color:#9fc5b0; box-shadow: 0 4px 0 -2px rgba(47,110,63,.25) inset; }

    .table-wrap{ overflow:auto; border-radius: 0 0 var(--radius) var(--radius); }
    table{ width:100%; border-collapse: collapse; color:var(--ink); }
    thead tr{ background: rgba(255,255,255,.25); }
    th,td{ padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.25); text-align:left; }
    tbody tr:hover{ background: rgba(255,255,255,.08); }
    .muted{ color:var(--muted); font-size:13px }
    .btn.small{ padding:6px 10px; }
    .glass-head{ padding:12px 14px; border-bottom:1px solid var(--glass-brd); }
  </style>
</head>
<body>
  <header class="site-header">
    <a class="brand" href="/#home" aria-label="NiNi — Funny">
      <img class="brand__logo" src="/public/assets/icons/logo_text.webp" alt="NiNi Funny" />
      <div class="brand__slogan"><span>Chơi</span> <span>mê lý</span>, <span>bứt phá</span> <span>tư duy</span></div>
    </a>
    <div class="spacer"></div>
    <a class="btn" href="/" rel="noopener">↘ Về trang chủ</a>
    <button id="btnLogout" class="btn">Đăng xuất</button>
  </header>

  <main class="shell">
    <nav class="admin-tabs" id="adminTabs" aria-label="Admin sections">
      <button class="admin-tab is-active" data-tab="scores">Bảng điểm (theo ngày)</button>
      <button class="admin-tab" data-tab="queue">Hàng đợi cục bộ</button>
      <button class="admin-tab" data-tab="reports">Báo cáo ngày</button>
      <a class="admin-tab" href="/admin/storybook.html">Tạo Storybook</a>
      <a class="admin-tab" href="/admin/avatar.html">Tạo Avatar JSON</a>
    </nav>

    <section id="p-scores" class="panel is-current glass-card" aria-labelledby="tab-scores">
      <div class="glass-head"><div class="muted">Chọn ngày ➜ tải dữ liệu (đọc từ Function của bạn).</div></div>
      <div class="toolbar">
        <input id="pickDate" type="date" class="input" />
        <button id="btnLoad" class="btn small">Tải dữ liệu</button>
        <button id="btnCsv"  class="btn small">Tải CSV</button>
        <span id="stat" class="muted"></span>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>Thời gian (UTC)</th><th>User</th><th>Tên</th><th>Game</th><th>Session</th><th>Điểm</th><th>Tối đa</th><th>Giây</th></tr>
          </thead>
          <tbody id="grid"></tbody>
        </table>
      </div>
    </section>

    <section id="p-queue" class="panel glass-card">
      <div class="glass-head"><strong>Hàng đợi cục bộ</strong></div>
      <div class="toolbar"><span class="muted">Khu vực này bạn có thể gắn lại <code>queue.js</code> của bạn.</span></div>
    </section>

    <section id="p-reports" class="panel glass-card">
      <div class="glass-head"><strong>Báo cáo ngày</strong></div>
      <div class="toolbar"><span class="muted">Gọi Function <code>daily-rollup</code> của bạn nếu đã triển khai.</span></div>
    </section>
  </main>

  <script>
    const API = "/.netlify/functions/admin-auth";
    (async () => {
      try{
        const r = await fetch(`${API}/check`, { credentials: "include" });
        const j = await r.json().catch(()=>({})); if (!j || !j.ok) location.href = "/admin/login.html";
      }catch{ location.href = "/admin/login.html"; }
    })();
    document.getElementById("btnLogout").onclick = async () => {
      try{ await fetch(`${API}/logout`, { method:"POST", credentials:"include" }); }catch{}
      location.href = "/admin/login.html";
    };
    const tabs = document.getElementById("adminTabs");
    tabs.addEventListener("click", (e)=>{
      const b = e.target.closest(".admin-tab"); if (!b || b.tagName === "A") return;
      document.querySelectorAll(".admin-tab").forEach(x=>x.classList.toggle("is-active", x===b));
      const key = b.dataset.tab;
      document.querySelectorAll(".panel").forEach(p=>p.classList.toggle("is-current", p.id === `p-${key}`));
    });

    const $ = s => document.querySelector(s);
    const grid = $("#grid"), stat = $("#stat"), pick = $("#pickDate");
    const today = new Date().toISOString().slice(0,10); pick.value = today;
    $("#btnLoad").onclick = load; $("#btnCsv").onclick = downloadCsv;
    let rows = []; load();

    async function load(){
      stat.textContent = "Đang tải…"; grid.innerHTML = ""; rows = [];
      try{
        const d = pick.value || today;
        const r = await fetch(`/.netlify/functions/get-scores?date=${d}`, { credentials:"include" });
        const j = await r.json();
        if (!j.ok) throw new Error(j.error || "Lỗi");
        rows = j.events || [];
        stat.textContent = `Ngày ${d} — ${rows.length} lượt`;
        render(rows);
      }catch{ stat.textContent = "Không tải được dữ liệu."; }
    }
    function render(list){
      grid.innerHTML = list.map(e=>{
        const t = new Date(e.ts).toISOString().replace('T',' ').replace('Z','');
        return `<tr>
          <td>${t}</td><td>${esc(e.userId)}</td><td>${esc(e.displayName)}</td>
          <td>${esc(e.gameId)}</td>
          <td title="${esc(e.sessionId)}">${esc((e.sessionId||'').slice(0,8))}…</td>
          <td>${e.score}</td><td>${e.maxScore}</td><td>${e.durationSec ?? ""}</td>
        </tr>`;
      }).join('');
    }
    function esc(s){ return s==null ? "" : String(s).replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]));}
    function toCSV(arr){
      if(!arr.length) return "";
      const cols = ["ts","userId","displayName","gameId","sessionId","score","maxScore","durationSec"];
      const wrap = s => s==null ? "" : /[",\n]/.test(s = String(s)) ? `"${s.replace(/"/g,'""')}"` : s;
      return [cols.join(","), ...arr.map(o => cols.map(c=>wrap(o[c])).join(","))].join("\n");
    }
    function downloadCsv(){
      if (!rows.length) return alert("Chưa có dữ liệu.");
      const csv = toCSV(rows);
      const d = (pick.value || today).replace(/-/g,"");
      const blob = new Blob([csv], { type:"text/csv;charset=utf-8" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `nini-scores-${d}.csv`;
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
    }
  </script>
</body>
</html>
