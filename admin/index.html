<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NiNi — Admin</title>
  <link rel="icon" href="/public/assets/icons/logonini.webp" type="image/webp" />
  <link rel="stylesheet" href="/styles.css?v=admin2" />
  <style>
    .shell{width:min(1100px,92vw); margin:20px auto 80px}
    .topbar{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .spacer{flex:1}
    .btn{padding:8px 12px; border-radius:999px; border:1px solid rgba(0,0,0,.15); background:#fff; cursor:pointer}
    .btn:hover{border-color:#000}
    .tabs{display:flex; gap:8px; flex-wrap:wrap; margin-top:12px}
    .tab{padding:9px 14px; border-radius:999px; border:1px solid rgba(0,0,0,.16); background:#fff; cursor:pointer}
    .tab.is-active{ text-decoration:underline; text-underline-offset:6px; text-decoration-thickness:2px }
    .panel{display:none; margin-top:12px}
    .panel.is-current{display:block}
    table{width:100%; border-collapse:collapse; background:#fff; border:1px solid rgba(0,0,0,.12)}
    th, td{padding:10px 12px; border-bottom:1px solid rgba(0,0,0,.08); text-align:left}
    th{background:#f7fafc}
    .muted{color:#6b7b8c; font-size:13px}
  </style>
</head>
<body>
  <header class="shell">
    <div class="topbar">
      <h2 style="margin:0">NiNi — Admin</h2>
      <div class="spacer"></div>
      <a class="btn" href="/">↘ Về trang chủ</a>
      <button id="btnLogout" class="btn">Đăng xuất</button>
    </div>

    <!-- Trong cụm thanh tab admin hiện có -->
<nav class="admin-tabs" id="adminTabs">
  <button class="admin-tab is-active" data-tab="scores">Bảng điểm (theo ngày)</button>
  <button class="admin-tab" data-tab="queue">Hàng đợi cục bộ</button>
  <button class="admin-tab" data-tab="reports">Báo cáo ngày</button>
  <!-- BEGIN add: tab Storybook -->
  <a class="admin-tab" href="/admin/storybook.html" style="text-decoration:none">Tạo Storybook</a>
  <!-- END add: tab Storybook -->
</nav>

  </header>

  <main class="shell">
    <!-- Panel: Bảng điểm (ví dụ giữ nguyên bố cục của bạn) -->
    <section id="p-scores" class="panel is-current">
      <div class="muted" style="margin-bottom:8px">Chọn ngày ➜ tải dữ liệu (đọc từ Function riêng của bạn, nếu có).</div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px">
        <input id="pickDate" type="date" />
        <button id="btnLoad" class="btn">Tải dữ liệu</button>
        <button id="btnCsv"  class="btn">Tải CSV</button>
        <span id="stat" class="muted"></span>
      </div>
      <table>
        <thead>
          <tr>
            <th>Thời gian (UTC)</th><th>User</th><th>Tên</th><th>Game</th><th>Session</th><th>Điểm</th><th>Tối đa</th><th>Giây</th>
          </tr>
        </thead>
        <tbody id="grid"></tbody>
      </table>
    </section>

    <section id="p-queue" class="panel">
      <p class="muted">Khu vực này bạn có thể gắn lại queue.js của bạn.</p>
    </section>

    <section id="p-reports" class="panel">
      <p class="muted">Gọi Function daily-rollup của bạn nếu đã triển khai.</p>
    </section>
  </main>

  <script>
    const API = "/.netlify/functions/admin-auth";

    // ===== 1) Bắt buộc: kiểm tra phiên khi vào trang =====
    (async () => {
      try{
        const r = await fetch(`${API}/check`, { credentials: "include" });
        const j = await r.json().catch(_=>({}));
        if (!j || !j.ok) location.href = "/admin/login.html";
      }catch(_){
        location.href = "/admin/login.html";
      }
    })();

    // ===== 2) Logout =====
    document.getElementById("btnLogout").onclick = async () => {
      try{ await fetch(`${API}/logout`, { method:"POST", credentials:"include" }); }catch(_){}
      location.href = "/admin/login.html";
    };

    // ===== 3) Tabs mini =====
    const tabs = document.getElementById("tabs");
    tabs.addEventListener("click", e=>{
      const b = e.target.closest(".tab"); if (!b) return;
      document.querySelectorAll(".tab").forEach(x=>x.classList.toggle("is-active", x===b));
      const key = b.dataset.t;
      document.querySelectorAll(".panel").forEach(p=>p.classList.toggle("is-current", p.id === `p-${key}`));
    });

    // ===== 4) (Tuỳ bạn) Load bảng điểm — ví dụ đọc /functions/get-scores?date=YYYY-MM-DD =====
    const $ = s => document.querySelector(s);
    const grid = $("#grid"), stat = $("#stat"), pick = $("#pickDate");
    const today = new Date().toISOString().slice(0,10); pick.value = today;

    $("#btnLoad").onclick = load; $("#btnCsv").onclick = downloadCsv;
    let rows = []; load();

    async function load(){
      stat.textContent = "Đang tải…"; grid.innerHTML = ""; rows = [];
      try{
        // NOTE: đổi URL này sang function thật của bạn
        const d = pick.value || today;
        const r = await fetch(`/.netlify/functions/get-scores?date=${d}`, { credentials:"include" });
        const j = await r.json();
        if (!j.ok) throw new Error(j.error || "Lỗi");
        rows = j.events || [];
        stat.textContent = `Ngày ${d} — ${rows.length} lượt`;
        render(rows);
      }catch(e){
        stat.textContent = "Không tải được dữ liệu.";
      }
    }
    function render(list){
      grid.innerHTML = list.map(e=>{
        const t = new Date(e.ts).toISOString().replace('T',' ').replace('Z','');
        return `<tr>
          <td>${t}</td>
          <td>${esc(e.userId)}</td>
          <td>${esc(e.displayName)}</td>
          <td>${esc(e.gameId)}</td>
          <td title="${esc(e.sessionId)}">${esc((e.sessionId||'').slice(0,8))}…</td>
          <td>${e.score}</td>
          <td>${e.maxScore}</td>
          <td>${e.durationSec ?? ""}</td>
        </tr>`;
      }).join('');
    }
    function esc(s){ return s==null ? "" : String(s).replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]));}
    function toCSV(arr){
      if(!arr.length) return "";
      const cols = ["ts","userId","displayName","gameId","sessionId","score","maxScore","durationSec"];
      const wrap = s => s==null ? "" : /[",\n]/.test(s = String(s)) ? `"${s.replace(/"/g,'""')}"` : s;
      return [cols.join(","), ...arr.map(o => cols.map(c=>wrap(o[c])).join(","))].join("\n");
    }
    function downloadCsv(){
      if (!rows.length) return alert("Chưa có dữ liệu.");
      const csv = toCSV(rows);
      const d = (pick.value || today).replace(/-/g,"");
      const blob = new Blob([csv], { type:"text/csv;charset=utf-8" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `nini-scores-${d}.csv`;
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
    }
  </script>
</body>
</html>
<!-- --------------- HẾT FILE index.html --------------- -->

