<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NiNi — Admin Login</title>
  <link rel="icon" href="/public/assets/icons/logonini.webp" type="image/webp" />
  <link rel="stylesheet" href="/styles.css?v=11" />
  <style>
    .center-wrap{min-height:100vh;display:grid;place-items:center}
    .card{width:min(640px,92vw);border-radius:16px;background:rgba(255,255,255,.88);backdrop-filter:blur(8px);padding:18px 18px 14px;box-shadow:0 18px 60px rgba(0,0,0,.18)}
    .row{display:flex;gap:10px;align-items:center;margin-top:12px}
    input[type="password"]{width:100%;padding:10px 12px;border:1px solid var(--line, #cfd6df);border-radius:10px;outline:none}
    button{padding:9px 14px;border-radius:10px;border:1px solid var(--line, #cfd6df);background:#fff;cursor:pointer}
    button:hover{background:#f7fafc}
    .muted{color:#6b7a8c;font-size:14px}
    .err{color:#c53030;margin-top:8px}
  </style>
</head>
<body>
  <main class="center-wrap">
    <section class="card">
      <h2 style="margin:0 0 6px">NiNi — Admin</h2>
      <p class="muted" style="margin:0 0 10px">Nhập mật khẩu admin để vào bảng điều khiển.</p>
      <div class="row">
        <input id="iPass" type="password" placeholder="Mật khẩu admin" autocomplete="current-password" />
      </div>
      <div class="row">
        <button id="btnLogin">Đăng nhập</button>
        <a href="/" class="muted" style="margin-left:auto;text-decoration:none">↘ Về trang chủ</a>
      </div>
      <div id="msg" class="err" hidden>Sai mật khẩu. Vui lòng thử lại.</div>
    </section>
  </main>

  <script>
    // ========== START PATCH: Login + lưu token ==========
    const $ = s => document.querySelector(s);
    const msg = $('#msg');

    async function apiLogin(pass){
      const r = await fetch('/.netlify/functions/admin-auth/login', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ pass })
      });
      if (!r.ok) throw new Error('login-failed');
      return r.json();
    }

    $('#btnLogin').addEventListener('click', async () => {
      msg.hidden = true;
      const pass = $('#iPass').value.trim();
      if (!pass) { msg.textContent = 'Vui lòng nhập mật khẩu.'; msg.hidden = false; return; }
      try {
        const res = await apiLogin(pass);
        if (!res.ok || !res.token) throw new Error('bad-response');

        // Lưu token -> localStorage (không dựa vào cookie)
        localStorage.setItem('nini_admin_token', res.token);
        // chuyển qua dashboard
        location.href = '/admin/index.html';
      } catch (e) {
        msg.textContent = 'Sai mật khẩu. Vui lòng thử lại.';
        msg.hidden = false;
      }
    });

    // Nếu đã có token hợp lệ -> tự qua index (tránh vòng lặp login)
    (async () => {
      const tok = localStorage.getItem('nini_admin_token');
      if (!tok) return;
      try{
        const r = await fetch('/.netlify/functions/admin-auth/ping', {
          headers: { authorization: 'Bearer ' + tok }
        });
        if (r.ok) location.replace('/admin/index.html');
      }catch(_){}
    })();
    // ========== END PATCH ==========
  </script>
</body>
</html>
