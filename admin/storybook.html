<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NiNi — Storybook Editor</title>
  <link rel="icon" href="/public/assets/icons/logonini.svg" type="image/svg+xml" />
  <link rel="stylesheet" href="/test/css/nini-theme.css" />
  <style>
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .page-card{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.3);border-radius:12px;margin:10px 0}
    .page-head{display:flex;justify-content:space-between;align-items:center;padding:8px 10px}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace;background:rgba(0,0,0,.12);padding:8px;border-radius:8px;overflow:auto}
  </style>
</head>
<body style="--bg-url:url('/public/assets/bg/nini_home.webp')">
  <header class="site-header">
    <a class="brand" href="/#home" aria-label="NiNi — Funny">
      <img class="brand__logo" src="/public/assets/icons/logo_text.webp" alt="NiNi Funny" />
      <div class="brand__slogan">Chơi mê ly, bứt phá tư duy</div>
    </a>
    <div class="spacer"></div>
    <a class="btn" href="/admin/index.html">↩ Admin</a>
  </header>

  <main class="page-hero">
    <section class="panel">
      <h2>Storybook</h2>

      <div class="grid-2">
        <label>IDBook <input id="IDBook" class="input underline" placeholder="B001"></label>
        <label>Link ảnh bìa (L_imageBia) <input id="L_imageBia" class="input underline" placeholder="/public/.../cover.webp"></label>
        <label>Tên sách (VI) <input id="little_vi" class="input underline" placeholder="NiNi và…"></label>
        <label>Book title (EN) <input id="little_en" class="input underline" placeholder="NiNi and…"></label>
        <label>Tác giả <input id="auther" class="input underline" placeholder="Author"></label>
        <label>Thiết kế <input id="design" class="input underline" placeholder="Designer"></label>
      </div>

      <div class="row">
        <button id="btnSave" class="btn">Lưu nháp</button>
        <button id="btnAdd" class="btn">+ Thêm Page</button>
        <button id="btnDel" class="btn danger">Xoá Page cuối</button>
        <button id="btnExport" class="btn">Export JSON</button>
        <button id="btnImport" class="btn">Import JSON</button>
        <input id="fileImport" type="file" accept="application/json" hidden>
        <button id="btnDLBook" class="btn">Tải book.json</button>
        <button id="btnDLManifest" class="btn">Tải manifest.json</button>
        <button id="btnDLBoth" class="btn">Tải cả hai</button>
      </div>

      <details>
        <summary class="muted">Snippet manifest (copy vào library-manifest.json)</summary>
        <pre id="manifestSnippet" class="mono"></pre>
      </details>

      <h3>Pages</h3>
      <div id="pagesWrap"></div>

      <p class="note">
        Đặt file book tại <code>/public/content/storybook/&lt;IDBook&gt;.json</code><br>
        Manifest tại <code>/public/content/storybook/library-manifest.json</code>.
      </p>
    </section>
  </main>

  <script>
    const $ = s => document.querySelector(s);
    let book = { IDBook:"", little_vi:"", little_en:"", auther:"", design:"", L_imageBia:"", pages:[] };
    let autosaveTimer = null;

    function emptyPage(){ return { TDBook:"", IDPage:"", noidung_vi:"", noidung_en:"", L_image_P:"", L_sound_vi:"", L_sound_en:"" }; }
    function autosave(){ clearTimeout(autosaveTimer); autosaveTimer=setTimeout(()=>localStorage.setItem('storybook_draft_full', JSON.stringify(book)), 350); }
    function renderManifestSnippet(){
      const entry = { id: book.IDBook||"unknown", title_vi: book.little_vi||"", title_en: book.little_en||"", cover: book.L_imageBia||"", author: book.auther||"", design: book.design||"" };
      $("#manifestSnippet").textContent = JSON.stringify({ books:[entry] }, null, 2);
    }
    ["IDBook","little_vi","little_en","auther","design","L_imageBia"].forEach(id=>{
      $("#"+id).addEventListener("input", e=>{ book[id]=e.target.value; renderManifestSnippet(); autosave(); });
    });

    function renderPages(){
      const wrap = $("#pagesWrap"); wrap.innerHTML = "";
      if (!Array.isArray(book.pages) || !book.pages.length) book.pages=[emptyPage()];
      book.pages.forEach((p,idx)=>{
        const card = document.createElement("div");
        card.className="page-card";
        card.innerHTML = `
          <div class="page-head">
            <strong>Page #${idx+1}</strong>
            <div>
              <button class="btn small" data-act="up">↑</button>
              <button class="btn small" data-act="down">↓</button>
              <button class="btn small danger" data-act="rm">X</button>
            </div>
          </div>
          <div class="grid-2" style="padding:10px 12px">
            <label>TDBook <input data-f="TDBook" class="input underline" placeholder="Tiêu đề trang"></label>
            <label>IDPage <input data-f="IDPage" class="input underline" placeholder="P001"></label>
            <label>noidung_vi <textarea data-f="noidung_vi" rows="3" class="input underline" placeholder="Nội dung VI"></textarea></label>
            <label>noidung_en <textarea data-f="noidung_en" rows="3" class="input underline" placeholder="English"></textarea></label>
            <label>L_image_P <input data-f="L_image_P" class="input underline" placeholder="/public/.../page.webp"></label>
            <label>L_sound_vi <input data-f="L_sound_vi" class="input underline" placeholder="/public/.../vi.mp3"></label>
            <label>L_sound_en <input data-f="L_sound_en" class="input underline" placeholder="/public/.../en.mp3"></label>
          </div>`;
        wrap.appendChild(card);

        card.querySelectorAll("[data-f]").forEach(inp=>{
          const k = inp.dataset.f; inp.value = p[k] || "";
          inp.addEventListener("input", e=>{ book.pages[idx][k]=e.target.value; autosave(); });
        });

        const up=card.querySelector('[data-act="up"]'), dn=card.querySelector('[data-act="down"]'), rm=card.querySelector('[data-act="rm"]');
        up.onclick = ()=>{ if (idx===0) return; [book.pages[idx-1],book.pages[idx]]=[book.pages[idx],book.pages[idx-1]]; renderPages(); autosave(); };
        dn.onclick = ()=>{ if (idx===book.pages.length-1) return; [book.pages[idx+1],book.pages[idx]]=[book.pages[idx],book.pages[idx+1]]; renderPages(); autosave(); };
        rm.onclick = ()=>{ if(!confirm(`Xoá Page #${idx+1}?`)) return; book.pages.splice(idx,1); renderPages(); autosave(); };
      });
    }

    // Buttons
    $("#btnAdd").onclick = ()=>{ book.pages.push(emptyPage()); renderPages(); autosave(); };
    $("#btnDel").onclick = ()=>{ if(!book.pages.length) return; if(!confirm("Xoá trang cuối?")) return; book.pages.pop(); renderPages(); autosave(); };
    $("#btnSave").onclick = ()=>{ localStorage.setItem('storybook_draft_full', JSON.stringify(book)); alert("Đã lưu nháp."); };

    $("#btnExport").onclick = ()=>{ download((book.IDBook||"book")+".json", JSON.stringify(book,null,2)); };
    $("#btnImport").onclick = ()=> $("#fileImport").click();
    $("#fileImport").addEventListener("change", async (e)=>{
      const f=e.target.files[0]; if(!f) return;
      try{
        const data = JSON.parse(await f.text());
        book = {
          IDBook: data.IDBook||"", little_vi:data.little_vi||"", little_en:data.little_en||"",
          auther:data.auther||"", design:data.design||"", L_imageBia:data.L_imageBia||"",
          pages: Array.isArray(data.pages)? data.pages.map(p=>({
            TDBook:p.TDBook||"", IDPage:p.IDPage||"", noidung_vi:p.noidung_vi||"", noidung_en:p.noidung_en||"",
            L_image_P:p.L_image_P||"", L_sound_vi:p.L_sound_vi||"", L_sound_en:p.L_sound_en||""
          })) : []
        };
        ["IDBook","little_vi","little_en","auther","design","L_imageBia"].forEach(id=>$("#"+id).value=book[id]||"");
        renderPages(); renderManifestSnippet(); autosave();
      }catch(err){ alert("Import lỗi: "+err.message); }
      e.target.value="";
    });

    $("#btnDLBook").onclick = ()=>{ if(!book.IDBook) return alert("Nhập IDBook!"); download(`${book.IDBook}.json`, JSON.stringify(book,null,2)); };
    $("#btnDLManifest").onclick = ()=>{
      const entry = { id: book.IDBook||"unknown", title_vi: book.little_vi||"", title_en: book.little_en||"", cover: book.L_imageBia||"", author: book.auther||"", design: book.design||"" };
      download("library-manifest.json", JSON.stringify({books:[entry]}, null, 2));
    };
    $("#btnDLBoth").onclick = ()=>{ if(!book.IDBook) return alert("Nhập IDBook!"); $("#btnDLBook").click(); setTimeout(()=>$("#btnDLManifest").click(), 100); };

    function download(name, dataStr){
      const blob = new Blob([dataStr], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob); a.download = name; a.click();
      URL.revokeObjectURL(a.href);
    }

    // BOOT
    (function init(){
      try{
        const saved = JSON.parse(localStorage.getItem('storybook_draft_full')||"null");
        if (saved) { book = {...book, ...saved}; if (Array.isArray(saved.pages)) book.pages = saved.pages; }
      }catch{}
      ["IDBook","little_vi","little_en","auther","design","L_imageBia"].forEach(id=>$("#"+id).value=book[id]||"");
      renderPages(); renderManifestSnippet();
    })();
  </script>
</body>
</html>

