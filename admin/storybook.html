<!doctype html>
<html lang="vi">
  <script>
(function(){
  const ENDPOINT='/.netlify/functions/theme';
  const KEY='NINI_THEME_CACHE_V1';
  const MAX_AGE=3600; // 1h

  function inject(css){
    try{
      let s=document.getElementById('themeOverride');
      if(!s){ s=document.createElement('style'); s.id='themeOverride'; document.head.appendChild(s); }
      s.textContent=css;
    }catch(_){}
  }

  try{
    const cache=JSON.parse(localStorage.getItem(KEY)||'null');
    const now=Date.now()/1000|0;
    if(cache && (now-cache.ts)<MAX_AGE){ inject(cache.css); }
    fetch(ENDPOINT, {cache:'no-store'})
      .then(r=>r.text())
      .then(css=>{
        if(css){ inject(css); localStorage.setItem(KEY, JSON.stringify({ts: now, css})); }
      }).catch(_=>{});
  }catch(_){}
})();
</script>

</head>
<body data-page="auth" style="--bg-url:url('/public/assets/bg/nini_home.webp')">
  <header class="site-header">
    <a class="brand" href="/#home" aria-label="NiNi — Funny">
      <img class="brand__logo" src="/public/assets/icons/logo_text.webp" alt="NiNi Funny">
      <div class="brand__slogan">Chơi mê ly, bứt phá tư duy</div>
    </a>
  </header>
<main class="page-hero bg-cover">
    <section class="panel-glass">
  <body>
  <div class="wrap">
    <!-- ===================================================================
         BOOK META
         =================================================================== -->
    <section class="panel">
      <h2>Book</h2>
      <div class="grid grid-2" id="bookForm">
        <label>IDBook <input id="IDBook" type="text" placeholder="VD: B002"></label>
        <label>L_imageBia (Link ảnh bìa) <input id="L_imageBia" type="text" placeholder="https://.../cover.webp"></label>
        <label>little_vi (Tên sách VI) <input id="little_vi" type="text" placeholder="NiNi và ..."></label>
        <label>little_en (Book title EN) <input id="little_en" type="text" placeholder="NiNi and ..."></label>
        <label>auther <input id="auther" type="text" placeholder="Tác giả"></label>
        <label>design <input id="design" type="text" placeholder="Thiết kế"></label>
      </div>
      <div class="muted" style="margin-top:6px">Tự lưu nháp vào trình duyệt (localStorage).</div>
    </section>

    <!-- ===================================================================
         ACTIONS (Tải JSON / Import / Export)
         =================================================================== -->
    <section class="panel">
      <h2>Actions</h2>
      <div class="row">
        <button id="btnSave" class="btn">Lưu (nháp)</button>
        <button id="btnAdd" class="btn">Add Page</button>
        <button id="btnDel" class="btn danger">Delete Page (cuối)</button>

        <button id="btnExport" class="btn gray">Export JSON</button>
        <button id="btnImport" class="btn gray">Import JSON</button>
        <input id="fileImport" type="file" accept="application/json" hidden>

        <span class="muted">|</span>

        <button id="btnDLBook" class="btn">Tải book.json</button>
        <button id="btnDLManifest" class="btn">Tải manifest.json</button>
        <button id="btnDLBoth" class="btn gray">Tải cả hai</button>
        <button id="btnGitLoad" class="btn gray">Tải từ GitHub</button>
        <button id="btnGitSave" class="btn">Lưu lên GitHub</button>

      </div>

      <details style="margin-top:10px">
        <summary class="muted">Xem nhanh snippet manifest (copy dán vào file manifest sẵn có)</summary>
        <pre id="manifestSnippet" class="mono"></pre>
      </details>
    </section>

    <!-- ===================================================================
         PAGES
         =================================================================== -->
    <section class="panel">
      <h2>Pages</h2>
      <div id="pagesWrap"></div>
    </section>

    <section class="panel">
      <h2>Gợi ý đặt file</h2>
      <div class="note">
        - Đặt <span class="kbd">/public/content/storybook/<b>IDBook</b>.json</span><br>
        - Manifest tại <span class="kbd">/public/content/storybook/library-manifest.json</span><br>
        - Với site đang chạy, chỉ cần upload 2 file này là kệ sách nhận ra ngay.
      </div>
    </section>
  </div>
</section>
</main>
  <script>
  /* =======================================================================
     STATE + HELPERS
     ======================================================================= */
  const $ = sel => document.querySelector(sel);
  const $$ = sel => document.querySelectorAll(sel);

  let book = {
    IDBook:"", little_vi:"", little_en:"",
    auther:"", design:"", L_imageBia:"",
    pages:[]
  };

  function emptyPage(){
    return { TDBook:"", IDPage:"", noidung_vi:"", noidung_en:"", L_image_P:"", L_sound_vi:"", L_sound_en:"" };
  }

  function download(name, dataStr){
    const blob = new Blob([dataStr], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  let autosaveTimer;
  function autosave(){
    clearTimeout(autosaveTimer);
    autosaveTimer = setTimeout(()=>localStorage.setItem('storybook_draft_full', JSON.stringify(book)), 350);
  }

  /* =======================================================================
     BIND BOOK INPUTS
     ======================================================================= */
  ["IDBook","little_vi","little_en","auther","design","L_imageBia"].forEach(id=>{
    const el = $("#"+id);
    el.addEventListener('input', e => { book[id] = e.target.value; renderManifestSnippet(); autosave(); });
  });

  /* =======================================================================
     RENDER PAGES
     ======================================================================= */
  function renderPages(){
    const wrap = $("#pagesWrap");
    wrap.innerHTML = "";

    if(!Array.isArray(book.pages) || !book.pages.length) book.pages = [emptyPage()];

    book.pages.forEach((p,idx)=>{
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="pagehead">
          <strong>Page #${idx+1}</strong>
          <div class="flex-end">
            <button class="btn sm" data-act="up">↑</button>
            <button class="btn sm" data-act="down">↓</button>
            <button class="btn sm danger" data-act="rm">Xoá</button>
          </div>
        </div>
        <div class="grid grid-2">
          <label>TDBook <input data-f="TDBook" type="text" placeholder="Tiêu đề trang"></label>
          <label>IDPage <input data-f="IDPage" type="text" placeholder="P001"></label>
          <label>noidung_vi <textarea data-f="noidung_vi" rows="3" placeholder="Nội dung VI"></textarea></label>
          <label>noidung_en <textarea data-f="noidung_en" rows="3" placeholder="English"></textarea></label>
          <label>L_image_P <input data-f="L_image_P" type="text" placeholder="https://.../page.webp"></label>
          <label>L_sound_vi <input data-f="L_sound_vi" type="text" placeholder="https://.../vi.mp3"></label>
          <label>L_sound_en <input data-f="L_sound_en" type="text" placeholder="https://.../en.mp3"></label>
        </div>
      `;
      wrap.appendChild(card);

      // fill & bind
      card.querySelectorAll('[data-f]').forEach(inp=>{
        const k = inp.dataset.f;
        inp.value = p[k] || "";
        inp.addEventListener('input', e=>{ book.pages[idx][k] = e.target.value; autosave(); });
      });

      // move / remove
      const up = card.querySelector('[data-act="up"]');
      const dn = card.querySelector('[data-act="down"]');
      const rm = card.querySelector('[data-act="rm"]');
      up.disabled = idx===0; dn.disabled = idx===book.pages.length-1;

      up.onclick = ()=>{ if(idx===0) return; [book.pages[idx-1],book.pages[idx]]=[book.pages[idx],book.pages[idx-1]]; renderPages(); autosave(); };
      dn.onclick = ()=>{ if(idx===book.pages.length-1) return; [book.pages[idx],book.pages[idx+1]]=[book.pages[idx+1],book.pages[idx]]; renderPages(); autosave(); };
      rm.onclick = ()=>{ if(!confirm(`Xoá Page #${idx+1}?`)) return; book.pages.splice(idx,1); renderPages(); autosave(); };
    });
  }

  /* =======================================================================
     MANIFEST HELPERS
     ======================================================================= */
  function buildManifestEntry(){
    // Một mục "books" trong manifest
    return {
      id: book.IDBook || "unknown",
      title_vi: book.little_vi || "",
      title_en: book.little_en || "",
      cover: book.L_imageBia || "",
      author: book.auther || "",
      design: book.design || ""
    };
  }

  function renderManifestSnippet(){
    const entry = buildManifestEntry();
    const snippet = {
      books: [entry]
    };
    $("#manifestSnippet").textContent = JSON.stringify(snippet, null, 2);
  }

  /* =======================================================================
     ACTION BUTTONS
     ======================================================================= */
  $("#btnAdd").onclick = ()=>{ book.pages.push(emptyPage()); renderPages(); autosave(); };
  $("#btnDel").onclick = ()=>{ if(!book.pages.length) return; if(!confirm("Xoá trang cuối cùng?")) return; book.pages.pop(); renderPages(); autosave(); };
  $("#btnSave").onclick = ()=>{ localStorage.setItem('storybook_draft_full', JSON.stringify(book)); alert("Đã lưu bản nháp vào trình duyệt."); };

  // Export / Import toàn bộ book
  $("#btnExport").onclick = ()=>{
    const json = JSON.stringify(book, null, 2);
    download((book.IDBook||"book") + ".json", json);
  };
  $("#btnImport").onclick = ()=> $("#fileImport").click();
  $("#fileImport").addEventListener('change', async e=>{
    const f = e.target.files[0]; if(!f) return;
    try{
      const data = JSON.parse(await f.text());
      book = {
        IDBook: data.IDBook || "",
        little_vi: data.little_vi || "",
        little_en: data.little_en || "",
        auther: data.auther || "",
        design: data.design || "",
        L_imageBia: data.L_imageBia || "",
        pages: Array.isArray(data.pages) ? data.pages.map(p=>({
          TDBook: p.TDBook || "",
          IDPage: p.IDPage || "",
          noidung_vi: p.noidung_vi || "",
          noidung_en: p.noidung_en || "",
          L_image_P: p.L_image_P || "",
          L_sound_vi: p.L_sound_vi || "",
          L_sound_en: p.L_sound_en || ""
        })) : []
      };
      // re-bind all
      ["IDBook","little_vi","little_en","auther","design","L_imageBia"].forEach(id=>$("#"+id).value = book[id]||"");
      renderPages(); renderManifestSnippet(); autosave();
    }catch(err){ alert("Import lỗi: " + err.message); }
    finally{ e.target.value = ""; }
  });

  // Download: chỉ book.json
  $("#btnDLBook").onclick = ()=>{
    if(!book.IDBook) return alert("Nhập IDBook trước!");
    const json = JSON.stringify(book, null, 2);
    download(`${book.IDBook}.json`, json);
  };

  // Download: manifest.json (1 mục)
  $("#btnDLManifest").onclick = ()=>{
    const mf = { books: [buildManifestEntry()] };
    download(`library-manifest.json`, JSON.stringify(mf, null, 2));
  };

  // Download: cả hai
  $("#btnDLBoth").onclick = ()=>{
    if(!book.IDBook) return alert("Nhập IDBook trước!");
    $("#btnDLBook").click();
    setTimeout(()=>$("#btnDLManifest").click(), 100);
  };

  // Cảnh báo rời trang nếu có dữ liệu
  window.addEventListener('beforeunload', (e)=>{
    const has = (book.IDBook||book.little_vi||book.little_en||book.auther||book.design||book.L_imageBia||
      (book.pages && book.pages.some(p=>Object.values(p).some(Boolean))));
    if(has){ e.preventDefault(); e.returnValue=''; }
  });

  // BOOT
  (function init(){
    try{
      const saved = JSON.parse(localStorage.getItem('storybook_draft_full')||"null");
      if(saved){ book = {...book, ...saved}; if(Array.isArray(saved.pages)) book.pages = saved.pages; }
    }catch{}
    ["IDBook","little_vi","little_en","auther","design","L_imageBia"].forEach(id=>$("#"+id).value = book[id]||"");
    renderPages(); renderManifestSnippet();
  })();
 
  // ==== Helper lấy SHA của file hiện tại (để update) ====
  async function ghGet(path, asRaw=false){
    const url = `/.netlify/functions/sb-github-get?path=${encodeURIComponent(path)}${asRaw?'&raw=1':''}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error(await res.text());
    return asRaw ? await res.text() : await res.json();
  }

  // ==== LOAD từ GitHub theo IDBook ====
  document.getElementById('btnGitLoad').onclick = async ()=>{
    try{
      if (!book.IDBook) return alert('Nhập IDBook trước!');
      const path = `public/content/storybook/${book.IDBook}.json`;
      const got = await ghGet(path, true); // raw text
      const data = JSON.parse(got);

      // đổ vào form (bảo toàn cấu trúc bạn đang dùng)
      book = {
        IDBook: data.IDBook || "",
        little_vi: data.little_vi || "",
        little_en: data.little_en || "",
        auther: data.auther || "",
        design: data.design || "",
        L_imageBia: data.L_imageBia || "",
        pages: Array.isArray(data.pages) ? data.pages : []
      };
      ["IDBook","little_vi","little_en","auther","design","L_imageBia"].forEach(id=>document.getElementById(id).value = book[id]||"");
      renderPages(); renderManifestSnippet();
      alert('Đã nạp sách từ GitHub.');
    }catch(e){
      alert('Không tải được từ GitHub: ' + e.message);
    }
  };

  // ==== SAVE lên GitHub theo IDBook ====
  document.getElementById('btnGitSave').onclick = async ()=>{
    try{
      if (!book.IDBook) return alert('Nhập IDBook trước!');
      const path = `public/content/storybook/${book.IDBook}.json`;

      // 1) hỏi GitHub để lấy sha hiện tại (nếu có)
      let sha = undefined;
      try{
        const meta = await ghGet(path, false); // JSON metadata
        sha = meta?.data?.sha;
      }catch(_){ /* nếu 404 -> file mới, bỏ qua sha */ }

      // 2) gọi save
      const res = await fetch('/.netlify/functions/sb-github-save', {
        method:'POST',
        headers:{ 'content-type':'application/json' },
        body: JSON.stringify({
          path,
          content: JSON.stringify(book, null, 2),
          sha,                      // có thì update, không có thì create
          buildHook: true           // nếu đã set NETLIFY_BUILD_HOOK_URL → redeploy
        })
      });
      const j = await res.json();
      if (!res.ok || !j.ok) throw new Error(j.error || 'Save fail');
      alert('Đã lưu lên GitHub và kích hoạt redeploy (nếu cấu hình).');
    }catch(e){
      alert('Lỗi lưu GitHub: ' + e.message);
    }
  };
</script>
<script>
(function applyBrandEverywhere(){
  const BRAND_KEY='NINI_THEME_BRAND';
  try {
    const b = JSON.parse(localStorage.getItem(BRAND_KEY)||'{}');
    if (b.logoMain)  document.querySelectorAll('.brand__logo').forEach(i=>i.src=b.logoMain);
    if (b.logoSmall) document.querySelectorAll('.brand__logo--small').forEach(i=>i.src=b.logoSmall);
    if (b.slogan)    document.querySelectorAll('.brand__slogan').forEach(e=>e.textContent=b.slogan);
  } catch {}
})();
</script>

</body>
</html>


