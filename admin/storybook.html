<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NiNi — Storybook Editor</title>
  <link rel="icon" href="/public/assets/icons/logo_nini.webp" type="image/webp" />
  <link rel="stylesheet" href="/styles.css?v=admin-storybook-safe" />

  <!-- Load theme CSS (nếu có) -->
  <script>
  (function(){
    var ENDPOINT='/.netlify/functions/theme';
    var KEY='NINI_THEME_CACHE_V1';
    var MAX_AGE=3600;
    function inject(css){
      var s=document.getElementById('themeOverride');
      if(!s){ s=document.createElement('style'); s.id='themeOverride'; document.head.appendChild(s); }
      s.textContent=css;
    }
    try{
      var cache=JSON.parse(localStorage.getItem(KEY)||'null');
      var now=(Date.now()/1000)|0;
      if(cache && (now-cache.ts)<MAX_AGE){ inject(cache.css); }
      fetch(ENDPOINT,{cache:'no-store'})
        .then(function(r){return r.text();})
        .then(function(css){
          if(css){ inject(css); localStorage.setItem(KEY, JSON.stringify({ts: now, css: css})); }
        })
        .catch(function(){});
    }catch(_){}
  })();
  </script>

  <style>
    :root{
      --bg-url: url('/public/assets/bg/nini_home.webp');
      --glass-bg: rgba(255,255,255,.14);
      --glass-brd: rgba(255,255,255,.35);
      --ink:#1c2024; --muted:#6b7b8c; --radius:18px;
    }
    body{min-height:100svh;background:#0b1f13 var(--bg-url) center/cover fixed no-repeat;color:var(--ink)}
    .site-header{position:sticky;top:0;z-index:20;display:flex;gap:12px;align-items:center;width:min(1180px,94vw);margin:14px auto;padding:10px 14px;background:var(--glass-bg);border:1px solid var(--glass-brd);backdrop-filter:blur(10px);border-radius:14px}
    .brand{display:flex;gap:10px;align-items:center;text-decoration:none}
    .brand__logo{height:34px}
    .brand__slogan{font-weight:700;letter-spacing:.2px;background:linear-gradient(90deg,#F5D36B,#47A768,#8a5a2b);-webkit-background-clip:text;background-clip:text;color:transparent}
    .btn{appearance:none;border:1px solid var(--glass-brd);background:var(--glass-bg);color:var(--ink);border-radius:999px;padding:8px 14px;cursor:pointer;backdrop-filter:blur(8px)}
    .btn.small{padding:6px 10px}
    .btn.gray{opacity:.9}
    .btn.danger{border-color:#ffb0b0}
    .muted{color:var(--muted);font-size:13px}
    .page-hero{display:flex;justify-content:center}
    .panel-glass{width:min(1180px,94vw);margin:12px auto 80px;background:var(--glass-bg);border:1px solid var(--glass-brd);border-radius:var(--radius);backdrop-filter:blur(10px)}
    .wrap-page{padding:12px}
    .panel{background:transparent;margin:10px 0;border:1px dashed rgba(255,255,255,.25);border-radius:12px}
    .panel>h2{margin:0;padding:10px 12px}
    .grid{display:grid;gap:10px;padding:10px 12px}
    .grid-2{grid-template-columns:1fr 1fr}
    label{display:flex;flex-direction:column;gap:6px;font-size:14px}
    input,textarea,select{width:100%;padding:8px 10px;border:0;border-bottom:2px solid rgba(255,255,255,.55);background:transparent;color:var(--ink);outline:0}
    textarea{resize:vertical}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;padding:10px 12px}
    .note{padding:10px 12px;color:var(--muted)}
    .kbd{background:rgba(255,255,255,.22);padding:2px 6px;border-radius:6px}
    .card{background:rgba(255,255,255,.08);border:1px solid var(--glass-brd);border-radius:12px;margin:10px 12px}
    .pagehead{display:flex;align-items:center;justify-content:space-between;padding:8px 10px}
    .flex-end{display:flex;gap:8px}
    pre.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;background:rgba(0,0,0,.15);padding:10px;border-radius:10px;overflow:auto}
    .spacer{flex:1}
  </style>
</head>
<body style="--bg-url:url('/public/assets/bg/nini_home.webp')">
  <header class="site-header">
    <a class="brand" href="/#home" aria-label="NiNi — Funny">
      <img class="brand__logo" src="/public/assets/icons/logo_text.webp" alt="NiNi Funny" />
      <div class="brand__slogan">Chơi mê ly, bứt phá tư duy</div>
    </a>
    <div class="spacer"></div>
    <a class="btn" href="/admin/index.html">↩ Về Admin</a>
  </header>

  <main class="page-hero">
    <section class="panel-glass wrap-page" aria-label="Storybook Editor">
      <!-- BOOK -->
      <section class="panel">
        <h2>Book</h2>
        <div class="grid grid-2">
          <label>IDBook <input id="IDBook" type="text" placeholder="VD: B002"></label>
          <label>L_imageBia (Link ảnh bìa) <input id="L_imageBia" type="text" placeholder="https://.../cover.webp"></label>
          <label>little_vi (Tên sách VI) <input id="little_vi" type="text" placeholder="NiNi và ..."></label>
          <label>little_en (Book title EN) <input id="little_en" type="text" placeholder="NiNi and ..."></label>
          <label>auther <input id="auther" type="text" placeholder="Tác giả"></label>
          <label>design <input id="design" type="text" placeholder="Thiết kế"></label>
        </div>
        <div class="muted" style="padding:0 12px 12px">Tự lưu nháp vào trình duyệt (localStorage).</div>
      </section>

      <!-- ACTIONS -->
      <section class="panel">
        <h2>Actions</h2>
        <div class="row">
          <button id="btnSave" class="btn">Lưu (nháp)</button>
          <button id="btnAdd" class="btn">Add Page</button>
          <button id="btnDel" class="btn danger">Delete Page (cuối)</button>

          <button id="btnExport" class="btn gray">Export JSON</button>
          <button id="btnImport" class="btn gray">Import JSON</button>
          <input id="fileImport" type="file" accept="application/json" hidden>

          <span class="muted">|</span>

          <button id="btnDLBook" class="btn">Tải book.json</button>
          <button id="btnDLManifest" class="btn">Tải manifest.json</button>
          <button id="btnDLBoth" class="btn gray">Tải cả hai</button>

          <span class="muted">|</span>

          <button id="btnGitLoad" class="btn gray">Tải từ GitHub</button>
          <button id="btnGitSave" class="btn">Lưu lên GitHub</button>
        </div>

        <details style="margin:10px 12px">
          <summary class="muted">Xem nhanh snippet manifest (copy dán vào file manifest sẵn có)</summary>
          <pre id="manifestSnippet" class="mono"></pre>
        </details>
      </section>

      <!-- PAGES -->
      <section class="panel">
        <h2>Pages</h2>
        <div id="pagesWrap"></div>
      </section>

      <section class="panel">
        <h2>Gợi ý đặt file</h2>
        <div class="note">
          • Đặt <span class="kbd">/public/content/storybook/<b>IDBook</b>.json</span><br>
          • Manifest tại <span class="kbd">/public/content/storybook/library-manifest.json</span><br>
          • Với site đang chạy, chỉ cần upload 2 file này là kệ sách nhận ra ngay.
        </div>
      </section>
    </section>
  </main>

  <script>
  // ===== Helpers =====
  function $(s){return document.querySelector(s);}
  function download(name, dataStr){
    var blob=new Blob([dataStr],{type:'application/json'});
    var a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download=name; a.click();
    URL.revokeObjectURL(a.href);
  }

  // ===== State =====
  var book={
    IDBook:"", little_vi:"", little_en:"",
    auther:"", design:"", L_imageBia:"",
    pages:[]
  };
  function emptyPage(){
    return { TDBook:"", IDPage:"", noidung_vi:"", noidung_en:"", L_image_P:"", L_sound_vi:"", L_sound_en:"" };
  }

  var autosaveTimer=null;
  function autosave(){
    clearTimeout(autosaveTimer);
    autosaveTimer=setTimeout(function(){
      localStorage.setItem('storybook_draft_full', JSON.stringify(book));
    },350);
  }

  // ===== Bind book inputs =====
  ['IDBook','little_vi','little_en','auther','design','L_imageBia'].forEach(function(id){
    var el=document.getElementById(id);
    el.addEventListener('input', function(e){ book[id]=e.target.value; renderManifestSnippet(); autosave(); });
  });

  // ===== Render pages =====
  function renderPages(){
    var wrap=document.getElementById('pagesWrap');
    wrap.innerHTML='';
    if(!Array.isArray(book.pages) || !book.pages.length){ book.pages=[emptyPage()]; }

    book.pages.forEach(function(p,idx){
      var card=document.createElement('div');
      card.className='card';

      var head=document.createElement('div');
      head.className='pagehead';
      head.innerHTML='<strong>Page #'+(idx+1)+'</strong><div class="flex-end">'
                    +'<button class="btn small" data-act="up">↑</button>'
                    +'<button class="btn small" data-act="down">↓</button>'
                    +'<button class="btn small danger" data-act="rm">Xoá</button>'
                    +'</div>';
      card.appendChild(head);

      var grid=document.createElement('div');
      grid.className='grid grid-2';
      grid.innerHTML=''
        +'<label>TDBook <input data-f="TDBook" type="text" placeholder="Tiêu đề trang"></label>'
        +'<label>IDPage <input data-f="IDPage" type="text" placeholder="P001"></label>'
        +'<label>noidung_vi <textarea data-f="noidung_vi" rows="3" placeholder="Nội dung VI"></textarea></label>'
        +'<label>noidung_en <textarea data-f="noidung_en" rows="3" placeholder="English"></textarea></label>'
        +'<label>L_image_P <input data-f="L_image_P" type="text" placeholder="https://.../page.webp"></label>'
        +'<label>L_sound_vi <input data-f="L_sound_vi" type="text" placeholder="https://.../vi.mp3"></label>'
        +'<label>L_sound_en <input data-f="L_sound_en" type="text" placeholder="https://.../en.mp3"></label>';
      card.appendChild(grid);

      wrap.appendChild(card);

      // Fill + bind
      Array.prototype.slice.call(grid.querySelectorAll('[data-f]')).forEach(function(inp){
        var k=inp.getAttribute('data-f');
        inp.value=p[k]||'';
        inp.addEventListener('input', function(e){ book.pages[idx][k]=e.target.value; autosave(); });
      });

      // Move / remove
      head.querySelector('[data-act="up"]').onclick=function(){
        if(idx===0) return;
        var tmp=book.pages[idx-1]; book.pages[idx-1]=book.pages[idx]; book.pages[idx]=tmp;
        renderPages(); autosave();
      };
      head.querySelector('[data-act="down"]').onclick=function(){
        if(idx===book.pages.length-1) return;
        var t=book.pages[idx+1]; book.pages[idx+1]=book.pages[idx]; book.pages[idx]=t;
        renderPages(); autosave();
      };
      head.querySelector('[data-act="rm"]').onclick=function(){
        if(!confirm('Xoa Page #'+(idx+1)+'?')) return;
        book.pages.splice(idx,1); renderPages(); autosave();
      };
    });
  }

  // ===== Manifest =====
  function buildManifestEntry(){
    return {
      id: book.IDBook || 'unknown',
      title_vi: book.little_vi || '',
      title_en: book.little_en || '',
      cover: book.L_imageBia || '',
      author: book.auther || '',
      design: book.design || ''
    };
  }
  function renderManifestSnippet(){
    var entry=buildManifestEntry();
    var snippet={books:[entry]};
    document.getElementById('manifestSnippet').textContent=JSON.stringify(snippet,null,2);
  }

  // ===== Buttons =====
  document.getElementById('btnAdd').onclick=function(){ book.pages.push(emptyPage()); renderPages(); autosave(); };
  document.getElementById('btnDel').onclick=function(){ if(!book.pages.length) return; if(!confirm('Xoa trang cuoi?')) return; book.pages.pop(); renderPages(); autosave(); };
  document.getElementById('btnSave').onclick=function(){ localStorage.setItem('storybook_draft_full', JSON.stringify(book)); alert('Da luu ban nhap vao trinh duyet.'); };

  document.getElementById('btnExport').onclick=function(){
    download((book.IDBook||'book')+'.json', JSON.stringify(book,null,2));
  };
  document.getElementById('btnImport').onclick=function(){ document.getElementById('fileImport').click(); };
  document.getElementById('fileImport').addEventListener('change', function(e){
    var f=e.target.files[0]; if(!f) return;
    f.text()
      .then(function(txt){
        var data=JSON.parse(txt);
        book={
          IDBook: data.IDBook || '',
          little_vi: data.little_vi || '',
          little_en: data.little_en || '',
          auther: data.auther || '',
          design: data.design || '',
          L_imageBia: data.L_imageBia || '',
          pages: Array.isArray(data.pages)? data.pages.map(function(p){
            return {
              TDBook: p.TDBook || '',
              IDPage: p.IDPage || '',
              noidung_vi: p.noidung_vi || '',
              noidung_en: p.noidung_en || '',
              L_image_P: p.L_image_P || '',
              L_sound_vi: p.L_sound_vi || '',
              L_sound_en: p.L_sound_en || ''
            };
          }): []
        };
        ['IDBook','little_vi','little_en','auther','design','L_imageBia'].forEach(function(id){ document.getElementById(id).value=book[id]||''; });
        renderPages(); renderManifestSnippet(); autosave();
        e.target.value='';
      })
      .catch(function(err){ alert('Import loi: '+err.message); e.target.value=''; });
  });

  document.getElementById('btnDLBook').onclick=function(){
    if(!book.IDBook) return alert('Nhap IDBook truoc!');
    download(book.IDBook+'.json', JSON.stringify(book,null,2));
  };
  document.getElementById('btnDLManifest').onclick=function(){
    download('library-manifest.json', JSON.stringify({books:[buildManifestEntry()]},null,2));
  };
  document.getElementById('btnDLBoth').onclick=function(){
    if(!book.IDBook) return alert('Nhap IDBook truoc!');
    document.getElementById('btnDLBook').click();
    setTimeout(function(){ document.getElementById('btnDLManifest').click(); },120);
  };

  // ===== GitHub helpers qua Netlify Functions =====
  function ghGet(path, asRaw){
    var url='/.netlify/functions/sb-github-get?path='+encodeURIComponent(path)+(asRaw?'&raw=1':'');
    return fetch(url).then(function(r){ if(!r.ok) return r.text().then(function(t){throw new Error(t);}); return asRaw?r.text():r.json(); });
  }
  document.getElementById('btnGitLoad').onclick=function(){
    if(!book.IDBook) return alert('Nhap IDBook truoc!');
    var path='public/content/storybook/'+book.IDBook+'.json';
    ghGet(path,true)
      .then(function(raw){
        var data=JSON.parse(raw);
        book.IDBook=data.IDBook||''; book.little_vi=data.little_vi||''; book.little_en=data.little_en||'';
        book.auther=data.auther||''; book.design=data.design||''; book.L_imageBia=data.L_imageBia||'';
        book.pages=Array.isArray(data.pages)?data.pages:[];
        ['IDBook','little_vi','little_en','auther','design','L_imageBia'].forEach(function(id){ document.getElementById(id).value=book[id]||''; });
        renderPages(); renderManifestSnippet();
        alert('Da nap sach tu GitHub.');
      })
      .catch(function(e){ alert('Khong tai duoc tu GitHub: '+e.message); });
  };
  document.getElementById('btnGitSave').onclick=function(){
    if(!book.IDBook) return alert('Nhap IDBook truoc!');
    var path='public/content/storybook/'+book.IDBook+'.json';
    var sha;
    ghGet(path,false)
      .then(function(meta){ sha=meta && meta.data && meta.data.sha; })
      .catch(function(){})
      .then(function(){
        return fetch('/.netlify/functions/sb-github-save',{
          method:'POST',
          headers:{'content-type':'application/json'},
          body:JSON.stringify({ path:path, content:JSON.stringify(book,null,2), sha:sha, buildHook:true })
        });
      })
      .then(function(r){ return r.json().then(function(j){ if(!r.ok||!j.ok) throw new Error(j.error||'Save fail'); return j; }); })
      .then(function(){ alert('Da luu len GitHub va kick redeploy (neu cau hinh).'); })
      .catch(function(e){ alert('Loi luu GitHub: '+e.message); });
  };

  // ===== Leave guard =====
  window.addEventListener('beforeunload', function(e){
    var has=(book.IDBook||book.little_vi||book.little_en||book.auther||book.design||book.L_imageBia||(book.pages&&book.pages.some(function(p){return Object.keys(p).some(function(k){return !!p[k];});})));
    if(has){ e.preventDefault(); e.returnValue=''; }
  });

  // ===== Boot =====
  (function init(){
    try{
      var saved=JSON.parse(localStorage.getItem('storybook_draft_full')||'null');
      if(saved){ for(var k in saved){ if(k!=='pages') book[k]=saved[k]; }
        if(Array.isArray(saved.pages)) book.pages=saved.pages;
      }
    }catch(_){}
    ['IDBook','little_vi','little_en','auther','design','L_imageBia'].forEach(function(id){ document.getElementById(id).value=book[id]||''; });
    renderPages(); renderManifestSnippet();
  })();
  </script>

  <!-- Áp dụng brand (logo/slogan) nếu đã set ở admin -->
  <script>
  (function(){
    var KEY='NINI_THEME_BRAND';
    try{
      var b=JSON.parse(localStorage.getItem(KEY)||'{}');
      if(b.logoMain){ Array.prototype.forEach.call(document.querySelectorAll('.brand__logo'), function(i){ i.src=b.logoMain; }); }
      if(b.slogan){ Array.prototype.forEach.call(document.querySelectorAll('.brand__slogan'), function(e){ e.textContent=b.slogan; }); }
    }catch(_){}
  })();
  </script>
</body>
</html>
