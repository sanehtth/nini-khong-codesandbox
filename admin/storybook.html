<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NiNi — Storybook Editor</title>
  <link rel="icon" href="/public/assets/icons/logo_nini.webp" type="image/webp" />
  <link rel="stylesheet" href="/styles.css?v=admin-storybook" />

  <!-- Inject theme động từ Netlify Function (nếu có) -->
  <script>
  (function(){
    const ENDPOINT='/.netlify/functions/theme';
    const KEY='NINI_THEME_CACHE_V1';
    const MAX_AGE=3600; // 1h
    function inject(css){
      let s=document.getElementById('themeOverride');
      if(!s){ s=document.createElement('style'); s.id='themeOverride'; document.head.appendChild(s); }
      s.textContent=css;
    }
    try{
      const cache=JSON.parse(localStorage.getItem(KEY)||'null');
      const now=Date.now()/1000|0;
      if(cache && (now-cache.ts)<MAX_AGE){ inject(cache.css); }
      fetch(ENDPOINT,{cache:'no-store'}).then(r=>r.text()).then(css=>{
        if(css){ inject(css); localStorage.setItem(KEY, JSON.stringify({ts: now, css})); }
      }).catch(()=>{});
    }catch(_){}
  })();
  </script>

  <!-- Fallback CSS nhỏ để trang luôn hiển thị -->
  <style>
    :root{
      --bg-url: url('/public/assets/bg/nini_home.webp');
      --glass-bg: rgba(255,255,255,.14);
      --glass-brd: rgba(255,255,255,.35);
      --ink:#1c2024;
      --muted:#6b7b8c;
      --radius:18px;
    }
    body{min-height:100svh;background:#0b1f13 var(--bg-url) center/cover fixed no-repeat;color:var(--ink)}
    .site-header{
      position:sticky;top:0;z-index:20;display:flex;gap:12px;align-items:center;
      width:min(1180px,94vw);margin:14px auto;padding:10px 14px;
      background:var(--glass-bg);border:1px solid var(--glass-brd);backdrop-filter:blur(10px);border-radius:14px;
    }
    .brand{display:flex;gap:10px;align-items:center;text-decoration:none}
    .brand__logo{height:34px}
    .brand__slogan{font-weight:700;letter-spacing:.2px;background:linear-gradient(90deg,#F5D36B,#47A768,#8a5a2b);
      -webkit-background-clip:text;background-clip:text;color:transparent}
    .btn{
      appearance:none;border:1px solid var(--glass-brd);background:var(--glass-bg);color:var(--ink);
      border-radius:999px;padding:8px 14px;cursor:pointer;backdrop-filter:blur(8px)
    }
    .btn.small{padding:6px 10px}
    .btn.gray{opacity:.9}
    .btn.danger{border-color:#ffb0b0}
    .muted{color:var(--muted);font-size:13px}
    .page-hero{display:flex;justify-content:center}
    .panel-glass{
      width:min(1180px,94vw);margin:12px auto 80px;background:var(--glass-bg);
      border:1px solid var(--glass-brd);border-radius:var(--radius);backdrop-filter:blur(10px)
    }
    .wrap-page{padding:12px}
    .panel{background:transparent;margin:10px 0;border:1px dashed rgba(255,255,255,.25);border-radius:12px}
    .panel>h2{margin:0;padding:10px 12px}
    .grid{display:grid;gap:10px;padding:10px 12px}
    .grid-2{grid-template-columns:1fr 1fr}
    label{display:flex;flex-direction:column;gap:6px;font-size:14px}
    input,textarea,select{
      width:100%;padding:8px 10px;border:0;border-bottom:2px solid rgba(255,255,255,.55);
      background:transparent;color:var(--ink);outline:0
    }
    textarea{resize:vertical}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;padding:10px 12px}
    .note{padding:10px 12px;color:var(--muted)}
    .kbd{background:rgba(255,255,255,.22);padding:2px 6px;border-radius:6px}
    .card{background:rgba(255,255,255,.08);border:1px solid var(--glass-brd);border-radius:12px;margin:10px 12px}
    .pagehead{display:flex;align-items:center;justify-content:space-between;padding:8px 10px}
    .flex-end{display:flex;gap:8px}
    pre.mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      background:rgba(0,0,0,.15);padding:10px;border-radius:10px;overflow:auto}
    .spacer{flex:1}
  </style>
</head>

<body style="--bg-url:url('/public/assets/bg/nini_home.webp')">
  <!-- Header -->
  <header class="site-header">
    <a class="brand" href="/#home" aria-label="NiNi — Funny">
      <img class="brand__logo" src="/public/assets/icons/logo_text.webp" alt="NiNi Funny" />
      <div class="brand__slogan">Chơi mê ly, bứt phá tư duy</div>
    </a>
    <div class="spacer"></div>
    <a class="btn" href="/admin/index.html">↩ Về Admin</a>
  </header>

  <!-- Main -->
  <main class="page-hero">
    <section class="panel-glass wrap-page" aria-label="Storybook Editor">

      <!-- BOOK META -->
      <section class="panel">
        <h2>Book</h2>
        <div class="grid grid-2" id="bookForm">
          <label>IDBook <input id="IDBook" type="text" placeholder="VD: B002"></label>
          <label>L_imageBia (Link ảnh bìa) <input id="L_imageBia" type="text" placeholder="https://.../cover.webp"></label>
          <label>little_vi (Tên sách VI) <input id="little_vi" type="text" placeholder="NiNi và ..."></label>
          <label>little_en (Book title EN) <input id="little_en" type="text" placeholder="NiNi and ..."></label>
          <label>auther <input id="auther" type="text" placeholder="Tác giả"></label>
          <label>design <input id="design" type="text" placeholder="Thiết kế"></label>
        </div>
        <div class="muted" style="padding:0 12px 12px">Tự lưu nháp vào trình duyệt (localStorage).</div>
      </section>

      <!-- ACTIONS -->
      <section class="panel">
        <h2>Actions</h2>
        <div class="row">
          <button id="btnSave" class="btn">Lưu (nháp)</button>
          <button id="btnAdd" class="btn">Add Page</button>
          <button id="btnDel" class="btn danger">Delete Page (cuối)</button>

          <button id="btnExport" class="btn gray">Export JSON</button>
          <button id="btnImport" class="btn gray">Import JSON</button>
          <input id="fileImport" type="file" accept="application/json" hidden>

          <span class="muted">|</span>

          <button id="btnDLBook" class="btn">Tải book.json</button>
          <button id="btnDLManifest" class="btn">Tải manifest.json</button>
          <button id="btnDLBoth" class="btn gray">Tải cả hai</button>

          <span class="muted">|</span>

          <button id="btnGitLoad" class="btn gray">Tải từ GitHub</button>
          <button id="btnGitSave" class="btn">Lưu lên GitHub</button>
        </div>

        <details style="margin:10px 12px">
          <summary class="muted">Xem nhanh snippet manifest (copy dán vào file manifest sẵn có)</summary>
          <pre id="manifestSnippet" class="mono"></pre>
        </details>
      </section>

      <!-- PAGES -->
      <section class="panel">
        <h2>Pages</h2>
        <div id="pagesWrap"></div>
      </section>

      <!-- HINT -->
      <section class="panel">
        <h2>Gợi ý đặt file</h2>
        <div class="note">
          • Đặt <span class="kbd">/public/content/storybook/<b>IDBook</b>.json</span><br>
          • Manifest tại <span class="kbd">/public/content/storybook/library-manifest.json</span><br>
          • Với site đang chạy, chỉ cần upload 2 file này là kệ sách nhận ra ngay.
        </div>
      </section>

    </section>
  </main>

  <!-- App -->
  <script>
  /* =======================================================================
     STATE + HELPERS
     ======================================================================= */
  const $ = sel => document.querySelector(sel);

  let book = {
    IDBook:"", little_vi:"", little_en:"",
    auther:"", design:"", L_imageBia:"",
    pages:[]
  };

  function emptyPage(){
    return { TDBook:"", IDPage:"", noidung_vi:"", noidung_en:"", L_image_P:"", L_sound_vi:"", L_sound_en:"" };
  }

  function download(name, dataStr){
    const blob = new Blob([dataStr], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  let autosaveTimer;
  function autosave(){
    clearTimeout(autosaveTimer);
    autosaveTimer = setTimeout(()=>localStorage.setItem('storybook_draft_full', JSON.stringify(book)), 350);
  }

  /* Bind BOOK inputs */
  ["IDBook","little_vi","little_en","auther","design","L_imageBia"].forEach(id=>{
    const el = document.getElementById(id);
    el.addEventListener('input', e => { book[id] = e.target.value; renderManifestSnippet(); autosave(); });
  });

  /* Pages rendering */
  function renderPages(){
    const wrap = document.getElementById("pagesWrap");
    wrap.innerHTML = "";

    if(!Array.isArray(book.pages) || !book.pages.length) book.pages = [emptyPage()];

    book.pages.forEach((p,idx)=>{
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="pagehead">
          <strong>Page #${idx+1}</strong>
          <div class="flex-end">
            <button class="btn small" data-act="up">↑</button>
            <button class="btn small" data-act="down">↓</button>
            <button class="btn small danger" data-act="rm">Xoá</button>
          </div>
        </div>
        <div class="grid grid-2">
          <label>TDBook <input data-f="TDBook" type="text" placeholder="Tiêu đề trang"></label>
          <label>IDPage <input data-f="IDPage" type="text" placeholder="P001"></label>
          <label>noidung_vi <textarea data-f="noidung_vi" rows="3" placeholder="Nội dung VI"></textarea></label>
          <label>noidung_en <textarea data-f="noidung_en" rows="3" placeholder="English"></textarea></label>
          <label>L_image_P <input data-f="L_image_P" type="text" placeholder="https://.../page.webp"></label>
          <label>L_sound_vi <input data-f="L_sound_vi" type="text" placeholder="https://.../vi.mp3"></label>
          <label>L_sound_en <input data-f="L_sound_en" type="text" placeholder="https://.../en.mp3"></label>
        </div>
      `;
      wrap.appendChild(card);

      // fill & bind
      card.querySelectorAll('[data-f]').forEach(inp=>{
        const k = inp.dataset.f;
        inp.value = p[k] || "";
        inp.addEventListener('input', e=>{ book.pages[idx][k] = e.target.value; autosave(); });
      });

      // move / remove
      card.querySelector('[data-act="up"]').onclick   = ()=>{ if(idx===0) return; [book.pages[idx-1],book.pages[idx]]=[book.pages[idx],book.pages[idx-1]]; renderPages(); autosave(); };
      card.querySelector('[data-act="down"]').onclick = ()=>{ if(idx===book.pages.length-1) return; [book.pages[idx],book.pages[idx+1]]=[book.pages[idx+1],book.pages[idx]]; renderPages(); autosave(); };
      card.querySelector('[data-act="rm"]').onclick   = ()=>{ if(!confirm(\`Xoá Page #${idx+1}?\`)) return; book.pages.splice(idx,1); renderPages(); autosave(); };
    });
  }

  /* Manifest helpers */
  function buildManifestEntry(){
    return {
      id: book.IDBook || "unknown",
      title_vi: book.little_vi || "",
      title_en: book.little_en || "",
      cover: book.L_imageBia || "",
      author: book.auther || "",
      design: book.design || ""
    };
  }
  function renderManifestSnippet(){
    const entry = buildManifestEntry();
    const snippet = { books: [entry] };
    document.getElementById("manifestSnippet").textContent = JSON.stringify(snippet, null, 2);
  }

  /* Buttons */
  document.getElementById("btnAdd").onclick = ()=>{ book.pages.push(emptyPage()); renderPages(); autosave(); };
  document.getElementById("btnDel").onclick = ()=>{ if(!book.pages.length) return; if(!confirm("Xoá trang cuối cùng?")) return; book.pages.pop(); renderPages(); autosave(); };
  document.getElementById("btnSave").onclick = ()=>{ localStorage.setItem('storybook_draft_full', JSON.stringify(book)); alert("Đã lưu bản nháp vào trình duyệt."); };

  document.getElementById("btnExport").onclick = ()=>{
    const json = JSON.stringify(book, null, 2);
    download((book.IDBook||"book") + ".json", json);
  };
  document.getElementById("btnImport").onclick = ()=> document.getElementById("fileImport").click();
  document.getElementById("fileImport").addEventListener('change', async e=>{
    const f = e.target.files[0]; if(!f) return;
    try{
      const data = JSON.parse(await f.text());
      book = {
        IDBook: data.IDBook || "",
        little_vi: data.little_vi || "",
        little_en: data.little_en || "",
        auther: data.auther || "",
        design: data.design || "",
        L_imageBia: data.L_imageBia || "",
        pages: Array.isArray(data.pages) ? data.pages.map(p=>({
          TDBook: p.TDBook || "",
          IDPage: p.IDPage || "",
          noidung_vi: p.noidung_vi || "",
          noidung_en: p.noidung_en || "",
          L_image_P: p.L_image_P || "",
          L_sound_vi: p.L_sound_vi || "",
          L_sound_en: p.L_sound_en || ""
        })) : []
      };
      ["IDBook","little_vi","little_en","auther","design","L_imageBia"].forEach(id=>document.getElementById(id).value = book[id]||"");
      renderPages(); renderManifestSnippet(); autosave();
    }catch(err){ alert("Import lỗi: " + err.message); }
    finally{ e.target.value = ""; }
  });

  document.getElementById("btnDLBook").onclick = ()=>{
    if(!book.IDBook) return alert("Nhập IDBook trước!");
    download(`${book.IDBook}.json`, JSON.stringify(book, null, 2));
  };
  document.getElementById("btnDLManifest").onclick = ()=>{
    const mf = { books: [buildManifestEntry()] };
    download(`library-manifest.json`, JSON.stringify(mf, null, 2));
  };
  document.getElementById("btnDLBoth").onclick = ()=>{
    if(!book.IDBook) return alert("Nhập IDBook trước!");
    document.getElementById("btnDLBook").click();
    setTimeout(()=>document.getElementById("btnDLManifest").click(), 120);
  };

  // ==== Helper gọi Netlify Functions để lấy/ghi GitHub ====
  async function ghGet(path, asRaw=false){
    const url = `/.netlify/functions/sb-github-get?path=${encodeURIComponent(path)}${asRaw?'&raw=1':''}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error(await res.text());
    return asRaw ? await res.text() : await res.json();
  }

  document.getElementById('btnGitLoad').onclick = async ()=>{
    try{
      if (!book.IDBook) return alert('Nhập IDBook trước!');
      const path = `public/content/storybook/${book.IDBook}.json`;
      const got = await ghGet(path, true); // raw text
      const data = JSON.parse(got);
      book = {
        IDBook: data.IDBook || "",
        little_vi: data.little_vi || "",
        little_en: data.little_en || "",
        auther: data.auther || "",
        design: data.design || "",
        L_imageBia: data.L_imageBia || "",
        pages: Array.isArray(data.pages) ? data.pages : []
      };
      ["IDBook","little_vi","little_en","auther","design","L_imageBia"].forEach(id=>document.getElementById(id).value = book[id]||"");
      renderPages(); renderManifestSnippet();
      alert('Đã nạp sách từ GitHub.');
    }catch(e){
      alert('Không tải được từ GitHub: ' + e.message);
    }
  };

  document.getElementById('btnGitSave').onclick = async ()=>{
    try{
      if (!book.IDBook) return alert('Nhập IDBook trước!');
      const path = `public/content/storybook/${book.IDBook}.json`;

      // lấy sha hiện tại (nếu file đã tồn tại)
      let sha = undefined;
      try{
        const meta = await ghGet(path, false); // JSON metadata (từ function)
        sha = meta?.data?.sha;
      }catch(_){ /* 404 -> file mới */ }

      const res = await fetch('/.netlify/functions/sb-github-save', {
        method:'POST',
        headers:{ 'content-type':'application/json' },
        body: JSON.stringify({
          path,
          content: JSON.stringify(book, null, 2),
          sha,               // có thì update, không có thì create
          buildHook: true    // nếu đã set NETLIFY_BUILD_HOOK_URL → redeploy
        })
      });
      const j = await res.json();
      if (!res.ok || !j.ok) throw new Error(j.error || 'Save fail');
      alert('Đã lưu lên GitHub và kích hoạt redeploy (nếu cấu hình).');
    }catch(e){
      alert('Lỗi lưu GitHub: ' + e.message);
    }
  };

  // cảnh báo rời trang nếu có dữ liệu
  window.addEventListener('beforeunload', (e)=>{
    const has = (book.IDBook||book.little_vi||book.little_en||book.auther||book.design||book.L_imageBia||
      (book.pages && book.pages.some(p=>Object.values(p).some(Boolean))));
    if(has){ e.preventDefault(); e.returnValue=''; }
  });

  // BOOT
  (function init(){
    try{
      const saved = JSON.parse(localStorage.getItem('storybook_draft_full')||"null");
      if(saved){ book = {...book, ...saved}; if(Array.isArray(saved.pages)) book.pages = saved.pages; }
    }catch{}
    ["IDBook","little_vi","little_en","auther","design","L_imageBia"].forEach(id=>document.getElementById(id).value = book[id]||"");
    renderPages(); renderManifestSnippet();
  })();
  </script>

  <!-- Áp dụng logo/slogan đã lưu trong Theme -->
  <script>
  (function applyBrandEverywhere(){
    const BRAND_KEY='NINI_THEME_BRAND';
    try{
      const b = JSON.parse(localStorage.getItem(BRAND_KEY)||'{}');
      if (b.logoMain)  document.querySelectorAll('.brand__logo').forEach(i=>i.src=b.logoMain);
      if (b.slogan)    document.querySelectorAll('.brand__slogan').forEach(e=>e.textContent=b.slogan);
    }catch(_){}
  })();
  </script>
</body>
</html>
