<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>NiNi — Tạo nhân vật</title>
  <link rel="stylesheet" href="/test/css/nini-theme.css"/>
  <style>
    .wrap{padding:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .w100{width:100%}
    .muted small{opacity:.8}
    .prompt-box{min-height:96px;white-space:pre-wrap}
    .gallery{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
    .thumb{position:relative;border-radius:10px;overflow:hidden}
    .thumb img{width:100%;display:block}
    .thumb .pick{position:absolute;inset:auto 8px 8px auto}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body style="--bg-url:url('/public/assets/bg/nini_home.webp')">
<main class="wrap">
  <section class="panel glass">
    <div class="panel-head">
      <h3 class="title">🧩 Khai báo nhân vật</h3>
      <div class="muted">Điền thuộc tính → hệ thống ghép Prompt → tạo ảnh xem thử → chọn ảnh ưng ý & lưu.</div>
    </div>
    <div class="panel-body">
      <div class="grid">
        <!-- Cột trái: Form -->
        <div>
          <div class="row">
            <label class="input underline w100">
              <span>ID (để trống = tự sinh)</span>
              <input id="charId" placeholder="vd: NV001"/>
            </label>
            <label class="input underline w100">
              <span>Tên nhân vật</span>
              <input id="charName" placeholder="vd: Linh Hàn Sương"/>
            </label>
          </div>
          <div class="row">
            <label class="input underline">
              <span>Giới tính</span>
              <select id="gender">
                <option value="">(không chỉ định)</option>
                <option>nữ</option>
                <option>nam</option>
                <option>phi giới tính</option>
              </select>
            </label>
            <label class="input underline">
              <span>Kiểu tóc</span>
              <input id="hairStyle" placeholder="dài, bob, búi cao…"/>
            </label>
            <label class="input underline">
              <span>Màu tóc</span>
              <input id="hairColor" placeholder="trắng bạc, đen, đỏ rượu…"/>
            </label>
          </div>
          <div class="row">
            <label class="input underline">
              <span>Mắt</span>
              <input id="eyeShape" placeholder="mắt to, mắt hạnh nhân…"/>
            </label>
            <label class="input underline">
              <span>Màu mắt</span>
              <input id="eyeColor" placeholder="xanh lam, hổ phách…"/>
            </label>
            <label class="input underline">
              <span>Khuôn mặt</span>
              <input id="faceShape" placeholder="trái xoan, góc cạnh…"/>
            </label>
          </div>
          <div class="row">
            <label class="input underline">
              <span>Mũi</span>
              <input id="nose" placeholder="cao, thon…"/>
            </label>
            <label class="input underline">
              <span>Miệng</span>
              <input id="mouth" placeholder="mỉm cười nhẹ…"/>
            </label>
            <label class="input underline">
              <span>Màu da</span>
              <input id="skinTone" placeholder="trắng sứ, bánh mật…"/>
            </label>
          </div>
          <div class="row">
            <label class="input underline w100">
              <span>Trang phục (áo/quần/giày)</span>
              <input id="outfit" placeholder="áo choàng xanh, giáp da nâu, ủng cao cổ…"/>
            </label>
          </div>
          <div class="row">
            <label class="input underline w100">
              <span>Phụ kiện</span>
              <input id="accessories" placeholder="gậy phép phát sáng, bông tai…"/>
            </label>
          </div>
          <div class="row">
            <label class="input underline w100">
              <span>Phong cách nhân vật</span>
              <input id="style" placeholder="anime, pixar, semi-realistic, watercolor…"/>
            </label>
          </div>
          <div class="row">
            <label class="input underline">
              <span>Tỉ lệ khung</span>
              <select id="ratio">
                <option value="">1:1</option>
                <option>3:4</option>
                <option>4:3</option>
                <option>16:9</option>
                <option>9:16</option>
              </select>
            </label>
            <label class="input underline">
              <span>Seed (tuỳ chọn)</span>
              <input id="seed" type="number" placeholder="để trống = random"/>
            </label>
            <label class="input underline">
              <span>Model</span>
              <select id="model">
                <option value="stabilityai/sdxl-turbo">sdxl-turbo (nhanh)</option>
                <option value="black-forest-labs/FLUX.1-schnell">FLUX.1-schnell (nhanh)</option>
              </select>
            </label>
          </div>

          <div class="row">
            <button id="btnBuild" class="btn pill">🔧 Ghép Prompt</button>
            <button id="btnPreview" class="btn pill">▶️ Tạo ảnh xem thử</button>
          </div>
          <div class="panel glass" style="margin-top:10px">
            <div class="panel-head"><h4 class="title">Prompt sinh ảnh</h4></div>
            <div id="promptOut" class="panel-body prompt-box"></div>
          </div>
        </div>

        <!-- Cột phải: Kết quả & lưu -->
        <div>
          <div class="panel glass">
            <div class="panel-head">
              <h4 class="title">Kết quả xem thử</h4>
              <div class="muted"><small>Tối đa 6 ảnh gần nhất</small></div>
            </div>
            <div class="panel-body">
              <div id="status" class="muted"></div>
              <div id="gallery" class="gallery" style="margin-top:10px"></div>
              <div class="row" style="margin-top:12px">
                <button id="btnSave" class="btn" disabled>💾 Lưu nhân vật</button>
              </div>
            </div>
          </div>

          <div class="panel glass" style="margin-top:12px">
            <div class="panel-head"><h4 class="title">Tuỳ chọn khác</h4></div>
            <div class="panel-body">
              <div class="row">
                <button id="btnOpenHF" class="btn">↗ Mở Space miễn phí (tab mới)</button>
              </div>
              <div class="muted"><small>Dùng Space `.hf.space` của bạn khi muốn vẽ thủ công.</small></div>
            </div>
          </div>
        </div>
      </div><!-- /grid -->
    </div>
  </section>
</main>

<script>
  // ==== Helpers ====
  const $ = s => document.querySelector(s);
  const byId = id => document.getElementById(id);

  function esc(s){ return s==null ? "" : String(s).trim(); }
  function nonEmpty(parts){ return parts.filter(Boolean).join(", "); }

  function buildPrompt() {
    const gender=esc(genderEl.value), hair=nonEmpty([esc(hairStyle.value), esc(hairColor.value)]),
      eyes=nonEmpty([esc(eyeShape.value), esc(eyeColor.value)]),
      face=esc(faceShape.value), nose=esc(nose.value), mouth=esc(mouth.value),
      skin=esc(skinTone.value), outfit=esc(outfit.value), acc=esc(accessories.value),
      style=esc(styleEl.value), ratio=esc(ratioEl.value);

    const core = nonEmpty([
      gender && `a ${gender} character`,
      hair && `hair: ${hair}`,
      eyes && `eyes: ${eyes}`,
      face && `face: ${face}`,
      nose && `nose: ${nose}`,
      mouth && `mouth: ${mouth}`,
      skin && `skin tone: ${skin}`,
      outfit && `outfit: ${outfit}`,
      acc && `accessories: ${acc}`,
      style && `style: ${style}`
    ]);

    const extras = "highly detailed, soft lighting, clean background, sharp focus";
    const prompt = [core, extras, ratio && `aspect ratio ${ratio}`].filter(Boolean).join(", ");
    promptOut.textContent = prompt;
    return prompt;
  }

  // Bind inputs
  const genderEl = byId('gender'), hairStyle=byId('hairStyle'), hairColor=byId('hairColor'),
        eyeShape=byId('eyeShape'), eyeColor=byId('eyeColor'), faceShape=byId('faceShape'),
        nose=byId('nose'), mouth=byId('mouth'), skinTone=byId('skinTone'),
        outfit=byId('outfit'), accessories=byId('accessories'), styleEl=byId('style'),
        ratioEl=byId('ratio'), seedEl=byId('seed'), modelEl=byId('model'),
        promptOut=byId('promptOut'), statusEl=byId('status'), gallery=byId('gallery');

  byId('btnBuild').onclick = buildPrompt;

  // ==== Preview (gọi Netlify Function HF/Replicate proxy) ====
  const MAX_KEEP = 6;
  let pickedUrl = null, lastImageIds = []; // lưu các ảnh generate để save vào Firestore

  byId('btnPreview').onclick = async () => {
    const prompt = buildPrompt();
    if (!prompt) { alert("Chưa có prompt."); return; }
    statusEl.textContent = "⏳ Đang tạo ảnh xem thử…";
    pickedUrl = null; byId('btnSave').disabled = true;

    try{
      const model = modelEl.value;
      const seed = seedEl.value ? Number(seedEl.value) : null;
      // Gọi function generate: bạn đã có pattern images-generate
      const r = await fetch("/.netlify/functions/images-generate", {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          characterId: byId('charId').value || null, // có thể null ở preview
          prompt, model, seed
        })
      });
      const j = await r.json();
      if (!j.ok) throw new Error(j.error || `HTTP ${r.status}`);
      const url = j.url; const imageId = j.imageId;
      statusEl.textContent = "✅ Xong 1 ảnh. Bạn có thể bấm lại để tạo thêm biến thể.";

      // Thêm vào gallery (tối đa 6)
      const card = document.createElement('div');
      card.className = 'thumb glass';
      card.innerHTML = `<img src="${url}" alt="">
        <button class="btn pick">Chọn</button>`;
      card.querySelector('.pick').onclick = () => {
        pickedUrl = url;
        [...gallery.children].forEach(c => c.style.outline = "");
        card.style.outline = "3px solid var(--brand-4)";
        byId('btnSave').disabled = false;
      };
      gallery.prepend(card);
      lastImageIds.unshift(imageId);
      if (gallery.children.length > MAX_KEEP) gallery.lastElementChild.remove();
      if (lastImageIds.length > MAX_KEEP) lastImageIds.length = MAX_KEEP;

    }catch(e){
      statusEl.textContent = "❌ Lỗi: " + e.message;
    }
  };

  // ==== Save character ====
  byId('btnSave').onclick = async () => {
    if (!pickedUrl) { alert("Hãy chọn một ảnh trong gallery trước."); return; }
    const id = byId('charId').value.trim();
    const name = byId('charName').value.trim();
    const prompt = buildPrompt();
    if (!name || !prompt) { alert("Thiếu Tên nhân vật hoặc Prompt."); return; }
    statusEl.textContent = "💾 Đang lưu nhân vật…";

    try{
      // 1) Tạo (hoặc upsert) nhân vật
      const r1 = await fetch("/.netlify/functions/characters-create", {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          name, base_prompt: prompt, model: modelEl.value,
          seed: seedEl.value ? Number(seedEl.value) : null,
          // Nếu bạn muốn giữ ID tự chọn:
          characterId: id || null
        })
      });
      const j1 = await r1.json();
      if (!j1.ok) throw new Error(j1.error || "create failed");
      const characterId = j1.characterId;

      // 2) Gắn ảnh đã chọn vào subcollection images (nếu images-generate đã ghi rồi thì có thể bỏ bước này,
      //    nhưng ở đây mình minh hoạ thêm endpoint save-image-url đơn giản)
      const r2 = await fetch("/.netlify/functions/characters-save-image", {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          characterId,
          url: pickedUrl,
          prompt,
          model: modelEl.value,
          seed: seedEl.value ? Number(seedEl.value) : null
        })
      });
      const j2 = await r2.json();
      if (!j2.ok) throw new Error(j2.error || "save image failed");

      statusEl.textContent = `✅ Đã lưu nhân vật #${characterId}`;
      alert("Lưu thành công!");

      // Gán lại ID hiển thị cho người dùng
      byId('charId').value = characterId;

    }catch(e){
      statusEl.textContent = "❌ Lỗi lưu: " + e.message;
    }
  };

  // ==== Mở Space miễn phí (tab mới) ====
  byId('btnOpenHF').onclick = () => {
    // Link Space của bạn:
    window.open("https://sanehuynh-taonv.hf.space/?embed=1", "_blank", "noopener");
  };
</script>
</body>
</html>
