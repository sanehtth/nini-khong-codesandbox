<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>NiNi ‚Äî T·∫°o nh√¢n v·∫≠t</title>
  <link rel="stylesheet" href="/test/css/nini-theme.css"/>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#faf7f2}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px}
  label{display:block;margin-bottom:8px}
  input,textarea,select{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px}
  textarea{height:120px}
  button{padding:12px 14px;border-radius:10px;border:1px solid #111827;background:#111827;color:#fff;cursor:pointer}
  button.ghost{background:#fff;color:#111827}
  .views{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:12px}
  .thumb{border:1px dashed #d1d5db;border-radius:12px;aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;background:#fcfcfc}
  .thumb img{max-width:100%;max-height:100%;border-radius:10px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  pre{white-space:pre-wrap;background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:12px}
  .small{font-size:12px;color:#6b7280}
</style>
</head>
<body>
<div class="wrap">
  <h1>üß© Character Builder</h1>
  <p class="small">T·∫°o nh√¢n v·∫≠t nh·∫•t qu√°n cho ·∫£nh/video. Sinh 4 view, l∆∞u Firebase, v√† xu·∫•t block g·∫Øn v√†o prompt.</p>

  <div class="grid">
    <div class="card">
      <h3>Th√¥ng tin nh√¢n v·∫≠t</h3>
      <label>T√™n nh√¢n v·∫≠t
        <input id="charName" placeholder="V√≠ d·ª•: Daisy Girl">
      </label>
      <label>M√¥ t·∫£ (character sheet)
        <textarea id="charSheet" placeholder="female, early 20s, heart-shaped face, big green eyes, long wavy light brown hair, daisy headband, denim top, white tiered skirt, gentle warm vibe"></textarea>
      </label>
      <div class="grid">
        <label>M√†u/palette
          <input id="palette" placeholder="pastel warm, latte brown">
        </label>
        <label>Props (ph·ª• ki·ªán)
          <input id="props" placeholder="latte cup, umbrella">
        </label>
      </div>
      <div class="grid">
        <label>Aspect
          <select id="aspect">
            <option value="1024x1024">1:1 (1024x1024)</option>
            <option value="1792x1024">16:9 (1792x1024)</option>
            <option value="1024x1792">9:16 (1024x1792)</option>
          </select>
        </label>
        <label>Seed (t√πy ch·ªçn)
          <input id="seed" type="number" placeholder="v√≠ d·ª•: 123456">
        </label>
      </div>

      <div class="row">
        <button id="gen">üöÄ T·∫°o 4 view</button>
        <button id="save" class="ghost">üíæ L∆∞u Firebase</button>
        <button id="export" class="ghost">üì¶ Xu·∫•t Character JSON</button>
      </div>
      <p class="small">G·ª£i √Ω: n·∫øu mu·ªën ƒë·ªìng b·ªô gi·ªØa nhi·ªÅu n·ªÅn t·∫£ng, lu√¥n gi·ªØ m√¥ t·∫£ + ph·ª• ki·ªán ƒë·∫∑c tr∆∞ng (v√≠ d·ª•: v√≤ng hoa c√∫c).</p>
    </div>

    <div class="card">
      <h3>Xem tr∆∞·ªõc (Front / Back / Left / Right)</h3>
      <div class="views">
        <div class="thumb" id="v-front">Front</div>
        <div class="thumb" id="v-back">Back</div>
        <div class="thumb" id="v-left">Left</div>
        <div class="thumb" id="v-right">Right</div>
      </div>
      <div class="row" style="margin-top:12px">
        <button id="clear" class="ghost">‚Ü∫ X√≥a preview</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>K·∫øt qu·∫£ / Character Block</h3>
    <pre id="out"></pre>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-storage-compat.js"></script>

<script>
/* ===== 1) Config ===== */
const firebaseConfig = {
  // TODO: d√°n config c·ªßa b·∫°n v√†o ƒë√¢y
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

/* N·∫øu d√πng OpenAI Images l√†m nh√† sinh ·∫£nh: l·∫•y key t·ª´ localStorage (gi·ªëng trang admin c·ªßa b·∫°n) */
const OPENAI_API_KEY = localStorage.getItem("openai_key") || ""; // ho·∫∑c cho nh·∫≠p th·ªß c√¥ng

/* ===== 2) Helper ===== */
const $ = id => document.getElementById(id);
const views = ["front","back","left","right"];
const state = { images: {front:null, back:null, left:null, right:null}, character:null };

function baseSheet(){
  const name = $("charName").value.trim() || "Daisy Girl";
  const sheet = $("charSheet").value.trim() ||
    "female, early 20s, heart-shaped face, big green eyes, long wavy light brown hair, daisy headband, denim top, white tiered skirt, gentle warm vibe";
  const palette = $("palette").value.trim() || "pastel warm, latte brown";
  const props = $("props").value.trim() || "latte cup, umbrella";
  const seed = $("seed").value ? Number($("seed").value) : undefined;
  const aspect = $("aspect").value; // 1024x1024 / 1792x1024 / 1024x1792
  return {name, sheet, palette, props, seed, aspect};
}

function posePrompt(view){
  const viewText = {
    front: "front view, neutral pose, looking at camera",
    back: "back view, neutral pose, hair visible from behind",
    left: "left profile view, neutral pose",
    right:"right profile view, neutral pose"
  }[view];
  const b = baseSheet();
  return `${b.name}, ${b.sheet}, color palette ${b.palette}, props: ${b.props}. `
       + `${viewText}. Studio lighting, plain background, high consistency. 3D cinematic, semi-realistic.`;
}

/* ===== 3) Generate 4 views (OpenAI Images) ===== */
/* B·∫°n c√≥ th·ªÉ thay b·∫±ng Midjourney/SDXL API c·ªßa b·∫°n. */
async function generateOne(view){
  if(!OPENAI_API_KEY){ alert("Thi·∫øu OpenAI API key trong localStorage (openai_key)."); return; }
  const size = baseSheet().aspect; // e.g. "1024x1024"
  const body = {
    model: "gpt-image-1",             // model ·∫£nh c·ªßa OpenAI
    prompt: posePrompt(view),
    size
  };
  const res = await fetch("https://api.openai.com/v1/images/generations", {
    method: "POST",
    headers: {"Content-Type":"application/json","Authorization":"Bearer "+OPENAI_API_KEY},
    body: JSON.stringify(body)
  });
  if(!res.ok){ throw new Error(await res.text()); }
  const data = await res.json();
  const b64 = data.data[0].b64_json;
  const img = new Image();
  img.src = "data:image/png;base64,"+b64;
  await img.decode();
  state.images[view] = img.src;
  $("v-"+view).innerHTML = ""; $("v-"+view).appendChild(img);
}

$("gen").onclick = async ()=>{
  try{
    for(const v of views){ await generateOne(v); }
    state.character = baseSheet();
    $("out").textContent = JSON.stringify(buildCharacterJSON(), null, 2);
  }catch(e){ alert(e.message||e); }
};

$("clear").onclick = ()=>{
  views.forEach(v=>{ $("v-"+v).innerHTML = v.charAt(0).toUpperCase()+v.slice(1); state.images[v]=null; });
  $("out").textContent = "";
};

/* ===== 4) Save to Firebase (Firestore + Storage) ===== */
async function dataURLtoBlob(dataUrl){
  const res = await fetch(dataUrl); return await res.blob();
}
async function uploadImage(docId, view){
  const blob = await dataURLtoBlob(state.images[view]);
  const ref = storage.ref().child(`characters/${docId}/${view}.png`);
  await ref.put(blob);
  return await ref.getDownloadURL();
}

$("save").onclick = async ()=>{
  try{
    const c = baseSheet();
    const docRef = await db.collection("characters").add({
      name: c.name, sheet: c.sheet, palette: c.palette, props: c.props,
      aspect: c.aspect, seed: c.seed || null, createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    const id = docRef.id;
    const urls = {};
    for(const v of views){
      if(!state.images[v]) continue;
      urls[v] = await uploadImage(id, v);
    }
    await docRef.update({reference_images: urls});
    alert("ƒê√£ l∆∞u nh√¢n v·∫≠t: "+id);
    state.character = {...c, id, reference_images: urls};
    $("out").textContent = JSON.stringify(buildCharacterJSON(), null, 2);
  }catch(e){ alert(e.message||e); }
};

/* ===== 5) Export Character Block (d√πng cho MakePrompt, MJ/SDXL/Runway) ===== */
function buildCharacterJSON(){
  const c = state.character || baseSheet();
  const refs = (c.reference_images && (c.reference_images.front || c.reference_images.left))
              ? [c.reference_images.front || c.reference_images.left]
              : [state.images.front, state.images.left].filter(Boolean).slice(0,1);
  return {
    id: c.id || null,
    name: c.name,
    description: `${c.sheet}. Palette: ${c.palette}. Props: ${c.props}.`,
    reference_images: refs,
    aspect: c.aspect,
    seed: c.seed || null,
    prompts: {
      generic: `${c.name}, ${c.sheet}, ${c.palette}, props ${c.props}.`,
      midjourney: `${c.name}, ${c.sheet}, ${c.palette}, props ${c.props}. --ar ${c.aspect==="1792x1024"?"16:9":c.aspect==="1024x1792"?"9:16":"1:1"}`
                 + (refs[0]?` --cref ${refs[0]} --cw 75`:""),
      sdxl: { ip_adapter: refs[0]?0.8:0.0, seed: c.seed || undefined, ref: refs[0] || null },
      openai_hint: refs[0]?`Reference image: ${refs[0]}. Keep face & hair consistent.`:""
    }
  };
}

$("export").onclick = ()=>{
  state.character = baseSheet();
  $("out").textContent = JSON.stringify(buildCharacterJSON(), null, 2);
};
</script>
</body>
</html>
