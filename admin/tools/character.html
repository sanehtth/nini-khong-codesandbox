<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>NiNi ‚Äî T·∫°o nh√¢n v·∫≠t</title>
  <link rel="stylesheet" href="/test/css/nini-theme.css"/>

  <style>
    :root {
      --panel-bg: rgba(255,255,255,.06);
      --panel-br: 14px;
    }
    body{ --bg-url:url('/public/assets/bg/nini_home.webp') }

    .wrap{padding:16px}
    .char-shell{display:grid;grid-template-columns:360px 1fr;gap:16px}
    .char-controls{
      position:sticky; top:84px; align-self:start;
      border-radius:var(--panel-br); background:var(--panel-bg);
      backdrop-filter: blur(6px); padding:14px;
    }
    .char-controls h2{margin:0 0 8px}
    .char-controls label{display:block; font-weight:600; margin-top:10px}
    .char-controls select{width:100%; padding:8px; border-radius:10px; margin-top:6px}
    .actions{margin-top:14px; display:flex; flex-wrap:wrap; gap:8px}
    .actions .btn{border-radius:10px}

    .char-preview .card{
      background:var(--panel-bg); backdrop-filter: blur(6px);
      border-radius:var(--panel-br); padding:14px; margin-bottom:14px;
    }
    .preview-box{display:flex; justify-content:center}
    #charPreview{width:100%; max-width:640px; height:auto; border-radius:12px; background:#0b1220}
    .prompt-card textarea{width:100%; min-height:110px}
    .prompt-card small{opacity:.8}

    .gallery{
      display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:10px
    }
    .thumb{position:relative; border-radius:12px; overflow:hidden; background:#0b1220}
    .thumb img{width:100%; display:block}
    .thumb .pick{position:absolute; right:8px; bottom:8px}

    .muted small{opacity:.8}
    @media (max-width:980px){ .char-shell{grid-template-columns:1fr} .char-controls{position:static} }
  </style>
</head>
<body>
<main class="wrap">
  <section class="panel glass">
    <div class="panel-head">
      <h3 class="title">üß© T·∫°o nh√¢n v·∫≠t</h3>
      <div class="muted">Ch·ªçn thu·ªôc t√≠nh ·ªü c·ªôt tr√°i ‚Üí xem tr∆∞·ªõc t·ª©c th√¨ ·ªü c·ªôt ph·∫£i (kh√¥ng t·ªën AI). Khi ∆∞ng, b·∫•m ‚ÄúT·∫°o ·∫£nh AI‚Äù ƒë·ªÉ render m∆∞·ª£t m√† h∆°n, r·ªìi ‚ÄúL∆∞u‚Äù.</div>
    </div>

    <div class="char-shell">
      <!-- LEFT: controls -->
      <aside class="char-controls">
        <h2>Thu·ªôc t√≠nh</h2>

        <label>Style / H√¨nh th·ªÉ</label>
        <select id="sel-body"></select>

        <label>T√≥c</label>
        <select id="sel-hair"></select>

        <label>M·∫Øt</label>
        <select id="sel-eyes"></select>

        <label>M≈©i</label>
        <select id="sel-nose"></select>

        <label>Mi·ªáng</label>
        <select id="sel-mouth"></select>

        <label>M√†u da</label>
        <select id="sel-skin"></select>

        <label>√Åo (Top)</label>
        <select id="sel-top"></select>

        <label>Qu·∫ßn / V√°y (Bottom)</label>
        <select id="sel-bottom"></select>

        <label>Gi√†y</label>
        <select id="sel-shoes"></select>

        <div class="actions">
          <button id="btn-render" class="btn brand pill">üé® T·∫°o ·∫£nh AI</button>
          <button id="btn-save"   class="btn pill" disabled>üíæ L∆∞u nh√¢n v·∫≠t</button>
          <button id="btn-open-hf" class="btn ghost pill">‚Üó M·ªü Space mi·ªÖn ph√≠</button>
        </div>
        <div class="muted" id="status" style="margin-top:8px"></div>
      </aside>

      <!-- RIGHT: preview + prompt + gallery -->
      <main class="char-preview">
        <div class="card">
          <h4 class="title">üëÄ Xem tr∆∞·ªõc (kh√¥ng AI)</h4>
          <div class="preview-box">
            <canvas id="charPreview" width="768" height="1024"></canvas>
          </div>
          <div class="muted"><small>Tip: H√¨nh xem tr∆∞·ªõc l√† gh√©p layer PNG trong su·ªët theo h·ªá t·ªça ƒë·ªô chu·∫©n. ƒê·ªïi l·ª±a ch·ªçn ·ªü tr√°i l√† th·∫•y ngay.</small></div>
        </div>

        <div class="card prompt-card">
          <h4 class="title">üß© Prompt sinh ra</h4>
          <textarea id="ta-prompt" readonly></textarea>
          <small id="ta-neg"></small>
          <div class="row" style="margin-top:8px">
            <button id="btn-copy" class="btn pill">üìã Copy prompt</button>
          </div>
        </div>

        <div class="card">
          <h4 class="title">üñºÔ∏è K·∫øt qu·∫£ render (AI)</h4>
          <div id="gallery" class="gallery"></div>
          <div class="muted"><small>Ch·ªçn 1 ·∫£nh ƒë·ªÉ b·∫≠t n√∫t ‚ÄúL∆∞u nh√¢n v·∫≠t‚Äù. B·∫•m l·∫°i ‚ÄúT·∫°o ·∫£nh AI‚Äù ƒë·ªÉ t·∫°o th√™m bi·∫øn th·ªÉ.</small></div>
        </div>
      </main>
    </div>
  </section>
</main>

<!-- ====== Catalog demo (text ‚Üî preview image) ====== -->
<script>
/* NOTE: ƒë·ªïi ƒë∆∞·ªùng d·∫´n preview n·∫øu b·∫°n ƒë·ªÉ ·ªü n∆°i kh√°c.
   Khuy·∫øn ngh·ªã: d√πng pack /admin/tools/avatar-pack/ ƒë√£ t·∫°o tr∆∞·ªõc ƒë√≥ */
const PRE = "/admin/tools/avatar-pack"; // root preview (thay n·∫øu c·∫ßn)

const BODY_STYLE = [
  {
    id: "pixar_female_front",
    label: "Pixar ‚Ä¢ N·ªØ ‚Ä¢ ch√≠nh di·ªán",
    promptPose:  "full body, standing, natural hands visible, Pixar body proportion",
    promptStyle: "Pixar style, glossy shading, soft rim light, bright color palette",
    negative:    "deformed, extra fingers, missing fingers, bad hands, warped limbs, watermark, text, logo",
    aspect: "3:4",
    base: `${PRE}/samples/base/pixar_female_front.png`,
    z: 10
  },
  {
    id: "anime_male_front",
    label: "Anime ‚Ä¢ Nam ‚Ä¢ ch√≠nh di·ªán",
    promptPose:  "full body, standing, anime body proportion",
    promptStyle: "anime illustration, clean lineart, cel shading",
    negative:    "lowres, bad hands, watermark, text",
    aspect: "3:4",
    base: `${PRE}/samples/base/anime_male_front.png`,
    z: 10
  },
  {
    id: "chibi_front",
    label: "Chibi ‚Ä¢ ch√≠nh di·ªán",
    promptPose:  "chibi deformed proportion, big head, small body, full body, standing",
    promptStyle: "kawaii pastel color, soft bloom",
    negative:    "lowres, warped limbs, watermark, text",
    aspect: "1:1",
    base: `${PRE}/samples/base/chibi_front.png`,
    z: 10
  }
];

const HAIR = [
  { id:"hair_long_straight", label:"T√≥c d√†i du·ªói", prompt:"long straight hair flowing naturally", preview:`${PRE}/samples/hair/hair_long_straight.png`, z:30 },
  { id:"hair_twin_buns",     label:"B√∫i 2 b√™n",    prompt:"twin buns hair, neat and cute",        preview:`${PRE}/samples/hair/hair_twin_buns.png`,     z:30 },
  { id:"hair_short",         label:"T√≥c ng·∫Øn",     prompt:"short haircut",                        preview:`${PRE}/samples/hair/hair_short.png`,         z:30 },
];

const EYES = [
  { id:"eye_big_sparkle", label:"M·∫Øt to long lanh", prompt:"big sparkling glossy eyes", preview:`${PRE}/samples/eyes/eyes_big.png`,   z:25 },
  { id:"eye_small_cute",  label:"M·∫Øt nh·ªè ƒë√°ng y√™u", prompt:"small cute eyes",           preview:`${PRE}/samples/eyes/eyes_small.png`, z:25 },
];

const NOSE = [
  { id:"nose_small", label:"M≈©i nh·ªè", prompt:"small nose", preview:`${PRE}/samples/nose/nose_small.png`, z:24 },
];

const MOUTH = [
  { id:"mouth_smile", label:"Mi·ªáng m·ªâm c∆∞·ªùi", prompt:"subtle smiling mouth", preview:`${PRE}/samples/mouth/mouth_smile.png`, z:26 },
  { id:"mouth_neutral", label:"Mi·ªáng b√¨nh th∆∞·ªùng", prompt:"neutral mouth", preview:`${PRE}/samples/mouth/mouth_neutral.png`, z:26 },
];

const SKIN = [
  { id:"skin_fair", label:"Da s√°ng", prompt:"fair porcelain skin", preview:`${PRE}/samples/skin/skin_fair.png`, z:15 },
  { id:"skin_tan",  label:"Da n√¢u",  prompt:"warm tan skin",       preview:`${PRE}/samples/skin/skin_tan.png`,  z:15 },
];

const TOP = [
  { id:"top_jacket_green", label:"√Åo kho√°c xanh", prompt:"green jacket", preview:`${PRE}/samples/top/top_jacket_green.png`, z:18 },
  { id:"top_robe_blue",    label:"√Åo cho√†ng xanh", prompt:"blue robe",  preview:`${PRE}/samples/top/top_robe_blue.png`,    z:18 },
];

const BOTTOM = [
  { id:"bottom_skirt_white", label:"V√°y tr·∫Øng", prompt:"white skirt", preview:`${PRE}/samples/bottom/bottom_skirt_white.png`, z:17 },
  { id:"bottom_pants_black", label:"Qu·∫ßn ƒëen",  prompt:"black pants", preview:`${PRE}/samples/bottom/bottom_pants_black.png`, z:17 },
];

const SHOES = [
  { id:"shoes_sneakers", label:"Gi√†y th·ªÉ thao", prompt:"white sneakers", preview:`${PRE}/samples/shoes/shoes_sneakers.png`, z:16 },
  { id:"shoes_boots",    label:"Boots",         prompt:"leather boots",  preview:`${PRE}/samples/shoes/shoes_boots.png`,    z:16 },
];
</script>

<!-- ====== Logic ====== -->
<script>
const $ = s => document.querySelector(s);
const byId = id => document.getElementById(id);

const state = {
  body:null, hair:null, eyes:null, nose:null, mouth:null,
  skin:null, top:null, bottom:null, shoes:null,
};
const gallery = byId('gallery');
const statusEl = byId('status');
let pickedUrl = null;

function mountSelect(id, list, onPick) {
  const sel = byId(id);
  sel.innerHTML = `<option value="">(kh√¥ng ch·ªçn)</option>` +
    list.map(i=>`<option value="${i.id}">${i.label}</option>`).join("");
  sel.addEventListener("change", ()=>{
    const v = sel.value;
    const item = list.find(x=>x.id===v) || null;
    onPick(item);
    renderPreview(); updatePrompt();
  });
}

function loadImage(url){
  return new Promise((res,rej)=>{
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = ()=>res(img);
    img.onerror = ()=>{ console.warn("Preview not found:", url); res(new Image()); };
    img.src = url;
  });
}

async function renderPreview(){
  const canvas = byId("charPreview");
  const ctx = canvas.getContext("2d");
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // fallback n·ªÅn
  ctx.fillStyle = "#0b1220";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  const layers = [
    state.body && {preview: state.body.base, z: state.body.z},
    state.skin, state.bottom, state.shoes, state.top,
    state.eyes, state.nose, state.mouth, state.hair,
  ].filter(Boolean).sort((a,b)=>(a.z||0)-(b.z||0));

  for (const L of layers){
    if (!L.preview) continue;
    const img = await loadImage(L.preview);
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
  }
}

function buildPrompt(){
  const parts = [];
  let negative = "lowres, blurry, watermark, text";
  let aspect = "1:1";

  if (state.body){
    parts.push(state.body.promptPose);
    parts.push(state.body.promptStyle);
    negative = state.body.negative || negative;
    aspect   = state.body.aspect  || aspect;
  }

  [state.hair, state.eyes, state.nose, state.mouth, state.skin, state.top, state.bottom, state.shoes]
    .filter(Boolean)
    .forEach(t => parts.push(t.prompt));

  parts.push("clean composition, correct anatomy, soft lighting, 4k detail");

  return { prompt: parts.join(", "), negative, aspect };
}

function updatePrompt(){
  const {prompt, negative} = buildPrompt();
  byId("ta-prompt").value = prompt;
  byId("ta-neg").textContent = "Negative: " + negative;
}

function addPreviewCard(url){
  const card = document.createElement('div');
  card.className = 'thumb glass';
  card.innerHTML = `<img src="${url}" alt=""><button class="btn pick pill">Ch·ªçn</button>`;
  card.querySelector('.pick').onclick = () => {
    pickedUrl = url;
    [...gallery.children].forEach(c => c.style.outline="");
    card.style.outline = "3px solid var(--brand-4)";
    byId('btn-save').disabled = false;
  };
  gallery.prepend(card);
  // gi·ªØ t·ªëi ƒëa 6 ·∫£nh
  while (gallery.children.length > 6) gallery.lastElementChild.remove();
}

async function onRenderAI(){
  const {prompt, negative, aspect} = buildPrompt();
  if (!state.body) return alert("Ch·ªçn Style/H√¨nh th·ªÉ tr∆∞·ªõc nh√©.");
  statusEl.textContent = "‚è≥ ƒêang render AI...";
  byId('btn-render').disabled = true;

  try {
    // Tu·ª≥ h·∫° t·∫ßng c·ªßa b·∫°n: g·ªçi Netlify function proxy
    // V√≠ d·ª• HuggingFace proxy:
    const r = await fetch("/.netlify/functions/hf-proxy", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        model: "black-forest-labs/FLUX.1.1-pro",
        input: { inputs: prompt, negative_prompt: negative, aspect } // tu·ª≥ model
      })
    });
    const j = await r.json();
    if (!r.ok || j.error) throw new Error(j.error || `HTTP ${r.status}`);

    const url = j.url || (Array.isArray(j.output) ? j.output[0] : null);
    if (!url) throw new Error("Kh√¥ng t√¨m th·∫•y URL ·∫£nh tr·∫£ v·ªÅ.");

    addPreviewCard(url);
    statusEl.textContent = "‚úÖ ƒê√£ render 1 ·∫£nh. B·∫•m l·∫°i ƒë·ªÉ t·∫°o th√™m bi·∫øn th·ªÉ.";
  } catch(err){
    statusEl.textContent = "‚ùå L·ªói render: " + err.message;
  } finally {
    byId('btn-render').disabled = false;
  }
}

async function onSave(){
  if (!pickedUrl) return alert("H√£y ch·ªçn 1 ·∫£nh trong gallery tr∆∞·ªõc.");
  statusEl.textContent = "üíæ ƒêang l∆∞u...";
  byId('btn-save').disabled = true;

  try{
    // V√≠ d·ª•: g·ª≠i ·∫£nh ƒë√£ ch·ªçn + prompt ƒë·ªÉ l∆∞u
    const {prompt} = buildPrompt();
    const r = await fetch("/.netlify/functions/characters-save-image", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        characterId: null,    // ho·∫∑c truy·ªÅn ID n·∫øu b·∫°n mu·ªën ch·ªâ ƒë·ªãnh
        url: pickedUrl,
        prompt,
        provider: "hf",
        model: "black-forest-labs/FLUX.1.1-pro"
      })
    });
    const j = await r.json();
    if (!j.ok) throw new Error(j.error || `HTTP ${r.status}`);

    statusEl.textContent = "‚úÖ L∆∞u th√†nh c√¥ng!";
  }catch(err){
    statusEl.textContent = "‚ùå L·ªói l∆∞u: " + err.message;
  }finally{
    byId('btn-save').disabled = false;
  }
}

function init(){
  // mount selects
  mountSelect("sel-body",   BODY_STYLE, x=>state.body=x);
  mountSelect("sel-hair",   HAIR,       x=>state.hair=x);
  mountSelect("sel-eyes",   EYES,       x=>state.eyes=x);
  mountSelect("sel-nose",   NOSE,       x=>state.nose=x);
  mountSelect("sel-mouth",  MOUTH,      x=>state.mouth=x);
  mountSelect("sel-skin",   SKIN,       x=>state.skin=x);
  mountSelect("sel-top",    TOP,        x=>state.top=x);
  mountSelect("sel-bottom", BOTTOM,     x=>state.bottom=x);
  mountSelect("sel-shoes",  SHOES,      x=>state.shoes=x);

  // init preview + prompt
  renderPreview(); updatePrompt();

  // actions
  byId('btn-render').addEventListener('click', onRenderAI);
  byId('btn-save').addEventListener('click', onSave);
  byId('btn-copy').addEventListener('click', async ()=>{
    await navigator.clipboard.writeText(byId('ta-prompt').value);
  });
  byId('btn-open-hf').addEventListener('click', ()=>{
    // ƒë·ªïi sang Space c·ªßa b·∫°n n·∫øu c√≥
    window.open("https://huggingface.co/spaces?card=gradio", "_blank", "noopener");
  });
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
