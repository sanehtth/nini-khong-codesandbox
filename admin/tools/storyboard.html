<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NiNi ‚Äî AI Story Creator</title>
  <link rel="stylesheet" href="/test/css/nini-theme.css" />
</head>
<body>
<main class="container">
  <h1>üé¨ AI Story Creator</h1>

  <!-- Qu·∫£n tr·ªã ENV t·ª´ UI (tu·ª≥ ch·ªçn) -->
  <div class="card" style="margin-top:12px">
    <h4>üîê C·∫≠p nh·∫≠t API key (kh√¥ng c·∫ßn m·ªü code)</h4>
    <input id="inp-openai" class="input" placeholder="OpenAI API key (sk-...)" />
    <input id="inp-google" class="input" placeholder="Google API key (AIza...)" />
    <input id="inp-grok"   class="input" placeholder="Grok (xAI) API key" />
    <input id="inp-cors"   class="input" placeholder="CORS_ORIGIN (vd https://nini-funny.com)" />
    <button id="btn-save-keys" class="btn">L∆∞u</button>
  </div>

  <section class="panel glass">
    <div class="panel-head">
      <h3 class="title">üß† T·∫°o k·ªãch b·∫£n ‚Ä¢ Storyboard</h3>
      <div class="muted">Nh·∫≠p √Ω t∆∞·ªüng ‚Üí K·ªãch b·∫£n ‚Üí Shotlist 5s ‚Üí Prompt (OpenAI & Google)</div>
    </div>

    <div class="panel-body">
      <!-- Provider + Key -->
      <div class="row" style="gap:10px; margin:8px 0;">
        <label class="muted">Provider</label>
        <select id="provider" class="input" style="max-width:180px">
          <option value="openai">OpenAI</option>
          <option value="grok">Grok (xAI)</option>
        </select>
        <button id="btn-set-key" class="btn sm">Nh·∫≠p/ƒê·ªïi API key</button>
        <span id="key-status" class="muted badge"></span>
      </div>

      <div class="grid-2">
        <!-- C·ªòT TR√ÅI -->
        <div>
          <h4 class="mb-1">√ù t∆∞·ªüng</h4>
          <textarea id="idea" rows="7" class="input w-100" placeholder="G√µ brief/√Ω t∆∞·ªüng t·∫°i ƒë√¢y‚Ä¶"></textarea>

          <div class="row mt-1" style="gap:10px;">
            <label class="muted">Th·ªùi l∆∞·ª£ng (ph√∫t)</label>
            <input id="duration" type="number" value="3.5" step="0.5" class="input" style="max-width:110px">
            <button id="btn-script" class="btn">üß† T·∫°o k·ªãch b·∫£n</button>
          </div>

          <h4 class="mt-2">K·ªãch b·∫£n</h4>
          <pre id="script" class="card output" style="min-height:120px;"></pre>

          <div class="row mt-1" style="gap:10px;">
            <button id="btn-shotlist" class="btn">üéû T·∫°o shotlist 5s/c·∫£nh</button>
            <span class="muted badge">G·ª£i √Ω: qu√°n cafe ·∫•m ‚Äì c·∫£nh m∆∞a xanh l·∫°nh</span>
          </div>

          <h4 class="mt-1">Shotlist</h4>
          <pre id="shotlist" class="card output" style="min-height:160px;"></pre>

          <div class="row mt-1" style="gap:10px;">
            <button id="btn-both" class="btn">‚ú® Sinh prompt cho C·∫¢ HAI (OpenAI & Google)</button>
          </div>
        </div>

        <!-- C·ªòT PH·∫¢I -->
        <div>
          <h4>OpenAI (DALL¬∑E/Stable)</h4>
          <button id="copy-openai" class="btn sm">Copy</button>
          <pre id="both-openai" class="card output" style="min-height:180px;"></pre>

          <h4 class="mt-2">Google (Imagen/Gemini)</h4>
          <button id="copy-gemini" class="btn sm">Copy</button>
          <pre id="both-gemini" class="card output" style="min-height:180px;"></pre>

          <div class="row mt-1" style="gap:10px;">
            <button id="export-json" class="btn sm">Export JSON</button>
            <button id="export-csv" class="btn sm">Export CSV</button>
            <span class="muted">Nh√£n trong prompt: <b>OPENAI::</b> / <b>GOOGLE::</b></span>
          </div>
        </div>
      </div>
    </div>
  </section>

<script>
/* ===== Admin update-env (tu·ª≥ ch·ªçn) ===== */
document.getElementById('btn-save-keys').onclick = async () => {
  const openaiKey = document.getElementById('inp-openai').value.trim();
  const googleKey = document.getElementById('inp-google').value.trim();
  const grokKey   = document.getElementById('inp-grok').value.trim();
  const corsOrigin= document.getElementById('inp-cors').value.trim();
  const token = prompt('Nh·∫≠p ADMIN_TOKEN ƒë·ªÉ x√°c th·ª±c:');
  const r = await fetch('/admin/update-env', {
    method: 'POST',
    headers: {'Content-Type':'application/json','x-admin-token': token},
    body: JSON.stringify({ openaiKey, googleKey, grokKey, corsOrigin })
  });
  const j = await r.json();
  alert(j.ok ? '‚úÖ ' + j.message : '‚ùå ' + j.error);
};

/* ===== Helpers UI ===== */
const $ = (s, p=document) => p.querySelector(s);
const toast = (msg, type='info') => alert((type==='error'?'‚ùå ':'‚úÖ ') + msg);
const copyToClipboard = (t,m) => t.trim() && navigator.clipboard.writeText(t).then(()=>toast(m));
const download = (filename, data, mime='text/plain') => {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([data], {type:mime}));
  a.download = filename; a.click();
};

/* ======= Provider + key l∆∞u LocalStorage ======= */
function getProvider(){ return (document.getElementById('provider')?.value || 'openai'); }
function keyName(p){ return p === 'grok' ? 'GROK_USER_KEY' : 'OPENAI_USER_KEY'; }

function ensureUserKey(provider){
  const name = keyName(provider);
  let k = localStorage.getItem(name);
  if (!k) {
    const label = provider === 'grok' ? 'Grok (xAI) API Key' : 'OpenAI API Key (sk-...)';
    k = prompt(`D√°n ${label}:`);
    if (k) localStorage.setItem(name, k.trim());
  }
  updateKeyStatus();
  return k;
}

function updateKeyStatus(){
  const p = getProvider();
  const has = !!localStorage.getItem(keyName(p));
  $('#key-status').textContent = has ? `ƒê√£ c√≥ key cho ${p.toUpperCase()}` : `Ch∆∞a c√≥ key cho ${p.toUpperCase()}`;
}

document.getElementById('provider').onchange = updateKeyStatus;
document.getElementById('btn-set-key').onclick = () => {
  const p = getProvider();
  localStorage.removeItem(keyName(p));
  ensureUserKey(p);
};

/* ======= API helper: g·ª≠i x-provider + key t∆∞∆°ng ·ª©ng ======= */
async function api(path, body){
  const provider = getProvider();
  const key = ensureUserKey(provider); // n·∫øu mu·ªën cho ph√©p fallback ENV, c√≥ th·ªÉ cho Cancel
  const headers = { 'Content-Type': 'application/json', 'x-provider': provider };
  if (provider === 'grok' && key) headers['x-grok-key'] = key;
  if (provider === 'openai' && key) headers['x-openai-key'] = key;

  const res = await fetch(path, { method:'POST', headers, body: JSON.stringify(body||{}) });
  return res.json();
}

/* ===== H√†nh vi c√°c n√∫t ===== */
$('#btn-script').onclick = async () => {
  const ideaText = $('#idea').value.trim();
  if (!ideaText) return toast('Vui l√≤ng nh·∫≠p √Ω t∆∞·ªüng.');
  const j = await api('/api/script', { ideaText });
  if (j.error) return toast(j.error,'error');
  $('#script').textContent = j.script || '';
};

$('#btn-shotlist').onclick = async () => {
  const script = $('#script').textContent.trim();
  if (!script) return toast('Ch∆∞a c√≥ k·ªãch b·∫£n.');
  const durationMinutes = parseFloat($('#duration').value || '3.5');
  const j = await api('/api/shotlist', { script, durationMinutes });
  if (j.error) return toast(j.error,'error');
  $('#shotlist').textContent = j.shotlist || '';
};

$('#btn-both').onclick = async () => {
  const shotlist = $('#shotlist').textContent.trim();
  if (!shotlist) return toast('Ch∆∞a c√≥ shotlist.');
  const options = {
    artistic:false, realistic:true, documentary:false, surreal:false,
    cinematicLevel:3, detailLevel:3, warmth:3, mood:'romantic',
    language:'vi', lensTerms:true, naturalTone:true
  };
  const j = await api('/api/prompts/both', { shotlist, options });
  if (j.error) return toast(j.error,'error');

  try {
    const arr = typeof j.promptsBoth === 'string' ? JSON.parse(j.promptsBoth) : j.promptsBoth;
    const openai = [], google = [];
    arr.forEach(o=>{
      openai.push(`[C·∫£nh ${o.scene}${o.timecode? ' '+o.timecode:''}]\n${o.openai.prompt}\n‚Äî Notes: ${o.openai.notes.compat}`);
      google.push(`[C·∫£nh ${o.scene}${o.timecode? ' '+o.timecode:''}]\n${o.google.prompt}\n‚Äî Notes: ${o.google.notes.compat}`);
    });
    $('#both-openai').textContent = openai.join('\n\n');
    $('#both-gemini').textContent = google.join('\n\n');
    window._PROMPTS_JSON = arr;
  } catch(e){
    const raw = (j.promptsBoth||'').toString();
    $('#both-openai').textContent = raw;
    $('#both-gemini').textContent = raw;
  }
};

$('#copy-openai').onclick = () => copyToClipboard($('#both-openai').textContent, 'ƒê√£ copy OpenAI prompts');
$('#copy-gemini').onclick = () => copyToClipboard($('#both-gemini').textContent, 'ƒê√£ copy Gemini prompts');

$('#export-json').onclick = () => {
  if (!window._PROMPTS_JSON) return toast('Ch∆∞a c√≥ d·ªØ li·ªáu.');
  download('prompts_both.json', JSON.stringify(window._PROMPTS_JSON, null, 2), 'application/json');
};
$('#export-csv').onclick = () => {
  if (!window._PROMPTS_JSON) return toast('Ch∆∞a c√≥ d·ªØ li·ªáu.');
  const rows = [['scene','timecode','provider','prompt','compat']];
  window._PROMPTS_JSON.forEach(o=>{
    rows.push([o.scene, o.timecode||'', 'OPENAI', o.openai.prompt, o.openai.notes.compat]);
    rows.push([o.scene, o.timecode||'', 'GOOGLE', o.google.prompt, o.google.notes.compat]);
  });
  const csv = rows.map(r=>r.map(x=>`"${(x||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  download('prompts_both.csv', csv, 'text/csv');
};

updateKeyStatus();
</script>

</main>
</body>
</html>
