<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NiNi — Xử lý liên kết</title>
  <link rel="icon" href="/public/assets/icons/logonini.webp" type="image/webp" />
  <link rel="stylesheet" href="/styles.css?v=auth1" />
</head>
<body>
  <header class="site-header">
    <a class="brand" href="/#home">
      <img class="brand__logo" src="/public/assets/icons/logo_text.webp" alt="NiNi — Funny" />
      <span class="brand__slogan">Chơi mê ly, bứt phá tư duy</span>
    </a>
  </header>

  <main class="viewport" style="display:grid;place-items:center;min-height:calc(100vh - 80px);">
    <section class="modal__panel" style="position:static;max-width:560px;">
      <h3 class="modal__title">
        <img class="modal__logo" src="/public/assets/icons/logonini.webp" alt=""/> Xác minh / Đặt lại mật khẩu
      </h3>

      <!-- Khối kết quả chung -->
      <div id="box-msg" class="note" style="margin:10px 0;"></div>

      <!-- Khối đặt mật khẩu (chỉ hiện khi mode=resetPassword) -->
      <form id="form-reset" class="form" onsubmit="return false;" style="display:none;">
        <label for="pwd">Mật khẩu mới</label>
        <input id="pwd" class="input underline" type="password" placeholder="≥ 8 ký tự" autocomplete="new-password">
        <div style="margin-top:12px;display:flex;gap:10px;justify-content:flex-end">
          <button id="btn-reset" class="btn solid">Đổi mật khẩu</button>
          <a class="btn" href="/#home">Về trang chủ</a>
        </div>
        <p id="reset-note" class="note"></p>
      </form>

      <!-- Nút quay lại khi verify xong -->
      <div id="box-actions" style="display:none;margin-top:12px;display:flex;gap:10px;justify-content:flex-end">
        <a class="btn" href="/#home">Về trang chủ</a>
        <a class="btn" href="/#home" onclick="localStorage.setItem('NINI_AUTH_LOGGED_IN','0')">Đăng nhập</a>
      </div>
    </section>
  </main>

  <script type="module">
import { getAuth, applyActionCode, isSignInWithEmailLink, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

const app = initializeApp({ /* your firebase config */ });
const auth = getAuth(app);

const url = new URL(location.href);
const mode = url.searchParams.get('mode');
const oobCode = url.searchParams.get('oobCode');
const email = url.searchParams.get('email');
const next = url.searchParams.get('next'); // "reset"

async function handle() {
  if (mode === 'verifyEmail' && oobCode) {
    try {
      await applyActionCode(auth, oobCode); // xác minh email thành công
      // Tùy chọn: thông báo "Đã xác minh!"
      if (next === 'reset' && email) {
        await sendPasswordResetEmail(auth, email);
        // chuyển thẳng tới trang đặt mật khẩu
        location.href = `/reset-password.html?email=${encodeURIComponent(email)}`;
        return;
      }
      // Nếu không muốn chuyển trang:
      // render UI của bạn ở đây
    } catch (e) {
      console.error('verify error', e);
      // hiện thông báo lỗi
    }
  } else if (mode === 'resetPassword') {
    // trang này nếu bạn dùng link reset trực tiếp
    // ...
  }
}
handle();
</script>

</body>
</html>

