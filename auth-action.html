<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NiNi — Xử lý liên kết</title>
  <link rel="icon" href="/public/assets/icons/logonini.webp" type="image/webp" />
  <link rel="stylesheet" href="/styles.css?v=auth1" />
</head>
<body>
  <header class="site-header">
    <a class="brand" href="/#home">
      <img class="brand__logo" src="/public/assets/icons/logo_text.webp" alt="NiNi — Funny" />
      <span class="brand__slogan">Chơi mê ly, bứt phá tư duy</span>
    </a>
  </header>

  <main class="viewport" style="display:grid;place-items:center;min-height:calc(100vh - 80px);">
    <section class="modal__panel" style="position:static;max-width:560px;">
      <h3 class="modal__title">
        <img class="modal__logo" src="/public/assets/icons/logonini.webp" alt=""/> Xác minh / Đặt lại mật khẩu
      </h3>

      <!-- Khối kết quả chung -->
      <div id="box-msg" class="note" style="margin:10px 0;"></div>

      <!-- Khối đặt mật khẩu (chỉ hiện khi mode=resetPassword) -->
      <form id="form-reset" class="form" onsubmit="return false;" style="display:none;">
        <label for="pwd">Mật khẩu mới</label>
        <input id="pwd" class="input underline" type="password" placeholder="≥ 8 ký tự" autocomplete="new-password">
        <div style="margin-top:12px;display:flex;gap:10px;justify-content:flex-end">
          <button id="btn-reset" class="btn solid">Đổi mật khẩu</button>
          <a class="btn" href="/#home">Về trang chủ</a>
        </div>
        <p id="reset-note" class="note"></p>
      </form>

      <!-- Nút quay lại khi verify xong -->
      <div id="box-actions" style="display:none;margin-top:12px;display:flex;gap:10px;justify-content:flex-end">
        <a class="btn" href="/#home">Về trang chủ</a>
        <a class="btn" href="/#home" onclick="localStorage.setItem('NINI_AUTH_LOGGED_IN','0')">Đăng nhập</a>
      </div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth, applyActionCode, verifyPasswordResetCode, confirmPasswordReset
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // --- Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyBdaMS7aI03wHLhi1Md2QDitJFkA61IYUU",
      authDomain: "nini-8f3d4.firebaseapp.com",
      projectId: "nini-8f3d4",
      storageBucket: "nini-8f3d4.firebasestorage.app",
      messagingSenderId: "991701821645",
      appId: "1:991701821645:web:fb21c357562c6c801da184"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // --- Helpers UI ---
    const $ = (id)=>document.getElementById(id);
    const boxMsg = $("box-msg");
    const resetForm = $("form-reset");
    const resetNote = $("reset-note");
    const btnReset = $("btn-reset");
    const pwd = $("pwd");
    const boxActions = $("box-actions");

    const note = (el,msg,ok=true)=>{ if(!el) return; el.textContent = msg||""; el.classList.toggle("ok",ok); el.classList.toggle("err",!ok); };
    const params = new URLSearchParams(location.search);
    const mode = params.get("mode");
    const oob = params.get("oobCode");

    // --- Router theo mode ---
    (async () => {
      if (!oob || !mode) {
        note(boxMsg, "Liên kết không hợp lệ (thiếu tham số).", false);
        boxActions.style.display = "flex";
        return;
      }

      try {
        if (mode === "verifyEmail") {
          note(boxMsg, "Đang xác minh email…");
          await applyActionCode(auth, oob);
          note(boxMsg, "Xác minh email thành công. Bạn có thể đăng nhập!", true);
          boxActions.style.display = "flex";
        }
        else if (mode === "resetPassword") {
          // Kiểm tra mã trước khi hiển thị form
          await verifyPasswordResetCode(auth, oob);
          note(boxMsg, "Vui lòng đặt mật khẩu mới cho tài khoản.", true);
          resetForm.style.display = "block";

          btnReset.onclick = async () => {
            const p = (pwd.value||"").trim();
            if (p.length < 8) { note(resetNote, "Mật khẩu phải ≥ 8 ký tự.", false); return; }
            btnReset.disabled = true; note(resetNote, "Đang đổi mật khẩu…", true);
            try {
              await confirmPasswordReset(auth, oob, p);
              note(resetNote, "Đổi mật khẩu thành công. Bạn có thể đăng nhập lại!", true);
              boxActions.style.display = "flex";
            } catch (e) {
              note(resetNote, e?.code || e?.message || "Không đổi được mật khẩu.", false);
              btnReset.disabled = false;
            }
          };
        }
        else {
          note(boxMsg, "Chưa hỗ trợ hành động này.", false);
          boxActions.style.display = "flex";
        }
      } catch (e) {
        note(boxMsg, e?.code || e?.message || "Liên kết không hợp lệ hoặc đã hết hạn.", false);
        boxActions.style.display = "flex";
      }
    })();
  </script>
</body>
</html>
