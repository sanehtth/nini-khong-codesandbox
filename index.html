<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NiNi — Funny</title>

  <!-- ====== CSS chung của site (bạn đã có) ====== -->
  <link rel="stylesheet" href="/test/css/base.css">
  <link rel="stylesheet" href="/test/css/footecrss.css">
  <link rel="stylesheet" href="/test/css/header-tab.css">
  <!-- (nếu bạn dùng theme boot, cứ giữ nguyên) -->
  <script src="/test/js/theme-boot.js" defer></script>

  <!-- ====== CSS nhỏ cho sidebar + subnav (chỉ thêm mới) ====== -->
  <style>
    :root{
      --glass-bg: rgba(255,255,255,.10);
      --glass-border: rgba(255,255,255,.25);
      --blur: blur(8px);
      --round: 16px;
      --round-lg: 22px;
      --brand:#2bdc8c;
    }
    body{ min-height:100dvh; background:#0b1407; }
    /* khung tổng: sidebar (60px) + subnav (280px) + content (flex) */
    .shell{
      display:grid;
      grid-template-columns: 64px 0px 1fr;
      gap:14px;
      width: min(1180px, 92vw);
      margin: 12px auto 60px;
      transition: grid-template-columns .25s ease;
    }
    .shell.with-subnav{ grid-template-columns: 64px 280px 1fr; }

    /* ===== HEADER ===== */
    #nini_header{
      width: min(1180px, 92vw);
      margin: 18px auto 8px;
    }
    .nini-header{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 14px;
      border:1px solid var(--glass-border);
      background:var(--glass-bg); backdrop-filter:var(--blur);
      border-radius: var(--round-lg);
    }
    .brand{ display:flex; align-items:center; gap:12px; }
    .brand .logo{
      width:48px; height:32px; background:url("/public/assets/icons/logonini.svg") center/contain no-repeat;
    }
    .brand .slogan{ font-weight:700; color:#fff; opacity:.9; }

    .tabs{ display:flex; gap:12px; }
    .tab{
      padding:8px 12px; border-radius:999px; border:1px solid var(--glass-border);
      background:var(--glass-bg); color:#fff; font-weight:600; cursor:pointer;
    }
    .tab.active{ outline:2px solid #fff3; }

    .userbar{ display:flex; align-items:center; gap:8px; }
    .ava{ width:28px; height:28px; border-radius:50%;
      display:grid; place-items:center; font-weight:800;
      background:#fff; color:#222;
      background-size:cover; background-position:center;
    }
    .user-name{ color:#fff; font-size:13px; opacity:.9; }
    .btn{ padding:8px 12px; border-radius:999px; border:1px solid var(--glass-border);
      background:var(--glass-bg); color:#fff; font-weight:600; cursor:pointer;
    }

    /* ===== SIDEBAR (cột icon) ===== */
    .sidebar{
      border:1px solid var(--glass-border);
      background:var(--glass-bg); backdrop-filter:var(--blur);
      border-radius: var(--round);
      padding:10px 6px;
      display:flex; flex-direction:column; gap:8px;
      position:sticky; top:12px; height:fit-content;
    }
    .sidebtn{
      display:grid; place-items:center; padding:8px; border-radius:12px;
      border:1px solid transparent; cursor:pointer; color:#fff;
    }
    .sidebtn.active{ border-color:var(--glass-border); background:rgba(255,255,255,.08); }
    .sidebtn img{ width:22px; height:22px; opacity:.95; }

    /* ===== SUBNAV (cột danh sách sách) ===== */
    .subnav{
      border:1px solid var(--glass-border);
      background:var(--glass-bg); backdrop-filter:var(--blur);
      border-radius: var(--round);
      padding:10px;
      min-height:240px;
    }
    .subnav h3{ color:#fff; opacity:.9; margin:4px 6px 10px; }
    .book{ display:flex; align-items:center; gap:10px;
      padding:8px; border-radius:12px; cursor:pointer; color:#fff;
      border:1px solid transparent;
    }
    .book:hover{ border-color:var(--glass-border); background:rgba(255,255,255,.06); }
    .book img{ width:28px; height:28px; border-radius:6px; object-fit:cover; }

    /* ===== STAGE (khung chính) ===== */
    .stage{
      border:1px solid var(--glass-border);
      background:var(--glass-bg); backdrop-filter:var(--blur);
      border-radius: var(--round-lg);
      padding:14px;
      min-height: 460px;
    }
    .stage h2{ color:#fff; opacity:.9; }
    .grid-cards{
      display:grid; grid-template-columns: repeat(3, 1fr);
      gap:12px; margin-top:10px;
    }
    .card{
      border:1px solid var(--glass-border);
      background:rgba(255,255,255,.06);
      border-radius:16px; padding:12px; color:#fff;
    }
    .card h4{ margin:6px 0 8px; }
    .card .meta{ opacity:.75; font-size:13px; }
    .card .actions{ margin-top:8px; display:flex; gap:8px; }
    .pill{ padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.1); border:1px solid var(--glass-border); }

    /* ===== AUTH MODAL (kính mờ, dùng class chung) ===== */
    .modal{ position:fixed; inset:0; display:none; place-items:center; z-index:50; }
    .modal.show{ display:grid; }
    .modal .backdrop{ position:absolute; inset:0; backdrop-filter:blur(2px); }
    .modal .box{
      position:relative;
      width:min(560px, 92vw);
      border:1px solid var(--glass-border); background:var(--glass-bg); backdrop-filter:var(--blur);
      border-radius:18px; padding:14px;
    }
    .mod-tabs{ display:flex; gap:8px; margin-bottom:8px; }
    .mod-tabs .pill{ cursor:pointer; }
    .mod-tabs .pill.active{ outline:2px solid #fff3; }
    .row{ display:flex; flex-direction:column; gap:6px; margin:10px 0; }
    input[type="email"],input[type="password"]{
      width:100%; padding:10px 12px; border-radius:12px;
      border:1px solid var(--glass-border); background:rgba(255,255,255,.08); color:#fff;
    }
    .box .actions{ display:flex; gap:8px; align-items:center; justify-content:space-between; }
    .msg{ margin-top:6px; font-weight:600; }
    .msg.err{ color:#ffb3b3; } .msg.ok{ color:#b6ffcf; }
    .menu{
      position:absolute; right:0; top:calc(100% + 6px);
      min-width:180px; border:1px solid var(--glass-border);
      background:var(--glass-bg); backdrop-filter:var(--blur);
      border-radius:14px; padding:8px; display:none;
    }
    .menu .item{ color:#fff; padding:8px; border-radius:10px; cursor:pointer; }
    .menu .item:hover{ background:rgba(255,255,255,.08); }
  </style>
</head>
<body class="theme-spring home">

  <!-- ===== HEADER ===== -->
  <header id="nini_header">
    <div class="nini-header">
      <div class="brand">
        <a class="logo" href="#/home" title="NiNi — Funny"></a>
        <span class="slogan">chơi mê ly, bứt phá tư duy</span>
      </div>

      <nav class="tabs">
        <a class="tab" data-topnav="intro" href="#/home">Giới thiệu</a>
        <a class="tab" data-topnav="rules" href="#/rules">Luật chơi</a>
        <a class="tab" data-topnav="forum" href="#/forum">Diễn đàn</a>
        <a class="tab" data-topnav="feedback" href="#/feedback">Góp ý</a>
      </nav>

      <div class="userbar">
        <button id="btnAuthOpen" class="btn">Đăng nhập</button>
        <div id="userWrap" style="position:relative; display:none">
          <button id="btnAvatar" class="ava" title="Tài khoản"></button>
          <span id="userName" class="user-name"></span>
          <div id="userMenu" class="menu">
            <div class="item" id="goProfile">Hồ sơ</div>
            <div class="item" id="btnSignOut">Đăng xuất</div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- ===== LAYOUT: sidebar + subnav + stage ===== -->
  <main id="app" class="shell">
    <!-- Sidebar icons -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebtn" data-route="storybook" title="Storybook"><img src="/public/assets/icons/ico-book.svg" alt=""></div>
      <div class="sidebtn" data-route="video"     title="Video"><img src="/public/assets/icons/ico-video.svg" alt=""></div>
      <div class="sidebtn" data-route="game"      title="Game"><img src="/public/assets/icons/ico-game.svg" alt=""></div>
      <div class="sidebtn active" data-route="shop"      title="Shop"><img src="/public/assets/icons/ico-shop.svg" alt=""></div>
    </aside>

    <!-- Subnav (ẩn/hiện tùy màn) -->
    <aside id="subnav" class="subnav" style="display:none"></aside>

    <!-- Content stage -->
    <section id="stage" class="stage">
      <!-- nội dung sẽ thay theo route -->
    </section>
  </main>

  <!-- ===== AUTH MODAL ===== -->
  <div id="authModal" class="modal" aria-hidden="true">
    <div class="backdrop"></div>
    <div class="box">
      <div class="mod-tabs">
        <div class="pill active" data-auth-tab="login">Đăng nhập</div>
        <div class="pill" data-auth-tab="signup">Đăng ký</div>
        <div class="pill" data-auth-tab="reset">Quên mật khẩu</div>
        <div style="margin-left:auto"><button id="btnCloseAuth" class="btn">Đóng</button></div>
      </div>

      <!-- Login -->
      <form id="formLogin" class="auth-form" data-tab="login">
        <div class="row">
          <label>Email</label>
          <input id="loginEmail" type="email" autocomplete="email" placeholder="you@example.com" />
        </div>
        <div class="row">
          <label>Mật khẩu</label>
          <input id="loginPass" type="password" autocomplete="current-password" placeholder="••••••••" />
        </div>
        <div class="actions">
          <button type="submit" class="btn">Đăng nhập</button>
          <button type="button" id="btnGoogle" class="btn">Đăng nhập Google</button>
        </div>
      </form>

      <!-- Signup (email only) -->
      <form id="formSignup" class="auth-form" data-tab="signup" style="display:none">
        <div class="row">
          <label>Email</label>
          <input id="signupEmail" type="email" autocomplete="email" placeholder="you@example.com" />
        </div>
        <div class="actions">
          <button type="submit" class="btn">Gửi mail xác minh</button>
        </div>
      </form>

      <!-- Reset password -->
      <form id="formReset" class="auth-form" data-tab="reset" style="display:none">
        <div class="row">
          <label>Email</label>
          <input id="resetEmail" type="email" autocomplete="email" placeholder="you@example.com" />
        </div>
        <div class="actions">
          <button type="submit" class="btn">Gửi link đặt lại mật khẩu</button>
        </div>
      </form>

      <div id="authMsg" class="msg"></div>
    </div>
  </div>

  <!-- ===== JS: router + auth glue + header toggle ===== -->
  <script>
    (function(){
      const N = (window.NINI = window.NINI || {});
      const $ = (s, r=document)=>r.querySelector(s);
      const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));

      /* ---------------- ROUTER ---------------- */
      const stage = $('#stage');
      const subnav = $('#subnav');
      const shell = $('#app');

      function renderShop(){
        subnav.style.display = 'none';
        shell.classList.remove('with-subnav');
        stage.innerHTML = `
          <h2>Shop</h2>
          <div class="grid-cards">
            <article class="card">
              <h4>Sticker NiNi</h4>
              <div class="meta">Bộ 20 sticker dễ thương.</div>
              <div class="actions"><button class="pill">Xem</button></div>
            </article>
            <article class="card">
              <h4>Sổ tay giải đố</h4>
              <div class="meta">100 thử thách tư duy.</div>
              <div class="actions"><button class="pill">Xem</button></div>
            </article>
            <article class="card">
              <h4>Áo thun NiNi</h4>
              <div class="meta">Cotton mềm, unisex.</div>
              <div class="actions"><button class="pill">Xem</button></div>
            </article>
          </div>
        `;
      }

      function renderVideo(){
        subnav.style.display = 'none';
        shell.classList.remove('with-subnav');
        stage.innerHTML = `
          <h2>Video</h2>
          <div class="grid-cards">
            <article class="card"><h4>Chuỗi 1</h4><div class="meta">Các mẹo tư duy nhanh</div></article>
            <article class="card"><h4>Chuỗi 2</h4><div class="meta">Giải đố cùng NiNi</div></article>
            <article class="card"><h4>Chuỗi 3</h4><div class="meta">Kể chuyện tương tác</div></article>
          </div>
        `;
      }

      function renderGame(){
        subnav.style.display = 'none';
        shell.classList.remove('with-subnav');
        stage.innerHTML = `
          <h2>Game</h2>
          <div class="grid-cards">
            <article class="card"><h4>Ghép hình</h4><div class="actions"><button class="pill">Chơi</button></div></article>
            <article class="card"><h4>Đố chữ</h4><div class="actions"><button class="pill">Chơi</button></div></article>
            <article class="card"><h4>Tìm kho báu</h4><div class="actions"><button class="pill">Chơi</button></div></article>
          </div>
        `;
      }

      // Storybook: hiện subnav danh sách sách
      const BOOKS = [
        {id:'b1', title:'Bé NiNi & khu rừng', cover:'/public/assets/covers/forest.jpg'},
        {id:'b2', title:'Cuộc đua sắc màu', cover:'/public/assets/covers/colors.jpg'},
        {id:'b3', title:'Bạn mới của NiNi', cover:'/public/assets/covers/friends.jpg'},
      ];
      function renderStorybook(bookId){
        // subnav list
        subnav.innerHTML = `
          <h3>Thư viện</h3>
          ${BOOKS.map(b=>`
            <div class="book" data-book="${b.id}">
              <img src="${b.cover}" alt="">
              <div>${b.title}</div>
            </div>`).join('')}
        `;
        subnav.style.display='block';
        shell.classList.add('with-subnav');

        // content
        const cur = BOOKS.find(b=>b.id===bookId) || BOOKS[0];
        stage.innerHTML = `
          <h2>${cur.title}</h2>
          <div class="card" style="margin-top:12px">
            <div class="meta">Trang đọc thử • nội dung demo hiển thị ở đây.</div>
            <div class="actions" style="margin-top:10px">
              <button class="pill">Đọc từ đầu</button>
              <button class="pill">Tiếp tục</button>
            </div>
          </div>
        `;
      }

      function applyRoute(){
        const hash = location.hash || '#/shop';
        $$('.sidebtn').forEach(x=>x.classList.toggle('active', hash.includes(x.dataset.route)));

        if (hash.startsWith('#/storybook')) {
          const id = new URLSearchParams(hash.split('?')[1]||'').get('id');
          renderStorybook(id);
        } else if (hash.startsWith('#/video')) {
          renderVideo();
        } else if (hash.startsWith('#/game')) {
          renderGame();
        } else {
          renderShop();
        }
      }

      // click sidebar
      $('#sidebar').addEventListener('click', (e)=>{
        const btn = e.target.closest('.sidebtn'); if(!btn) return;
        const route = btn.dataset.route;
        if (route==='storybook') location.hash = '#/storybook';
        else if (route==='video') location.hash = '#/video';
        else if (route==='game') location.hash = '#/game';
        else location.hash = '#/shop';
      });

      // click subnav -> load sách
      subnav.addEventListener('click', (e)=>{
        const item = e.target.closest('[data-book]');
        if(!item) return;
        const id = item.getAttribute('data-book');
        location.hash = '#/storybook?id='+id;
      });

      window.addEventListener('hashchange', applyRoute);
      applyRoute();

      /* ---------------- AUTH MODAL + HEADER TOGGLE ---------------- */
      const modal = $('#authModal');
      const authMsg = $('#authMsg');

      function openAuth(tab='login'){
        modal.classList.add('show'); modal.setAttribute('aria-hidden','false');
        switchTab(tab);
      }
      function closeAuth(){
        modal.classList.remove('show'); modal.setAttribute('aria-hidden','true');
        authMsg.textContent = ''; authMsg.className='msg';
      }

      // switch tab
      function switchTab(name){
        $$('.mod-tabs .pill').forEach(p=>p.classList.toggle('active', p.dataset.authTab===name));
        $$('.auth-form').forEach(f=>f.style.display = (f.dataset.tab===name)?'block':'none');
      }

      $('#btnAuthOpen').addEventListener('click', ()=>openAuth('login'));
      $('#btnCloseAuth').addEventListener('click', closeAuth);
      $('.mod-tabs').addEventListener('click', (e)=>{
        const t = e.target.closest('[data-auth-tab]'); if(!t) return;
        switchTab(t.dataset.authTab);
      });

      // Avatar menu (đã đăng nhập)
      const userWrap = $('#userWrap');
      const userMenu = $('#userMenu');
      $('#btnAvatar').addEventListener('click', ()=>{
        userMenu.style.display = (userMenu.style.display==='block'?'none':'block');
      });
      document.addEventListener('click', (e)=>{
        if (!e.target.closest('#userWrap')) userMenu.style.display='none';
      });
      $('#goProfile').addEventListener('click', ()=>{ location.href = '/profile.html'; });

      // ---- Helpers UI
      function setAuthMsg(type,text){ authMsg.className='msg '+(type||''); authMsg.textContent=text||''; }
      function fillAvatar(u){
        const btnAva = $('#btnAvatar');
        const name = u.displayName || (u.email?u.email.split('@')[0]:'NiNi');
        $('#userName').textContent = name;
        const letter = name.trim()[0]?.toUpperCase?.() || 'N';
        if (u.photoURL){
          btnAva.style.backgroundImage = `url("${u.photoURL}")`;
          btnAva.textContent = '';
        } else {
          btnAva.style.backgroundImage = '';
          btnAva.textContent = letter;
        }
      }
      function toggleSignedIn(user){
        if (user){
          $('#btnAuthOpen').style.display='none';
          userWrap.style.display='inline-flex';
          fillAvatar(user);
        }else{
          userWrap.style.display='none';
          $('#btnAuthOpen').style.display='inline-flex';
        }
      }

      // ---- Wire auth to NINI.fb
      function FB(){ return (window.NINI && window.NINI.fb) || {}; }

      // login
      $('#formLogin').addEventListener('submit', async (e)=>{
        e.preventDefault();
        try{
          const email = $('#loginEmail').value.trim();
          const pass  = $('#loginPass').value.trim();
          if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { setAuthMsg('err','Email chưa đúng định dạng'); return; }
          if (!pass) { setAuthMsg('err','Vui lòng nhập mật khẩu'); return; }
          setAuthMsg('', ''); 
          const fb = FB(); const fn = fb.loginEmailPass || fb.loginEmailPassword;
          if (!fn) throw new Error('Thiếu NINI.fb.loginEmailPass');
          const user = await fn(email, pass);
          setAuthMsg('ok','Đăng nhập thành công!');
          toggleSignedIn(user);
          closeAuth();
        }catch(err){ setAuthMsg('err', err?.message || 'Đăng nhập thất bại'); }
      });

      // signup (email-only)
      $('#formSignup').addEventListener('submit', async (e)=>{
        e.preventDefault();
        try{
          const email = $('#signupEmail').value.trim();
          if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { setAuthMsg('err','Email chưa đúng định dạng'); return; }
          const fb = FB(); if (!fb.registerEmailOnly) throw new Error('Thiếu NINI.fb.registerEmailOnly');
          await fb.registerEmailOnly(email);
          setAuthMsg('ok','Đã gửi email xác minh. Vui lòng kiểm tra hộp thư.');
          closeAuth();
        }catch(err){ setAuthMsg('err', err?.message || 'Đăng ký thất bại'); }
      });

      // reset
      $('#formReset').addEventListener('submit', async (e)=>{
        e.preventDefault();
        try{
          const email = $('#resetEmail').value.trim();
          if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { setAuthMsg('err','Email chưa đúng định dạng'); return; }
          const fb = FB(); if (!fb.resetPassword) throw new Error('Thiếu NINI.fb.resetPassword');
          await fb.resetPassword(email);
          setAuthMsg('ok','Đã gửi link đặt lại mật khẩu. Vui lòng kiểm tra email.');
          closeAuth();
        }catch(err){ setAuthMsg('err', err?.message || 'Gửi mail thất bại'); }
      });

      // Google
      $('#btnGoogle').addEventListener('click', async ()=>{
        try{
          const fb = FB(); if (!fb.loginGoogle) throw new Error('Thiếu NINI.fb.loginGoogle');
          const user = await fb.loginGoogle();
          toggleSignedIn(user); closeAuth();
          setAuthMsg('ok','Đăng nhập Google thành công!');
        }catch(err){ setAuthMsg('err', err?.message || 'Đăng nhập Google thất bại'); }
      });

      // Sign out
      $('#btnSignOut').addEventListener('click', async ()=>{
        try{
          const fb = FB(); await fb.signOut?.();
        }catch(_){}
      });

      // subscribe auth changed
      try{
        const fb = FB();
        fb.onUserChanged && fb.onUserChanged((u)=>{ toggleSignedIn(u); });
      }catch(_){}
    })();
  </script>

  <!-- ===== Firebase glue của bạn (đã có) ===== -->
  <script type="module" src="/public/js/nini-fb.mjs"></script>
</body>
</html>
