<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <base href="/" />
  <title>NiNi â€” Funny</title>

  <!-- Favicon -->
  <link rel="icon" href="/public/assets/icons/logonini.webp" type="image/webp" />

  <!-- CSS (báº£n styles.css má»›i Ä‘Ã£ vÃ¡ pointer-events / loading / reader center) -->
  <link rel="stylesheet" href="/styles.css?v=10" />
</head>
<body>
  <!-- ========== HEADER ========== -->
  <header class="site-header">
    <a class="brand" href="#/home">
      <img class="brand__logo" src="/public/assets/icons/logo_text.webp" alt="NiNi Funny" />
      <div class="brand__slogan">
        <span>ChÆ¡i</span> <span>mÃª lÃ½</span>, <span>bá»©t phÃ¡</span> <span>tÆ° duy</span>
      </div>
    </a>

    <!-- Tabs mÃ¹a (router hash) -->
    <nav class="tabs" id="seasonTabs">
      <button class="tab is-active" data-season="home">Home</button>
      <button class="tab" data-season="spring">Spring</button>
      <button class="tab" data-season="summer">Summer</button>
      <button class="tab" data-season="autumn">Autumn</button>
      <button class="tab" data-season="winter">Winter</button>
    </nav>

    <button id="authBtn" class="auth-btn">ÄÄƒng nháº­p / ÄÄƒng kÃ½</button>
    <a id="adminBtn" class="admin-link" href="/admin/login.html" rel="noopener">Admin</a>
  </header>

  <!-- ========== VIEWPORT ========== -->
  <main class="viewport">
    <!-- Khung chÃ­nh cÃ³ ná»n theo mÃ¹a -->
    <section class="frame" id="frame">
      <!-- Mascot -->
      <img class="nini" src="/public/assets/icons/nini.webp" alt="NiNi" />

      <!-- Chips ná»™i dung nhanh -->
      <div class="chips">
        <button class="chip is-active" data-section="intro">Giá»›i thiá»‡u</button>
        <button class="chip" data-section="rules">Luáº­t chÆ¡i</button>
        <button class="chip" data-section="forum">Diá»…n Ä‘Ã n</button>
        <button class="chip" data-section="feedback">GÃ³p Ã½</button>
      </div>

      <!-- Mount ká»‡ sÃ¡ch (náº±m trong frame) -->
      <div id="shelfMount" class="shelf-card" hidden></div>

      <!-- =========================================================
           [Báº®T Äáº¦U] MOUNT GAME AUTUMN TRONG FRAME (giá»‘ng Storybook)
           Hiá»ƒn thá»‹ nhÆ° má»™t "card" má» trÃªn ná»n rá»«ng, ngay trong khung.
      ========================================================== -->
      <div id="autumnMount" class="shelf-card" hidden>
        <h3 class="shelf-title">Autumn â€” English Mini Games</h3>
        <!-- HUD hiá»ƒn thá»‹ tÃ i khoáº£n, XP, Coins -->
        <div id="nini-hud"></div>
        <!-- á»¨ng dá»¥ng: Topics/Categories/Khu vá»±c chÆ¡i -->
        <div id="nini-app" style="margin-top:12px"></div>
      </div>
      <!-- =========================================================
           [Háº¾T] MOUNT GAME AUTUMN TRONG FRAME
      ========================================================== -->
    </section>

    <!-- Ná»™i dung mÃ´ táº£ dÆ°á»›i khung -->
    <section class="content" id="content">
      <h2>NiNi â€” Funny</h2>
      <p>Báº¡n cÃ³ nghÄ© viá»‡c há»c tiáº¿ng Anh lÃ  má»™t thá»­ thÃ¡ch khÃ³ nháº±n vÃ  Ä‘áº§y Ã¡p lá»±c khÃ´ng? HÃ£y quÃªn Ä‘i cÃ¡ch há»c truyá»n thá»‘ng vÃ  khÃ¡m phÃ¡ má»™t tháº¿ giá»›i hoÃ n toÃ n má»›i vá»›i <strong>NiNi â€” Funny</strong>!</p>
      <p>Vá»›i slogan "ChÆ¡i mÃª ly, bá»©t phÃ¡ tÆ° duy", NiNi-Funny khÃ´ng chá»‰ lÃ  má»™t trÃ² chÆ¡i giáº£i trÃ­, mÃ  cÃ²n lÃ  cÃ´ng cá»¥ giÃºp báº¡n:</p>
      <ul>
        <li>Äáº¯m chÃ¬m vÃ o cuá»™c phiÃªu lÆ°u: KhÃ¡m phÃ¡ nhá»¯ng mÃ n chÆ¡i Ä‘áº§y mÃ u sáº¯c, giáº£i Ä‘á»‘ nhá»¯ng cÃ¢u chuyá»‡n háº¥p dáº«n vÃ  chinh phá»¥c cÃ¡c thá»­ thÃ¡ch ngÃ´n ngá»¯ má»™t cÃ¡ch tá»± nhiÃªn.</li>
        <li>Há»c mÃ  nhÆ° chÆ¡i: Má»Ÿ rá»™ng vá»‘n tá»« vá»±ng, rÃ¨n luyá»‡n ngá»¯ phÃ¡p vÃ  tÄƒng kháº£ nÄƒng pháº£n xáº¡ tiáº¿ng Anh thÃ´ng qua cÃ¡c mini-game vui nhá»™n vÃ  sÃ¡ng táº¡o.</li>
        <li>PhÃ¡t triá»ƒn báº£n thÃ¢n: Bá»©t phÃ¡ khá»i nhá»¯ng giá»›i háº¡n cá»§a báº£n thÃ¢n, tÆ° duy logic vÃ  ká»¹ nÄƒng giáº£i quyáº¿t váº¥n Ä‘á» cá»§a báº¡n sáº½ Ä‘Æ°á»£c nÃ¢ng cao má»™t cÃ¡ch Ä‘Ã¡ng ká»ƒ.</li>
      </ul>
      <p>HÃ£y táº£i <strong>NiNi â€” Funny</strong> ngay hÃ´m nay vÃ  báº¯t Ä‘áº§u hÃ nh trÃ¬nh biáº¿n tiáº¿ng Anh thÃ nh má»™t niá»m vui báº¥t táº­n.</p>
    </section>
  </main>

  <!-- ========== READER MODAL (kiá»ƒu â€œlá»‹ch Ä‘á»ƒ bÃ nâ€) ========== -->
  <div class="modal" id="readerModal" aria-hidden="true">
    <div class="modal__backdrop" data-reader-close></div>
    <div class="modal__panel" role="dialog" aria-modal="true" aria-labelledby="readerTitle">
      <button class="modal__close" data-reader-close aria-label="ÄÃ³ng">Ã—</button>

      <header class="calendar-head">
        <h3 id="readerTitle" class="calendar-title">Äang táº£iâ€¦</h3>
        <div class="calendar-tools">
          <button id="btnLangVi" class="chip" title="Xem phá»¥ Ä‘á» Tiáº¿ng Viá»‡t">VI</button>
          <button id="btnLangEn" class="chip" title="Xem phá»¥ Ä‘á» English">EN</button>
          <button id="btnSpeak"  class="chip" title="Äá»c to">ğŸ”Š</button>
        </div>
      </header>

      <div id="calendarViewport" class="calendar-viewport is-ready">
        <div id="calendarBg" class="calendar-bg"></div>
        <div id="pageCounterTop" class="page-indicator page-indicator--top">Trang 1/1</div>
        <div class="subtitle"><div id="subtitleText" class="subtitle-text"></div></div>
        <div class="pagebar">
          <button id="imgPrev" class="pill-nav" title="Trang trÆ°á»›c">â—€</button>
          <button id="imgNext" class="pill-nav" title="Trang sau">â–¶</button>
        </div>
        <div class="spinner"><div class="dot"></div></div>
      </div>
    </div>
  </div>

  <!-- ========== AUTH MODAL ========== -->
  <div class="modal" id="authModal" aria-hidden="true">
    <div class="modal__backdrop" data-close></div>
    <div class="modal__panel" role="dialog" aria-modal="true" aria-labelledby="authTitle">
      <button class="modal__close" data-close aria-label="ÄÃ³ng">Ã—</button>

      <h3 id="authTitle" class="modal__title">
        <img src="/public/assets/icons/logonini.webp" alt="" class="modal__logo" />
        ÄÄƒng nháº­p / ÄÄƒng kÃ½
      </h3>

      <div class="tabs-line" id="authTabs">
        <button class="tab-line is-active" data-auth="login">ÄÄƒng nháº­p</button>
        <button class="tab-line" data-auth="signup">ÄÄƒng kÃ½ má»›i</button>
        <button class="tab-line" data-auth="forgot">QuÃªn máº­t kháº©u</button>
      </div>

      <!-- Login -->
      <form class="form is-active" data-pane="login">
        <button type="button" class="btn btn-ghost full">ÄÄƒng nháº­p vá»›i Google</button>
        <div class="or">hoáº·c</div>
        <label>Email</label>
        <input type="email" placeholder="you@example.com" />
        <label>Máº­t kháº©u</label>
        <input type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
        <div class="row">
          <button type="submit" class="btn">ÄÄƒng nháº­p</button>
        </div>
      </form>

      <!-- Sign up -->
      <form class="form" data-pane="signup">
        <label>Email</label>
        <input type="email" placeholder="you@example.com" />
        <div class="row gap">
          <button type="button" class="btn btn-ghost">Gá»­i mÃ£ OTP</button>
          <input type="text" placeholder="Nháº­p mÃ£ OTP" />
        </div>
        <label>Máº­t kháº©u má»›i</label>
        <input type="password" placeholder="Tá»‘i thiá»ƒu 8 kÃ½ tá»±" />
        <div class="row">
          <button type="submit" class="btn">Táº¡o tÃ i khoáº£n</button>
        </div>
        <p class="note">Sau khi táº¡o tÃ i khoáº£n, báº¡n sáº½ Ä‘Æ°á»£c nháº¯c cáº­p nháº­t há»“ sÆ¡ Ä‘á»ƒ báº£o vá»‡ tÃ i khoáº£n.</p>
      </form>

      <!-- Forgot -->
      <form class="form" data-pane="forgot">
        <label>Email</label>
        <input type="email" placeholder="you@example.com" />
        <div class="row gap">
          <button type="button" class="btn btn-ghost">Gá»­i mÃ£ OTP</button>
          <input type="text" placeholder="Nháº­p mÃ£ 6 sá»‘" />
        </div>
        <label>Máº­t kháº©u má»›i</label>
        <input type="password" placeholder="Tá»‘i thiá»ƒu 8 kÃ½ tá»±" />
        <div class="row">
          <button type="submit" class="btn">Äáº·t láº¡i máº­t kháº©u</button>
        </div>
      </form>
    </div>
  </div>

  <!-- JS (defer Ä‘á»ƒ táº£i sau khi DOM sáºµn sÃ ng) -->
  <script src="/public/js/effects.js?v=5" defer></script>
  <script src="/public/js/app.js?v=13" defer></script>

  <!-- =========================================================
       [Báº®T Äáº¦U] NHÃšNG GAME AUTUMN (MOUNT TRONG FRAME)
       1) Upload file JS vÃ o:  /public/content/game/nini-autumn.js
       2) Script game sáº½ render HUD (#nini-hud) & App (#nini-app) trong #autumnMount
       3) Helper dÆ°á»›i Ä‘Ã¢y sáº½ áº©n/hiá»‡n #autumnMount theo hash '#/autumn'
          vÃ  tá»± áº©n #shelfMount Ä‘á»ƒ khÃ´ng Ä‘Ã¨ lÃªn nhau.
  ========================================================== -->
  <script src="/public/content/game/nini-autumn.js" defer></script>
  <script>
    (function () {
      var mount = document.getElementById('autumnMount');
      var shelf = document.getElementById('shelfMount');
      var chips = document.querySelector('.chips');

      function syncSeason() {
  var h = (location.hash || '').toLowerCase();
  var isAutumn = h.indexOf('/autumn') >= 0;

  mount.hidden = !isAutumn;
  if (shelf) shelf.hidden = isAutumn;
  if (chips) chips.style.opacity = isAutumn ? '0.0' : '';

  // âš¡ FIX: Khi vÃ o Autumn, gá»i render láº¡i
  if (isAutumn && window.NiniApp) {
    if (!(NiniApp.list() || []).length) {
      NiniApp.debugCreate('Player'); // táº¡o profile máº·c Ä‘á»‹nh
    }
    // cháº¡m state Ä‘á»ƒ Ã©p HUD/App update
    setTimeout(() => NiniApp.addXP(0), 0);
  }
}


      window.addEventListener('hashchange', syncSeason);
      document.addEventListener('DOMContentLoaded', syncSeason);
    })();
  </script>
  <!-- =========================================================
       [Háº¾T] NHÃšNG GAME AUTUMN
  ========================================================== -->
<!-- Firebase (modular CDN) -->
<script type="module">
  // ========== Firebase bootstrap ==========
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // TODO: dÃ¡n config cá»§a báº¡n vÃ o Ä‘Ã¢y
  const firebaseConfig = {
    apiKey: "AIzaSyBdaMS7aI03wHLhi1Md2QDitJFkA61IYUU",
    authDomain: "nini-8f3d4.firebaseapp.com",
    projectId: "nini-8f3d4",
    storageBucket: "nini-8f3d4.firebasestorage.app",
    messagingSenderId: "991701821645",
    appId: "1:991701821645:web:fb21c357562c6c801da184"
  };

  // Init
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  // NÃºt Ä‘Äƒng nháº­p/Ä‘Äƒng kÃ½ cÃ³ sáºµn trÃªn trang
  const authBtn = document.getElementById("authBtn");

  // ==== Helpers: ghÃ©p NiniApp (localStorage) vá»›i Firestore ====

  // TÃªn cÃ¡c key localStorage (trÃ¹ng vá»›i file game compat v3)
  const LS_ACCOUNTS = "NINI_ACCOUNTS_V3";
  const LS_ACTIVE   = "NINI_ACTIVE_USER_V3";

  // Táº¡o â€œhá»“ sÆ¡ cá»¥c bá»™â€ tá»« 1 profile (map vá» cáº¥u trÃºc NiniApp)
  function installLocalProfile(uid, profile) {
    const accounts = {};
    accounts[uid] = {
      name: profile.name || "Player",
      xp: profile.xp || 0,
      coins: profile.coins || 300,
      createdAt: profile.createdAt || Date.now(),
      lastSave: Date.now(),
      unlocked: profile.unlocked || { topics:{}, categories:{} }
    };
    localStorage.setItem(LS_ACCOUNTS, JSON.stringify(accounts));
    localStorage.setItem(LS_ACTIVE, JSON.stringify(uid));
    // cháº¡m state Ä‘á»ƒ HUD/App refresh náº¿u NiniApp Ä‘Ã£ sáºµn sÃ ng
    if (window.NiniApp && typeof NiniApp.addXP === "function") NiniApp.addXP(0);
  }

  // Láº¥y há»“ sÆ¡ cá»¥c bá»™ hiá»‡n táº¡i (Ä‘á»ƒ Ä‘áº©y lÃªn Firestore)
  function readLocalProfile() {
    try {
      const accounts = JSON.parse(localStorage.getItem(LS_ACCOUNTS) || "{}");
      const active = JSON.parse(localStorage.getItem(LS_ACTIVE) || "null");
      if (!active || !accounts[active]) return null;
      return { uid: active, profile: accounts[active] };
    } catch (e) { return null; }
  }

  // Äá»“ng bá»™ Ä‘áº©y lÃªn Firestore
  async function pushToCloud(uid) {
    const cur = readLocalProfile();
    if (!cur) return;
    const ref = doc(db, "profiles", uid);
    await setDoc(ref, {
      name: cur.profile.name,
      xp: cur.profile.xp|0,
      coins: cur.profile.coins|0,
      unlocked: cur.profile.unlocked || { topics:{}, categories:{} },
      updatedAt: Date.now()
    }, { merge: true });
  }

  // ==== ÄÄƒng nháº­p / ÄÄƒng xuáº¥t ====
  async function login() {
    try {
      await signInWithPopup(auth, provider);
    } catch (e) {
      alert("ÄÄƒng nháº­p tháº¥t báº¡i: " + e.message);
    }
  }

  async function logout() {
    await signOut(auth);
  }

  // Báº¯t sá»± kiá»‡n click nÃºt
  if (authBtn) {
    authBtn.addEventListener("click", () => {
      const user = auth.currentUser;
      if (user) logout(); else login();
    });
  }

  // Theo dÃµi tráº¡ng thÃ¡i Ä‘Äƒng nháº­p
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      authBtn.textContent = "ÄÄƒng xuáº¥t (" + (user.displayName || user.email) + ")";
      // Táº£i profile trÃªn cloud (náº¿u cÃ³), náº¿u chÆ°a cÃ³ thÃ¬ táº¡o tá»« local
      const ref = doc(db, "profiles", user.uid);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        // 1) CÃ³ dá»¯ liá»‡u trÃªn cloud â†’ ghi Ä‘Ã¨ local Ä‘á»ƒ chÆ¡i tiáº¿p
        installLocalProfile(user.uid, snap.data());
      } else {
        // 2) ChÆ°a cÃ³ â†’ láº¥y local (náº¿u rá»—ng thÃ¬ táº¡o máº·c Ä‘á»‹nh) rá»“i Ä‘áº©y lÃªn cloud
        if (window.NiniApp && !(NiniApp.list() || []).length) {
          NiniApp.debugCreate(user.displayName || "Player");
        }
        const cur = readLocalProfile();
        if (cur) await pushToCloud(user.uid);
        // Ä‘áº£m báº£o ACTIVE lÃ  uid tháº­t
        const accounts = JSON.parse(localStorage.getItem(LS_ACCOUNTS) || "{}");
        if (!accounts[user.uid]) {
          installLocalProfile(user.uid, (cur && cur.profile) || {name:user.displayName||"Player", coins:300, xp:0});
        } else {
          localStorage.setItem(LS_ACTIVE, JSON.stringify(user.uid));
          if (window.NiniApp) NiniApp.addXP(0);
        }
      }

      // Auto-save má»—i khi ngÆ°á»i chÆ¡i thay Ä‘á»•i Ä‘iá»ƒm (poll ráº¥t nháº¹)
      // (Náº¿u sau nÃ y báº¡n thÃªm event bus trong NiniApp thÃ¬ Ä‘á»•i sang event)
      window.__niniSaveTimer && clearInterval(window.__niniSaveTimer);
      window.__niniSaveTimer = setInterval(function(){ pushToCloud(user.uid); }, 5000);

    } else {
      authBtn.textContent = "ÄÄƒng nháº­p / ÄÄƒng kÃ½";
      // KhÃ´ng xÃ³a local Ä‘á»ƒ ngÆ°á»i chÆ¡i offline váº«n tiáº¿p tá»¥c Ä‘Æ°á»£c
      window.__niniSaveTimer && clearInterval(window.__niniSaveTimer);
    }
  });

  // Náº¿u vÃ o trá»±c tiáº¿p #/autumn khi chÆ°a Ä‘Äƒng nháº­p, váº«n táº¡o 1 profile local táº¡m
  document.addEventListener("DOMContentLoaded", function () {
    if (window.NiniApp && !(NiniApp.list() || []).length) {
      NiniApp.debugCreate("Player");
    }
  });
</script>

</body>
</html>


