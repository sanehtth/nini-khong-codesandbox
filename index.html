<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <base href="/" />
  <title>NiNi ‚Äî Funny</title>

  <!-- Favicon -->
  <link rel="icon" href="/public/assets/icons/logonini.webp" type="image/webp" />

  <!-- CSS -->
  <link rel="stylesheet" href="/styles.css?v=10" />
</head>
<body>
  <!-- ========== HEADER ========== -->
  <header class="site-header">
    <a class="brand" href="#/home">
      <img class="brand__logo" src="/public/assets/icons/logo_text.webp" alt="NiNi Funny" />
      <div class="brand__slogan">
        <span>Ch∆°i</span> <span>m√™ l√Ω</span>, <span>b·ª©t ph√°</span> <span>t∆∞ duy</span>
      </div>
    </a>

    <!-- Tabs m√πa (router hash) -->
    <nav class="tabs" id="seasonTabs">
      <button class="tab is-active" data-season="home">Home</button>
      <button class="tab" data-season="spring">Spring</button>
      <button class="tab" data-season="summer">Summer</button>
      <button class="tab" data-season="autumn">Autumn</button>
      <button class="tab" data-season="winter">Winter</button>
    </nav>

    <button id="authBtn" class="auth-btn">ƒêƒÉng nh·∫≠p / ƒêƒÉng k√Ω</button>
  
    // Thay v√¨ logout ngay khi ƒë√£ ƒëƒÉng nh·∫≠p,
// lu√¥n ƒë∆∞a ng∆∞·ªùi d√πng sang trang h·ªì s∆° ƒë·ªÉ qu·∫£n l√Ω t√†i kho·∫£n.
if (authBtn) {
  authBtn.addEventListener("click", (e) => {
    e.preventDefault();
    location.href = "/profile.html";
  });
}
  </header>

  <!-- ========== VIEWPORT ========== -->
  <main class="viewport">
    <!-- Khung ch√≠nh c√≥ n·ªÅn theo m√πa -->
    <section class="frame" id="frame">
      <!-- Mascot -->
      <img class="nini" src="/public/assets/icons/nini.webp" alt="NiNi" />

      <!-- Chips n·ªôi dung nhanh -->
      <div class="chips">
        <button class="chip is-active" data-section="intro">Gi·ªõi thi·ªáu</button>
        <button class="chip" data-section="rules">Lu·∫≠t ch∆°i</button>
        <button class="chip" data-section="forum">Di·ªÖn ƒë√†n</button>
        <button class="chip" data-section="feedback">G√≥p √Ω</button>
      </div>

      <!-- Mount k·ªá s√°ch (n·∫±m trong frame) -->
      <div id="shelfMount" class="shelf-card" hidden></div>

      <!-- =========================================================
           [B·∫ÆT ƒê·∫¶U] MOUNT GAME AUTUMN TRONG FRAME (gi·ªëng Storybook)
           - Hi·ªÉn th·ªã HUD (#nini-hud) v√† App (#nini-app) ngay trong frame.
      ========================================================== -->
      <div id="autumnMount" class="shelf-card" hidden>
        <h3 class="shelf-title">Autumn ‚Äî English Mini Games</h3>
        <div id="nini-hud"></div>
        <div id="nini-app" style="margin-top:12px"></div>
      </div>
      <!-- =========================================================
           [H·∫æT] MOUNT GAME AUTUMN TRONG FRAME
      ========================================================== -->
    </section>

    <!-- N·ªôi dung m√¥ t·∫£ d∆∞·ªõi khung -->
    <section class="content" id="content">
      <h2>NiNi ‚Äî Funny</h2>
      <p>B·∫°n c√≥ nghƒ© vi·ªác h·ªçc ti·∫øng Anh l√† m·ªôt th·ª≠ th√°ch kh√≥ nh·∫±n v√† ƒë·∫ßy √°p l·ª±c kh√¥ng? H√£y qu√™n ƒëi c√°ch h·ªçc truy·ªÅn th·ªëng v√† kh√°m ph√° m·ªôt th·∫ø gi·ªõi ho√†n to√†n m·ªõi v·ªõi <strong>NiNi ‚Äî Funny</strong>!</p>
      <p>V·ªõi slogan "Ch∆°i m√™ ly, b·ª©t ph√° t∆∞ duy", NiNi-Funny kh√¥ng ch·ªâ l√† m·ªôt tr√≤ ch∆°i gi·∫£i tr√≠, m√† c√≤n l√† c√¥ng c·ª• gi√∫p b·∫°n:</p>
      <ul>
        <li>ƒê·∫Øm ch√¨m v√†o cu·ªôc phi√™u l∆∞u: Kh√°m ph√° nh·ªØng m√†n ch∆°i ƒë·∫ßy m√†u s·∫Øc, gi·∫£i ƒë·ªë nh·ªØng c√¢u chuy·ªán h·∫•p d·∫´n v√† chinh ph·ª•c c√°c th·ª≠ th√°ch ng√¥n ng·ªØ m·ªôt c√°ch t·ª± nhi√™n.</li>
        <li>H·ªçc m√† nh∆∞ ch∆°i: M·ªü r·ªông v·ªën t·ª´ v·ª±ng, r√®n luy·ªán ng·ªØ ph√°p v√† tƒÉng kh·∫£ nƒÉng ph·∫£n x·∫° ti·∫øng Anh th√¥ng qua c√°c mini-game vui nh·ªôn v√† s√°ng t·∫°o.</li>
        <li>Ph√°t tri·ªÉn b·∫£n th√¢n: B·ª©t ph√° kh·ªèi nh·ªØng gi·ªõi h·∫°n c·ªßa b·∫£n th√¢n, t∆∞ duy logic v√† k·ªπ nƒÉng gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ c·ªßa b·∫°n s·∫Ω ƒë∆∞·ª£c n√¢ng cao m·ªôt c√°ch ƒë√°ng k·ªÉ.</li>
      </ul>
      <p>H√£y t·∫£i <strong>NiNi ‚Äî Funny</strong> ngay h√¥m nay v√† b·∫Øt ƒë·∫ßu h√†nh tr√¨nh bi·∫øn ti·∫øng Anh th√†nh m·ªôt ni·ªÅm vui b·∫•t t·∫≠n.</p>
    </section>
  </main>

  <!-- ========== READER MODAL (ki·ªÉu ‚Äúl·ªãch ƒë·ªÉ b√†n‚Äù) ========== -->
  <div class="modal" id="readerModal" aria-hidden="true">
    <div class="modal__backdrop" data-reader-close></div>
    <div class="modal__panel" role="dialog" aria-modal="true" aria-labelledby="readerTitle">
      <button class="modal__close" data-reader-close aria-label="ƒê√≥ng">√ó</button>

      <header class="calendar-head">
        <h3 id="readerTitle" class="calendar-title">ƒêang t·∫£i‚Ä¶</h3>
        <div class="calendar-tools">
          <button id="btnLangVi" class="chip" title="Xem ph·ª• ƒë·ªÅ Ti·∫øng Vi·ªát">VI</button>
          <button id="btnLangEn" class="chip" title="Xem ph·ª• ƒë·ªÅ English">EN</button>
          <button id="btnSpeak"  class="chip" title="ƒê·ªçc to">üîä</button>
        </div>
      </header>

      <div id="calendarViewport" class="calendar-viewport is-ready">
        <div id="calendarBg" class="calendar-bg"></div>
        <div id="pageCounterTop" class="page-indicator page-indicator--top">Trang 1/1</div>
        <div class="subtitle"><div id="subtitleText" class="subtitle-text"></div></div>
        <div class="pagebar">
          <button id="imgPrev" class="pill-nav" title="Trang tr∆∞·ªõc">‚óÄ</button>
          <button id="imgNext" class="pill-nav" title="Trang sau">‚ñ∂</button>
        </div>
        <div class="spinner"><div class="dot"></div></div>
      </div>
    </div>
  </div>

  <!-- ========== AUTH MODAL ========== -->
  <div class="modal" id="authModal" aria-hidden="true">
    <div class="modal__backdrop" data-close></div>
    <div class="modal__panel" role="dialog" aria-modal="true" aria-labelledby="authTitle">
      <button class="modal__close" data-close aria-label="ƒê√≥ng">√ó</button>

      <h3 id="authTitle" class="modal__title">
        <img src="/public/assets/icons/logonini.webp" alt="" class="modal__logo" />
        ƒêƒÉng nh·∫≠p / ƒêƒÉng k√Ω
      </h3>

      <div class="tabs-line" id="authTabs">
        <button class="tab-line is-active" data-auth="login">ƒêƒÉng nh·∫≠p</button>
        <button class="tab-line" data-auth="signup">ƒêƒÉng k√Ω m·ªõi</button>
        <button class="tab-line" data-auth="forgot">Qu√™n m·∫≠t kh·∫©u</button>
      </div>

      <!-- Login -->
      <form class="form is-active" data-pane="login">
        <button type="button" class="btn btn-ghost full">ƒêƒÉng nh·∫≠p v·ªõi Google</button>
        <div class="or">ho·∫∑c</div>
        <label>Email</label>
        <input type="email" placeholder="you@example.com" />
        <label>M·∫≠t kh·∫©u</label>
        <input type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        <div class="row">
          <button type="submit" class="btn">ƒêƒÉng nh·∫≠p</button>
        </div>
      </form>

      <!-- Sign up (placeholder ‚Äì ch∆∞a d√πng Firebase Email signup ·ªü b·∫£n n√†y) -->
      <form class="form" data-pane="signup">
        <label>Email</label>
        <input type="email" placeholder="you@example.com" />
        <div class="row gap">
          <button type="button" class="btn btn-ghost">G·ª≠i m√£ OTP</button>
          <input type="text" placeholder="Nh·∫≠p m√£ OTP" />
        </div>
        <label>M·∫≠t kh·∫©u m·ªõi</label>
        <input type="password" placeholder="T·ªëi thi·ªÉu 8 k√Ω t·ª±" />
        <div class="row">
          <button type="submit" class="btn">T·∫°o t√†i kho·∫£n</button>
        </div>
        <p class="note">Sau khi t·∫°o t√†i kho·∫£n, b·∫°n s·∫Ω ƒë∆∞·ª£c nh·∫Øc c·∫≠p nh·∫≠t h·ªì s∆° ƒë·ªÉ b·∫£o v·ªá t√†i kho·∫£n.</p>
      </form>

      <!-- Forgot -->
      <form class="form" data-pane="forgot">
        <label>Email</label>
        <input type="email" placeholder="you@example.com" />
        <div class="row gap">
          <button type="button" class="btn btn-ghost">G·ª≠i m√£ OTP</button>
          <input type="text" placeholder="Nh·∫≠p m√£ 6 s·ªë" />
        </div>
        <label>M·∫≠t kh·∫©u m·ªõi</label>
        <input type="password" placeholder="T·ªëi thi·ªÉu 8 k√Ω t·ª±" />
        <div class="row">
          <button type="submit" class="btn">ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u</button>
        </div>
      </form>
    </div>
  </div>

  <!-- JS (defer ƒë·ªÉ t·∫£i sau khi DOM s·∫µn s√†ng) -->
  <script src="/public/js/effects.js?v=5" defer></script>
  <script src="/public/js/app.js?v=13" defer></script>

  <!-- =========================================================
       [B·∫ÆT ƒê·∫¶U] NH√öNG GAME AUTUMN (MOUNT TRONG FRAME)
       1) File game: /public/content/game/nini-autumn.js
       2) ·∫®n/hi·ªán #autumnMount theo hash '#/autumn' v√† ·∫©n #shelfMount.
       3) ‚ÄúC√∫ h√≠ch‚Äù khi v√†o Autumn ƒë·ªÉ HUD/App lu√¥n render.
  ========================================================== -->
  <script src="/public/content/game/nini-autumn.js?v=3" defer></script>
  <script>
    (function () {
      var mount = document.getElementById('autumnMount');
      var shelf = document.getElementById('shelfMount');
      var chips = document.querySelector('.chips');

      function syncSeason() {
        var h = (location.hash || '').toLowerCase();
        var isAutumn = h.indexOf('/autumn') >= 0;

        mount.hidden = !isAutumn;
        if (shelf) shelf.hidden = isAutumn;
        if (chips) chips.style.opacity = isAutumn ? '0.0' : '';

        if (isAutumn && window.NiniApp) {
          if (!(NiniApp.list() || []).length) NiniApp.debugCreate('Player');
          setTimeout(function(){ NiniApp.addXP(0); }, 0);
        }
      }

      window.addEventListener('hashchange', syncSeason);
      document.addEventListener('DOMContentLoaded', syncSeason);
    })();
  </script>
  <!-- =========================================================
       [H·∫æT] NH√öNG GAME AUTUMN
  ========================================================== -->

  <!-- =========================================================
       [B·∫ÆT ƒê·∫¶U] KH·ªêI ƒêƒÇNG NH·∫¨P + ƒê·ªíNG B·ªò TI·∫æN TR√åNH (Firebase)
       - Login Google + Email/Password + Qu√™n m·∫≠t kh·∫©u (n·∫øu enable).
       - N√∫t header: ch∆∞a login ‚Üí m·ªü modal; ƒë√£ login ‚Üí ƒëƒÉng xu·∫•t.
       - Notice/Toast r√µ r√†ng (k√≠nh m·ªù) cho th√†nh c√¥ng/th·∫•t b·∫°i.
       - ƒê·ªìng b·ªô XP/Coins/Unlocked l√™n Firestore (profiles/{uid}) m·ªói 5s.
       - Expose checkLogin() ƒë·ªÉ ki·ªÉm tra nhanh b·∫±ng Console.
  ========================================================== -->
  <script type="module">
    /* 0) Import Firebase (CDN) */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut,
      signInWithEmailAndPassword, sendPasswordResetEmail
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    /* 1) THAY b·∫±ng config c·ªßa b·∫°n */
    const firebaseConfig = {
      apiKey: "AIzaSyBdaMS7aI03wHLhi1Md2QDitJFkA61IYUU",
  authDomain: "nini-8f3d4.firebaseapp.com",
  projectId: "nini-8f3d4",
  storageBucket: "nini-8f3d4.firebasestorage.app",
  messagingSenderId: "991701821645",
  appId: "1:991701821645:web:fb21c357562c6c801da184"
    };

    /* 2) Init */
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // Expose ƒë·ªÉ debug
    window.__auth = auth;
    window.__db   = db;
    window.checkLogin = () => (auth.currentUser ? { uid: auth.currentUser.uid, name: auth.currentUser.displayName || auth.currentUser.email } : null);

    /* 3) C·∫≠p nh·∫≠t ch·ªØ n√∫t header theo tr·∫°ng th√°i ƒëƒÉng nh·∫≠p */
    function updateAuthBtnText() {
      const btn = document.getElementById("authBtn");
      if (!btn) return;
      const u = auth.currentUser;
      btn.textContent = u ? ("ƒêƒÉng xu·∫•t (" + (u.displayName || u.email) + ")") : "ƒêƒÉng nh·∫≠p / ƒêƒÉng k√Ω";
      btn.dataset.authState = u ? "in" : "out";
    }
    window.addEventListener("hashchange", updateAuthBtnText);
    document.addEventListener("visibilitychange", () => { if (!document.hidden) updateAuthBtnText(); });
    window.addEventListener("load", () => {
      updateAuthBtnText();
      setTimeout(updateAuthBtnText, 300);
      setTimeout(updateAuthBtnText, 1200);
    });

    /* 4) localStorage keys (kh·ªõp b·∫£n game compat v3) */
    const LS_ACCOUNTS = "NINI_ACCOUNTS_V3";
    const LS_ACTIVE   = "NINI_ACTIVE_USER_V3";

    /* 5) Helpers ƒë·ªçc/ghi h·ªì s∆° c·ª•c b·ªô + ƒë·ªìng b·ªô cloud */
    function installLocalProfile(uid, profile) {
      const accounts = {};
      accounts[uid] = {
        name: profile.name || "Player",
        xp: profile.xp|0, coins: profile.coins|0,
        createdAt: profile.createdAt || Date.now(),
        lastSave: Date.now(),
        unlocked: profile.unlocked || { topics:{}, categories:{} }
      };
      localStorage.setItem(LS_ACCOUNTS, JSON.stringify(accounts));
      localStorage.setItem(LS_ACTIVE, JSON.stringify(uid));
      if (window.NiniApp && typeof NiniApp.addXP === "function") NiniApp.addXP(0);
    }
    function readLocalProfile() {
      try {
        const accounts = JSON.parse(localStorage.getItem(LS_ACCOUNTS) || "{}");
        const active   = JSON.parse(localStorage.getItem(LS_ACTIVE)   || "null");
        if (!active || !accounts[active]) return null;
        return { uid: active, profile: accounts[active] };
      } catch { return null; }
    }
    async function pushToCloud(uid) {
      const cur = readLocalProfile(); if (!cur) return;
      await setDoc(doc(db, "profiles", uid), {
        name: cur.profile.name,
        xp: cur.profile.xp|0,
        coins: cur.profile.coins|0,
        unlocked: cur.profile.unlocked || { topics:{}, categories:{} },
        updatedAt: Date.now()
      }, { merge: true });
    }

    /* 6) Toast (k√≠nh m·ªù) + Notice inline trong modal */
    function toast(msg, ok=true){
      const t = document.createElement('div');
      t.textContent = msg;
      t.style.cssText = [
        "position:fixed","top:12px","right:12px","padding:8px 12px","border-radius:12px","z-index:9999",
        "backdrop-filter:blur(6px)","-webkit-backdrop-filter:blur(6px)",
        "background:rgba(255,255,255,.22)","border:1px solid rgba(17,24,39,.14)",
        "color:" + (ok ? "#0f5132" : "#7f1d1d")
      ].join(";");
      document.body.appendChild(t); setTimeout(()=>t.remove(), 2500);
    }
    function ensureNoticeEl(){
      const panel = document.querySelector('#authModal .modal__panel');
      if (!panel) return null;
      let n = panel.querySelector('#authNotice');
      if (!n) {
        n = document.createElement('div');
        n.id = 'authNotice';
        n.style.cssText = "margin:6px 0 10px;padding:8px 12px;border-radius:12px;display:none;"
          + "backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);"
          + "background:rgba(255,255,255,.22);border:1px solid rgba(17,24,39,.14);";
        const title = panel.querySelector('#authTitle');
        panel.insertBefore(n, title.nextElementSibling);
      }
      return n;
    }
    function setNotice(msg, ok=true){
      const n = ensureNoticeEl(); if(!n) return;
      n.style.display = "block";
      n.style.color = ok ? "#0f5132" : "#7f1d1d";
      n.textContent = msg;
    }
    function clearNotice(){ const n = document.getElementById('authNotice'); if(n){ n.style.display="none"; n.textContent=""; } }

    /* 7) Login/Logout & binding n√∫t */
    const authBtn   = document.getElementById("authBtn");
    const authModal = document.getElementById("authModal");
    function openAuthModal(){ if (authModal) authModal.setAttribute("aria-hidden","false"); }
    function closeAuthModal(){ if (authModal) authModal.setAttribute("aria-hidden","true"); }

    async function login(){ return signInWithPopup(auth, provider); }
    async function logout(){ await signOut(auth); }

    if (authBtn) {
      authBtn.addEventListener("click", (e) => {
        e.preventDefault();
        const u = auth.currentUser;
        if (u) { logout(); }
        else { openAuthModal(); }  // kh√¥ng auto b·∫≠t Google ·ªü ƒë√¢y
      });
    }

    // N√∫t Google trong modal
    function bindGoogleButton(){
      const btn = document.querySelector('#authModal [data-pane="login"] .btn.btn-ghost.full');
      if (btn && !btn.dataset.bound) {
        btn.dataset.bound = "1";
        btn.addEventListener("click", async () => {
          clearNotice();
          try {
            await login();
            setNotice("ƒêƒÉng nh·∫≠p Google th√†nh c√¥ng!", true);
            toast("ƒêƒÉng nh·∫≠p th√†nh c√¥ng", true);
            closeAuthModal();
          } catch (e) {
            const msg = (e && e.code) ? e.code.replace('auth/','').replace(/-/g,' ') : e.message;
            setNotice("Kh√¥ng th·ªÉ ƒëƒÉng nh·∫≠p Google: " + msg, false);
            toast("ƒêƒÉng nh·∫≠p th·∫•t b·∫°i", false);
          }
        });
      }
    }
    // ƒêƒÉng nh·∫≠p Email + M·∫≠t kh·∫©u
    function bindEmailLogin(){
      const form  = document.querySelector('#authModal [data-pane="login"]');
      if (!form || form.dataset.bound) return;
      form.dataset.bound = "1";
      const email = form.querySelector('input[type="email"]');
      const pass  = form.querySelector('input[type="password"]');
      form.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        clearNotice();
        if (!email.value || !pass.value) { setNotice("Vui l√≤ng nh·∫≠p email v√† m·∫≠t kh·∫©u.", false); return; }
        const submitBtn = form.querySelector('.row .btn');
        const old = submitBtn.textContent; submitBtn.disabled = true; submitBtn.textContent = "ƒêang ƒëƒÉng nh·∫≠p‚Ä¶";
        try {
          await signInWithEmailAndPassword(auth, email.value.trim(), pass.value);
          setNotice("ƒêƒÉng nh·∫≠p th√†nh c√¥ng!", true);
          toast("ƒêƒÉng nh·∫≠p th√†nh c√¥ng", true);
          closeAuthModal();
        } catch (e) {
          let msg = (e && e.code) ? e.code.replace('auth/','').replace(/-/g,' ') : "l·ªói kh√¥ng x√°c ƒë·ªãnh";
          if (msg.includes("user not found")) msg = "Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n.";
          if (msg.includes("wrong password")) msg = "Sai m·∫≠t kh·∫©u.";
          if (msg.includes("invalid email"))  msg = "Email kh√¥ng h·ª£p l·ªá.";
          setNotice("ƒêƒÉng nh·∫≠p th·∫•t b·∫°i: " + msg, false);
          toast("ƒêƒÉng nh·∫≠p th·∫•t b·∫°i", false);
        } finally {
          submitBtn.disabled = false; submitBtn.textContent = old;
        }
      });
    }
    // Qu√™n m·∫≠t kh·∫©u (d√πng Firebase reset email)
    function bindForgot(){
      const pane = document.querySelector('#authModal [data-pane="forgot"]');
      if (!pane || pane.dataset.bound) return;
      pane.dataset.bound = "1";
      const email = pane.querySelector('input[type="email"]');
      const btn   = pane.querySelector('.btn.btn-ghost'); // ‚ÄúG·ª≠i m√£ OTP‚Äù -> d√πng reset email
      if (btn) btn.addEventListener('click', async () => {
        clearNotice();
        if (!email.value) { setNotice("Nh·∫≠p email ƒë·ªÉ ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u.", false); return; }
        try {
          await sendPasswordResetEmail(auth, email.value.trim());
          setNotice("ƒê√£ g·ª≠i email ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u. Vui l√≤ng ki·ªÉm tra h·ªôp th∆∞.", true);
          toast("ƒê√£ g·ª≠i email kh√¥i ph·ª•c", true);
        } catch (e) {
          const msg = (e && e.code) ? e.code.replace('auth/','').replace(/-/g,' ') : e.message;
          setNotice("Kh√¥ng th·ªÉ g·ª≠i email kh√¥i ph·ª•c: " + msg, false);
          toast("G·ª≠i email kh√¥i ph·ª•c th·∫•t b·∫°i", false);
        }
      });
    }
    document.addEventListener("DOMContentLoaded", () => {
      bindGoogleButton();
      bindEmailLogin();
      bindForgot();
    });

    /* 8) Theo d√µi tr·∫°ng th√°i ƒëƒÉng nh·∫≠p + HUD tag + autosave cloud */
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        updateAuthBtnText();
        setNotice("ƒê√£ ƒëƒÉng nh·∫≠p: " + (user.displayName || user.email), true);

        const ref  = doc(db, "profiles", user.uid);
        const snap = await getDoc(ref);
        if (snap.exists()) {
          installLocalProfile(user.uid, snap.data());
        } else {
          if (window.NiniApp && !(NiniApp.list()||[]).length) NiniApp.debugCreate(user.displayName || "Player");
          const cur = readLocalProfile();
          if (cur) await pushToCloud(user.uid);
          const accounts = JSON.parse(localStorage.getItem(LS_ACCOUNTS) || "{}");
          if (!accounts[user.uid]) {
            installLocalProfile(user.uid, (cur && cur.profile) || { name:user.displayName||"Player", coins:300, xp:0 });
          } else {
            localStorage.setItem(LS_ACTIVE, JSON.stringify(user.uid));
            if (window.NiniApp) NiniApp.addXP(0);
          }
        }

        // Pill user tr√™n HUD
        const hud = document.getElementById('nini-hud');
        if (hud) {
          const exists = hud.querySelector('[data-hud-user]');
          if (!exists) {
            const tag = document.createElement('span');
            tag.className = 'pill';
            tag.setAttribute('data-hud-user','1');
            tag.textContent = 'üë§ ' + (user.displayName || user.email);
            const row = hud.querySelector('.hud');
            (row ? row : hud).appendChild(tag);
          }
        }

        // Auto-save 5s/l·∫ßn
        window.__niniSaveTimer && clearInterval(window.__niniSaveTimer);
        window.__niniSaveTimer = setInterval(()=>pushToCloud(user.uid), 5000);

      } else {
        updateAuthBtnText();
        setNotice("B·∫°n ƒëang ƒëƒÉng xu·∫•t.", false);
        window.__niniSaveTimer && clearInterval(window.__niniSaveTimer);
      }
    });

    /* 9) N·∫øu v√†o #/autumn m√† ch∆∞a c√≥ profile local ‚Üí t·∫°o t·∫°m ƒë·ªÉ ch∆°i offline */
    document.addEventListener("DOMContentLoaded", function () {
      if ((location.hash || '').toLowerCase().indexOf('/autumn') >= 0) {
        if (window.NiniApp && !(NiniApp.list() || []).length) NiniApp.debugCreate("Player");
      }
    });
  </script>
  <!-- =========================================================
       [H·∫æT] KH·ªêI ƒêƒÇNG NH·∫¨P + ƒê·ªíNG B·ªò TI·∫æN TR√åNH (Firebase)
  ========================================================== -->
</body>
</html>


