<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NiNi — Funny</title>

  <!-- 1) CSS nền tảng dùng chung cho toàn site -->
  <link rel="stylesheet" href="/public/theme/nini-base.css?v=20241008-02" />

  <!-- 2) Nạp util (tạo biến NINI toàn cục) rồi đến header -->
  <script src="/public/js/nini-utils.js?v=20241008-02" defer></script>
  <script src="/public/js/nini-header.js?v=20241008-02" defer></script>

  <!-- 3) (Tuỳ chọn) Theme override từ Netlify Functions -->
  <script>
  (function(){
    const KEY='NINI_THEME_CACHE_V1', ENDPOINT='/.netlify/functions/theme';
    function inject(css){ let s=document.getElementById('themeOverride');
      if(!s){ s=document.createElement('style'); s.id='themeOverride'; document.head.appendChild(s); }
      s.textContent = css;
    }
    try{
      const now=Date.now()/1000|0, cache=JSON.parse(localStorage.getItem(KEY)||'null');
      if(cache && (now-cache.ts)<3600) inject(cache.css);
      fetch(ENDPOINT,{cache:'no-store'}).then(r=>r.text()).then(css=>{
        if(css){ inject(css); localStorage.setItem(KEY, JSON.stringify({ts:now, css})); }
      }).catch(()=>{});
    }catch(_){}
  })();
  </script>
</head>

<body data-page="profile" style="--bg-url:url('/public/assets/bg/nini_home.webp')">
  <!-- Header dùng chung (logo + slogan + tabs + auth) -->
  <header class="site-header">
    <a class="brand" href="/#home" aria-label="NiNi — Funny">
      <img class="brand__logo" src="/public/assets/icons/logo_text.webp" alt="NiNi Funny" />
      <div class="brand__slogan">Chơi mê ly, bứt phá tư duy</div>
    </a>

    <nav class="tabs" aria-label="Chọn mùa">
      <a class="tab" href="/#home">Home</a>
      <a class="tab" href="/#spring">Spring</a>
      <a class="tab" href="/#summer">Summer</a>
      <a class="tab" href="/#autumn">Autumn</a>
      <a class="tab" href="/#winter">Winter</a>
    </nav>

    <div class="auth-area">
      <!-- avatar + logout (được `nini-header.js` tự áp UI khi đăng nhập) -->
      <a id="btnAvatar" class="avatar-btn" href="/profile.html" style="display:none" title="Hồ sơ">
        <img id="avatarImg" src="/public/assets/avatar/NV1.webp" alt="Tài khoản" />
      </a>
      <button id="btnLogout" class="auth-btn" data-role="btn-logout" data-show="in" style="display:none">
        Đăng xuất <span class="who"></span>
      </button>
      <button id="authBtn" class="auth-btn" data-role="btn-login" data-show="out">Đăng nhập / Đăng ký</button>
      <a id="adminBtn" class="admin-link is-hidden" href="/admin/index.html" rel="noopener">Admin</a>
    </div>
  </header>

  <!-- Khung trang -->
  <main class="page">
    <div class="grid-2">
      <!-- Panel thông tin cá nhân -->
      <section class="panel-glass">
        <h2>Thông tin cá nhân</h2>

        <div class="profile__head" style="margin:8px 0 14px">
          <img id="pfAvatar" class="avatar" src="/public/assets/avatar/NV1.webp" alt="">
          <div class="row">
            <button id="btnPick" class="btn sm">Tải ảnh mới</button>
            <button id="btnDefault" class="btn sm gray">Về mặc định</button>
            <input id="pickFile" type="file" accept="image/*" hidden>
          </div>
        </div>

        <div class="form">
          <div class="row">
            <label>Email</label>
            <input id="pfEmail" class="input underline field" type="email" disabled>
          </div>

          <div class="row">
            <label>Tên hiển thị</label>
            <input id="pfName" class="input underline field" placeholder="Bé NiNi">
          </div>

          <div class="row">
            <label>Ngày sinh</label>
            <input id="pfBirth" class="input underline field" type="date">
          </div>

          <div class="row">
            <label>Tỉnh/Thành</label>
            <input id="pfCity" class="input underline field" placeholder="Hà Nội / TP.HCM ...">
          </div>

          <div class="row">
            <label>Lớp/Khối</label>
            <input id="pfGrade" class="input underline field" placeholder="Lớp 2, Lớp 3...">
          </div>

          <div class="row">
            <label>Phụ huynh (tùy chọn)</label>
            <input id="pfParent" class="input underline field" placeholder="Tên phụ huynh">
          </div>

          <div class="row">
            <label>Số điện thoại</label>
            <input id="pfPhone" class="input underline field" placeholder="09xxxxxxxx">
            <button id="btnOTP" class="btn sm">Gửi OTP</button>
            <input id="pfOTP" class="input underline" style="width:92px" maxlength="6" placeholder="Mã 6 số">
          </div>

          <div class="row">
            <button id="btnSave" class="btn">Lưu hồ sơ</button>
            <button id="btnPwd" class="btn gray">Đổi / Thêm mật khẩu</button>
          </div>
        </div>

        <div id="recaptcha-container" style="min-height:1px"></div>
      </section>

      <!-- Panel thành tích -->
      <section class="panel-glass">
        <h2>Thành tích</h2>
        <div class="row"><label>XP</label><div class="field"><span id="stXP">0</span></div></div>
        <div class="row"><label>Xu</label><div class="field"><span id="stCoin">0</span></div></div>
        <div class="row">
          <label>Rương</label>
          <div class="field">
            <span id="stChest">0</span>
            <button id="btnSync" class="btn sm gray">Đồng bộ lại</button>
          </div>
        </div>
        <p class="muted" style="margin-top:8px">Rương mở cho XP/Xu ngẫu nhiên (local & cloud). Bạn có thể đồng bộ với tài khoản trò chơi.</p>
      </section>
    </div>

    <!-- Footer chips dùng chung -->
    <div class="footer-chips">
      <a class="chip" href="/#intro">Giới thiệu</a>
      <a class="chip" href="/#rules">Luật chơi</a>
      <a class="chip" href="/#forum">Diễn đàn</a>
      <a class="chip" href="/#feedback">Góp ý</a>
    </div>
  </main>

  <!-- Scripts dùng chung -->
  <script src="/public/js/effects.js?v=3" defer></script>
  <script src="/public/js/nini-header.js?v=3" defer></script>
  <script src="/public/js/nini-utils.js?v=3" defer></script>

  <!-- Trang profile: module import Firebase helper (file fb.js của bạn) -->
  <!-- Nếu file của bạn tên 'nini-fb.js' thì đổi đường dẫn phía dưới cho đúng. -->
  <script type="module">
    import {
      initFirebase, getServices, onAuth, logout,
      ensureRecaptcha, sendPhoneOTP, confirmPhoneOTP,
      readUser, saveUser,
      EmailAuthProvider, reauthenticateWithCredential, updatePassword
    } from "/public/js/fb.js";

    // Khởi tạo + lấy service (app/auth/db) – chỉ đọc, không chạm UI header
    initFirebase(); const { auth } = getServices(); // :contentReference[oaicite:0]{index=0}

    const $ = sel => document.querySelector(sel);

    // ----- DOM refs
    const pfAvatar = $("#pfAvatar");
    const pfEmail  = $("#pfEmail");
    const pfName   = $("#pfName");
    const pfBirth  = $("#pfBirth");
    const pfCity   = $("#pfCity");
    const pfGrade  = $("#pfGrade");
    const pfParent = $("#pfParent");
    const pfPhone  = $("#pfPhone");
    const pfOTP    = $("#pfOTP");

    const stXP     = $("#stXP");
    const stCoin   = $("#stCoin");
    const stChest  = $("#stChest");

    // ----- Ảnh đại diện
    const pickFile   = $("#pickFile");
    $("#btnPick").onclick = () => pickFile.click();
    pickFile.onchange = e => {
      const f = e.target.files?.[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = () => { pfAvatar.src = reader.result; };
      reader.readAsDataURL(f); // Lưu base64 vào Firestore (nhẹ thì ok, về sau bạn có thể chuyển qua Storage)
    };
    $("#btnDefault").onclick = () => { pfAvatar.src = "/public/assets/avatar/NV1.webp"; };

    // ----- OTP Phone
    let _confirmation = null;
    $("#btnOTP").onclick = async () => {
      const phone = pfPhone.value.trim();
      if (!phone) { alert("Nhập số điện thoại trước nhé!"); return; }
      try {
        ensureRecaptcha("recaptcha-container"); // tạo nếu chưa có
        _confirmation = await sendPhoneOTP(phone, "recaptcha-container"); // :contentReference[oaicite:1]{index=1}
        alert("Đã gửi OTP, kiểm tra tin nhắn nhé!");
      } catch (e) {
        alert("Gửi OTP lỗi: " + e.message);
      }
    };

    // ----- Save hồ sơ
    $("#btnSave").onclick = async () => {
      const u = auth.currentUser;
      if (!u) { alert("Bạn chưa đăng nhập."); return; }

      // Nếu có nhập mã OTP, thử xác nhận (tùy chọn)
      const code = pfOTP.value.trim();
      if (_confirmation && code.length === 6) {
        try {
          await confirmPhoneOTP(_confirmation, code); // xác minh xong là tài khoản đã “trusted phone”
        } catch (e) { alert("OTP sai hoặc hết hạn: " + e.message); return; }
      }

      const data = {
        email: u.email,
        displayName: pfName.value.trim(),
        birthday: pfBirth.value || null,
        city: pfCity.value.trim(),
        grade: pfGrade.value.trim(),
        parentName: pfParent.value.trim(),
        phone: pfPhone.value.trim(),
        avatarUrl: pfAvatar.src,
      };
      try {
        await saveUser(u.uid, data); // :contentReference[oaicite:2]{index=2}
        alert("Đã lưu hồ sơ!");
      } catch (e) {
        alert("Lỗi lưu hồ sơ: " + e.message);
      }
    };

    // ----- Đổi / thêm mật khẩu cơ bản (email user)
    $("#btnPwd").onclick = async () => {
      const u = auth.currentUser;
      if (!u || !u.email) { alert("Bạn cần đăng nhập bằng email để đổi mật khẩu."); return; }
      const oldPwd = prompt("Nhập mật khẩu hiện tại (để xác thực):");
      if (!oldPwd) return;
      const newPwd = prompt("Nhập mật khẩu mới (>= 8 ký tự):");
      if (!newPwd || newPwd.length < 8) { alert("Mật khẩu mới quá ngắn."); return; }
      try {
        const cred = EmailAuthProvider.credential(u.email, oldPwd);
        await reauthenticateWithCredential(u, cred);
        await updatePassword(u, newPwd);
        alert("Đổi mật khẩu thành công.");
      } catch (e) {
        alert("Lỗi đổi mật khẩu: " + e.message);
      }
    };

    // ----- Đồng bộ “thành tích” (mock: đọc về sau từ cloud/game)
    $("#btnSync").onclick = async () => {
      alert("Tính năng đồng bộ đang được chuẩn bị.");
    };

    // ----- Nạp dữ liệu khi đăng nhập
    onAuth(async (u) => {                    // :contentReference[oaicite:3]{index=3}
      if (!u) { location.href = "/#home"; return; }
      pfEmail.value = u.email || "";
      try {
        const data = await readUser(u.uid) || {};
        pfName.value   = data.displayName || "";
        pfBirth.value  = data.birthday    || "";
        pfCity.value   = data.city        || "";
        pfGrade.value  = data.grade       || "";
        pfParent.value = data.parentName  || "";
        pfPhone.value  = data.phone       || "";
        pfAvatar.src   = data.avatarUrl   || "/public/assets/avatar/NV1.webp";

        stXP.textContent    = data.xp ?? 0;
        stCoin.textContent  = data.coin ?? 0;
        stChest.textContent = data.chest ?? 0;
      } catch (e) {
        console.warn("Load profile fail:", e);
      }
    });
  </script>
</body>
</html>

