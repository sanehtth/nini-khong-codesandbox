<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>H·ªì s∆° & Th√†nh t√≠ch ‚Äî NiNi</title>
  <link rel="icon" href="/public/assets/icons/logonini.webp" type="image/webp" />
  <link rel="stylesheet" href="/styles.css?v=11" />
  <style>
    /* ====== Trang Profile ‚Äî b·ªë c·ª•c nh·∫π nh√†ng ====== */
    .page-wrap{ width:min(1100px, 94vw); margin:18px auto 32px; display:grid; gap:16px; grid-template-columns: 1.2fr .8fr; }
    .card{
      background: var(--glass-2); border:1px solid rgba(17,24,39,.12);
      border-radius:16px; padding:16px 16px 18px; color:var(--text);
      box-shadow: inset 0 0 0 1px rgba(17,24,39,.06);
    }
    .card h2{ margin:0 0 10px; font-size:20px }
    .meta{ font-size:13px; color:var(--text-dim); margin:-2px 0 12px }
    .fld{ display:grid; grid-template-columns: 180px 1fr; align-items:center; gap:10px; margin:8px 0 }
    .fld > span{ color:var(--text-dim); font-size:14px }
    .fld input, .fld select{
      width:100%; padding:10px 12px; color:var(--text);
      background:transparent; border:none; border-bottom:1px solid rgba(17,24,39,.28); outline:none
    }
    .row{ display:flex; gap:10px; margin-top:12px; align-items:center }
    .kpi{ display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; margin:8px 0 10px }
    .kpi .tile{
      background: rgba(255,255,255,.18); border:1px solid rgba(17,24,39,.12);
      border-radius:12px; padding:12px; text-align:center
    }
    .kpi .tile h3{ margin:0; font-size:13px; color:var(--text-dim) }
    .kpi .tile .val{ font-size:22px; font-weight:800; margin-top:4px }
    .bar{ height:8px; background:rgba(17,24,39,.12); border-radius:999px; overflow:hidden }
    .bar > i{ display:block; height:100%; background:linear-gradient(90deg,#ffd44d,#7bd86a,#4fb1ff,#b88752) }
    .pill-ghost{ padding:6px 10px; border-radius:999px; border:1px dashed rgba(17,24,39,.25); color:var(--text-dim) }
    .reward{
      display:grid; grid-template-columns: 1fr; gap:10px; margin-top:10px;
      background: rgba(255,255,255,.14); border:1px solid rgba(17,24,39,.12); border-radius:12px; padding:12px
    }
    .reward .chest-row{ display:flex; align-items:center; justify-content:space-between; gap:12px }
    .reward .chest-btn{ display:inline-flex; align-items:center; gap:8px }
    .muted{ color:var(--text-dim); font-size:13px }
    .note{ font-size:12px; color:var(--text-dim) }
    .ok{ color:#0f5132 } .bad{ color:#7f1d1d }

    @media (max-width: 920px){ .page-wrap{ grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="site-header">
    <a class="brand" href="/">
      <img class="brand__logo" src="/public/assets/icons/logo_text.webp" alt="NiNi Funny" />
      <div class="brand__slogan">Ch∆°i m√™ ly, b·ª©t ph√° t∆∞ duy</div>
    </a>
    <nav class="tabs" aria-label="ƒêi·ªÅu h∆∞·ªõng nhanh">
      <a class="tab" href="/#/">‚Üê V·ªÅ trang ch·ªß</a>
    </nav>
    <a class="auth-btn" id="signoutBtn" href="javascript:void(0)">ƒêƒÉng xu·∫•t</a>
  </header>

  <!-- MAIN -->
  <main class="viewport">
    <div class="page-wrap">
      <!-- =========================================================
           [B·∫ÆT ƒê·∫¶U] KH·ªêI 1 ‚Äî TH√îNG TIN C√Å NH√ÇN + X√ÅC TH·ª∞C SƒêT (OTP)
      ========================================================== -->
      <section class="card">
        <h2>Th√¥ng tin c√° nh√¢n</h2>
        <div class="meta" id="authHint">ƒêang ki·ªÉm tra ƒëƒÉng nh·∫≠p‚Ä¶</div>

        <form id="profileForm" autocomplete="on">
          <div class="fld"><span>Email</span><input type="email" id="pf_email" placeholder="you@example.com" autocomplete="email" /></div>
          <div class="fld"><span>T√™n hi·ªÉn th·ªã</span><input type="text" id="pf_displayName" placeholder="B√© NiNi" /></div>
          <div class="fld"><span>Ng√†y sinh</span><input type="date" id="pf_dob" /></div>
          <div class="fld"><span>Ph·ª• huynh (tu·ª≥ ch·ªçn)</span><input type="text" id="pf_guardian" placeholder="T√™n ph·ª• huynh" /></div>

          <!-- OTP Phone -->
          <div class="fld"><span>S·ªë ƒëi·ªán tho·∫°i</span>
            <div class="row" style="flex-wrap:wrap">
              <input type="tel" id="pf_phone" inputmode="tel" placeholder="09xxxxxxxx" style="flex:1; min-width:220px" />
              <button class="btn btn-ghost" type="button" id="btnSendOtp">G·ª≠i OTP</button>
              <input type="text" id="otp_code" inputmode="numeric" placeholder="Nh·∫≠p m√£ 6 s·ªë" style="width:140px" />
              <button class="btn" type="button" id="btnVerifyOtp">X√°c th·ª±c</button>
            </div>
          </div>

          <div class="fld"><span>T·ªânh/Th√†nh</span><input type="text" id="pf_city" placeholder="H√† N·ªôi / TP.HCM ..." /></div>
          <div class="fld"><span>L·ªõp/Kh·ªëi</span><input type="text" id="pf_grade" placeholder="L·ªõp 2, L·ªõp 3..." /></div>

          <div class="row">
            <button class="btn" type="submit">L∆∞u h·ªì s∆°</button>
            <a class="btn btn-ghost" href="/">V·ªÅ trang ch·ªß</a>
            <span id="saveNote" class="note" hidden></span>
          </div>
        </form>

        <!-- reCAPTCHA container (·∫©n) cho Phone OTP -->
        <div id="recaptcha-container" style="height:0; overflow:hidden"></div>
      </section>
      <!-- =========================================================
           [H·∫æT] KH·ªêI 1 ‚Äî TH√îNG TIN C√Å NH√ÇN + X√ÅC TH·ª∞C SƒêT (OTP)
      ========================================================== -->

      <!-- =========================================================
           [B·∫ÆT ƒê·∫¶U] KH·ªêI 2 ‚Äî TH√ÄNH T√çCH (XP ‚Ä¢ Xu ‚Ä¢ R∆∞∆°ng b·∫•t ng·ªù)
      ========================================================== -->
      <section class="card">
        <h2>Th√†nh t√≠ch</h2>
        <div class="meta">Theo d√µi ti·∫øn tr√¨nh h·ªçc & ph·∫ßn th∆∞·ªüng</div>

        <div class="kpi">
          <div class="tile">
            <h3>XP</h3>
            <div class="val" id="valXP">0</div>
            <div class="bar"><i id="barXP" style="width:0%"></i></div>
          </div>
          <div class="tile">
            <h3>Xu</h3>
            <div class="val" id="valCoins">0</div>
            <div class="bar"><i id="barCoins" style="width:0%"></i></div>
          </div>
          <div class="tile">
            <h3>R∆∞∆°ng</h3>
            <div class="val"><span id="valChests">0</span> üì¶</div>
            <div class="muted">R∆∞∆°ng m·ªü s·∫Ω cho XP / Xu ng·∫´u nhi√™n</div>
          </div>
        </div>

        <div class="reward">
          <div class="chest-row">
            <div class="muted">Nh·∫≠n qu√† b·∫•t ng·ªù khi ho√†n th√†nh nhi·ªám v·ª• h·∫±ng ng√†y, ƒë·∫°t m·ªëc XP, ho·∫∑c t·ª´ admin.</div>
            <div>
              <button class="btn chest-btn" id="btnOpenChest" disabled>üéÅ M·ªü 1 r∆∞∆°ng</button>
            </div>
          </div>
          <div class="row"><span class="pill-ghost" id="lastReward">Ch∆∞a c√≥ ph·∫ßn th∆∞·ªüng n√†o.</span></div>
        </div>

        <div class="row">
          <button class="btn btn-ghost" id="btnRefresh">‚Üª ƒê·ªìng b·ªô l·∫°i</button>
          <span class="note">D·ªØ li·ªáu ƒë·ªìng b·ªô v·ªõi t√†i kho·∫£n tr√≤ ch∆°i (local & cloud).</span>
        </div>
      </section>
      <!-- =========================================================
           [H·∫æT] KH·ªêI 2 ‚Äî TH√ÄNH T√çCH
      ========================================================== -->
    </div>
  </main>

  <!-- =========================================================
       [B·∫ÆT ƒê·∫¶U] SCRIPT ‚Äî AUTH + FIRESTORE + OTP + TH√ÄNH T√çCH
       - Trang n√†y l√† n∆°i duy nh·∫•t c√≥ n√∫t ƒêƒÉng xu·∫•t.
       - Khi ng∆∞·ªùi d√πng ƒëƒÉng nh·∫≠p l·∫ßn ƒë·∫ßu, c√≥ th·ªÉ c·∫≠p nh·∫≠t h·ªì s∆° t·∫°i ƒë√¢y.
  ========================================================== -->
  <script type="module">
    /* Firebase (CDN) */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signOut,
      RecaptchaVerifier, signInWithPhoneNumber, linkWithPhoneNumber
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    /* 1) THAY c·∫•u h√¨nh c·ªßa b·∫°n (gi·ªëng file index.html) */
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "XXXX",
      appId: "XXXX"
    };

    /* 2) Kh·ªüi t·∫°o */
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    /* 3) H·∫±ng s·ªë d√πng chung (kh·ªõp file game) */
    const LS_ACCOUNTS = "NINI_ACCOUNTS_V3";
    const LS_ACTIVE   = "NINI_ACTIVE_USER_V3";

    /* ===== Helpers: local <-> UI ===== */
    function readLocalProfile() {
      try {
        const accs = JSON.parse(localStorage.getItem(LS_ACCOUNTS) || "{}");
        const act  = JSON.parse(localStorage.getItem(LS_ACTIVE)   || "null");
        if (!act || !accs[act]) return null;
        return { uid: act, profile: accs[act] };
      } catch { return null; }
    }
    function writeLocalProfile(uid, profile) {
      const accs = {};
      accs[uid] = profile;
      localStorage.setItem(LS_ACCOUNTS, JSON.stringify(accs));
      localStorage.setItem(LS_ACTIVE, JSON.stringify(uid));
    }

    function setText(id, v){ const el=document.getElementById(id); if(el) el.textContent = v; }
    function setBar(id, pct){ const el=document.getElementById(id); if(el) el.style.width = Math.max(0,Math.min(100,pct)) + "%"; }
    function toast(msg, ok=true){
      const t=document.createElement('div'); t.textContent=msg;
      t.style.cssText="position:fixed;top:12px;right:12px;padding:8px 12px;border-radius:12px;z-index:9999;backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);background:rgba(255,255,255,.22);border:1px solid rgba(17,24,39,.14);color:"+(ok?"#0f5132":"#7f1d1d");
      document.body.appendChild(t); setTimeout(()=>t.remove(),2300);
    }

    /* 4) T·∫£i/ghi Firestore profile */
    async function loadCloudProfile(uid){
      const ref = doc(db,"profiles",uid);
      const snap = await getDoc(ref);
      return snap.exists() ? snap.data() : null;
    }
    async function saveCloudProfile(uid, data){
      const ref = doc(db,"profiles",uid);
      await setDoc(ref, { ...data, updatedAt: Date.now() }, { merge:true });
    }

    /* 5) Render th√†nh t√≠ch */
    function renderKPI(pf){
      setText("valXP",    pf.xp|0);
      setText("valCoins", pf.coins|0);
      setText("valChests", pf.chests|0);
      setBar("barXP",    Math.min(100, (pf.xp|0)%100));   // v√≠ d·ª•: hi·ªÉn th·ªã % m·ªëc 100 XP
      setBar("barCoins", Math.min(100, (pf.coins|0)%1000));
      document.getElementById("btnOpenChest").disabled = !(pf.chests>0);
    }

    /* 6) L·∫•y & c·∫≠p nh·∫≠t form */
    function readForm(){
      return {
        email: document.getElementById("pf_email").value.trim(),
        name:  document.getElementById("pf_displayName").value.trim(),
        dob:   document.getElementById("pf_dob").value || null,
        guardian: document.getElementById("pf_guardian").value.trim() || null,
        phone: document.getElementById("pf_phone").value.trim() || null,
        city:  document.getElementById("pf_city").value.trim() || null,
        grade: document.getElementById("pf_grade").value.trim() || null,
      };
    }
    function fillForm(u, pf, cloud){
      document.getElementById("pf_email").value = u.email || "";
      document.getElementById("pf_displayName").value = u.displayName || (pf && pf.name) || "";
      document.getElementById("pf_dob").value = cloud?.dob || "";
      document.getElementById("pf_guardian").value = cloud?.guardian || "";
      document.getElementById("pf_phone").value = (u.phoneNumber || cloud?.phone || "");
      document.getElementById("pf_city").value = cloud?.city || "";
      document.getElementById("pf_grade").value = cloud?.grade || "";
    }

    /* 7) OTP Phone ‚Äî Recaptcha + g·ª≠i + x√°c th·ª±c */
    let recaptcha, confirmationResult;
    function ensureRecaptcha(){
      if (recaptcha) return recaptcha;
      // v2 invisible captcha
      // eslint-disable-next-line no-undef
      recaptcha = new RecaptchaVerifier(auth, "recaptcha-container", { size:"invisible" });
      return recaptcha;
    }
    async function sendOTP(){
      const phone = document.getElementById("pf_phone").value.trim();
      if (!phone) return toast("Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i tr∆∞·ªõc khi g·ª≠i OTP.", false);
      try{
        ensureRecaptcha();
        // N·∫øu user ƒë√£ ƒëƒÉng nh·∫≠p, link phone v√†o t√†i kho·∫£n; n·∫øu ch∆∞a, c√≥ th·ªÉ signInWithPhoneNumber (kh√¥ng khuy·∫øn ngh·ªã ·ªü trang n√†y).
        confirmationResult = await signInWithPhoneNumber(auth, phone, recaptcha);
        toast("ƒê√£ g·ª≠i OTP. Vui l√≤ng ki·ªÉm tra ƒëi·ªán tho·∫°i.", true);
      }catch(e){ toast("G·ª≠i OTP th·∫•t b·∫°i: " + (e.code||e.message), false); }
    }
    async function verifyOTP(){
      const code = document.getElementById("otp_code").value.trim();
      if (!confirmationResult || !code) return toast("Ch∆∞a g·ª≠i OTP ho·∫∑c thi·∫øu m√£.", false);
      try{
        await confirmationResult.confirm(code);
        toast("X√°c th·ª±c s·ªë ƒëi·ªán tho·∫°i th√†nh c√¥ng!", true);
      }catch(e){ toast("M√£ OTP kh√¥ng ƒë√∫ng ho·∫∑c h·∫øt h·∫°n.", false); }
    }

    /* 8) M·ªü r∆∞∆°ng: random th∆∞·ªüng XP/Xu, tr·ª´ 1 r∆∞∆°ng */
    function randomReward(){
      const t = Math.random();
      if (t < .5) return { type:"coins", amount: 50 + Math.floor(Math.random()*151) }; // 50‚Äî200
      if (t < .85) return { type:"xp", amount: 20 + Math.floor(Math.random()*81) };     // 20‚Äî100
      return { type:"both", amount: [30+Math.floor(Math.random()*71), 80+Math.floor(Math.random()*121)] }; // xp, coins
    }

    async function openChestHandler(uid){
      const cur = readLocalProfile();
      if (!cur || cur.uid !== uid) return;
      const pf = cur.profile;
      if (!(pf.chests>0)) return toast("B·∫°n ch∆∞a c√≥ r∆∞∆°ng ƒë·ªÉ m·ªü.", false);

      const rw = randomReward();
      pf.chests = (pf.chests|0) - 1;
      if (rw.type === "coins"){ pf.coins = (pf.coins|0) + rw.amount; document.getElementById("lastReward").textContent = `+${rw.amount} xu`; }
      else if (rw.type === "xp"){ pf.xp = (pf.xp|0) + rw.amount; document.getElementById("lastReward").textContent = `+${rw.amount} XP`; }
      else { pf.xp += rw.amount[0]; pf.coins += rw.amount[1]; document.getElementById("lastReward").textContent = `+${rw.amount[0]} XP, +${rw.amount[1]} xu`; }

      writeLocalProfile(uid, pf);
      renderKPI(pf);
      try{ await saveCloudProfile(uid, { xp:pf.xp|0, coins:pf.coins|0, chests:pf.chests|0 }); }catch{}
      toast("ƒê√£ m·ªü r∆∞∆°ng!", true);
    }

    /* 9) L∆∞u h·ªì s∆° */
    async function saveProfile(uid){
      const saveNote = document.getElementById("saveNote");
      const f = readForm();
      saveNote.hidden = false; saveNote.textContent = "ƒêang l∆∞u‚Ä¶";

      // c·∫≠p nh·∫≠t cloud profile (th√¥ng tin c√° nh√¢n)
      try{
        await saveCloudProfile(uid, {
          name: f.name || null, dob:f.dob||null, guardian:f.guardian||null, phone:f.phone||null, city:f.city||null, grade:f.grade||null
        });
        saveNote.textContent = "ƒê√£ l∆∞u h·ªì s∆°.";
        toast("L∆∞u h·ªì s∆° th√†nh c√¥ng", true);
      }catch(e){
        saveNote.textContent = "Kh√¥ng l∆∞u ƒë∆∞·ª£c: " + (e.code||e.message);
        toast("L∆∞u h·ªì s∆° th·∫•t b·∫°i", false);
      }
    }

    /* 10) ƒê·ªìng b·ªô l·∫°i (refresh) */
    async function refreshAll(uid){
      const cloud = await loadCloudProfile(uid);
      const local = readLocalProfile();
      const pf = local?.profile || { name:"Player", coins:300, xp:0, chests:0, unlocked:{topics:{},categories:{}} };

      // ∆Øu ti√™n cloud n·∫øu c√≥
      const merged = {
        ...pf,
        ...(cloud || {}),
        name: cloud?.name || pf.name,
        coins: (cloud?.coins ?? pf.coins) | 0,
        xp:    (cloud?.xp    ?? pf.xp)    | 0,
        chests:(cloud?.chests?? pf.chests)| 0,
        unlocked: cloud?.unlocked || pf.unlocked
      };

      writeLocalProfile(uid, merged);
      renderKPI(merged);
      return { cloud, merged };
    }

    /* 11) Lu·ªìng trang Profile */
    const elEmail = document.getElementById("pf_email");
    const elName  = document.getElementById("pf_displayName");
    const btnSendOtp = document.getElementById("btnSendOtp");
    const btnVerifyOtp = document.getElementById("btnVerifyOtp");

    btnSendOtp.addEventListener("click", sendOTP);
    btnVerifyOtp.addEventListener("click", verifyOTP);

    document.getElementById("profileForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const u = auth.currentUser;
      if (!u) return toast("Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc.", false);
      await saveProfile(u.uid);
      // n·∫øu user ƒë·ªïi t√™n, l∆∞u sang local profile name
      const cur = readLocalProfile(); if (cur && cur.uid === u.uid) { cur.profile.name = (elName.value.trim() || cur.profile.name); writeLocalProfile(u.uid, cur.profile); }
    });

    document.getElementById("btnOpenChest").addEventListener("click", async ()=>{
      const u = auth.currentUser; if (!u) return toast("Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc.", false);
      await openChestHandler(u.uid);
    });
    document.getElementById("btnRefresh").addEventListener("click", async ()=>{
      const u = auth.currentUser; if (!u) return;
      await refreshAll(u.uid); toast("ƒê·ªìng b·ªô xong.", true);
    });

    document.getElementById("signoutBtn").addEventListener("click", async ()=>{
      try{ await signOut(auth); toast("ƒê√£ ƒëƒÉng xu·∫•t", true); location.href = "/"; }
      catch(e){ toast("ƒêƒÉng xu·∫•t l·ªói: " + (e.code||e.message), false); }
    });

    onAuthStateChanged(auth, async (user)=>{
      const hint = document.getElementById("authHint");
      if (!user) {
        hint.innerHTML = 'B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p. <a href="/#/" class="tab">‚Üê V·ªÅ trang ch·ªß</a>';
        // Kho√° form
        document.getElementById("profileForm").querySelectorAll("input,button").forEach(el => el.disabled = true);
        return;
      }
      // Cho ph√©p ch·ªânh
      document.getElementById("profileForm").querySelectorAll("input,button").forEach(el => el.disabled = false);

      const local = readLocalProfile();
      const cloud = await loadCloudProfile(user.uid);
      // n·∫øu local tr·ªëng -> t·∫°o m·∫∑c ƒë·ªãnh
      const base = local?.profile || { name: user.displayName || "Player", coins: 300, xp:0, chests: 0, createdAt: Date.now(), unlocked:{topics:{},categories:{}} };
      // overlay cloud
      const merged = { ...base, ...(cloud||{}) };

      writeLocalProfile(user.uid, merged);
      fillForm(user, merged, cloud);
      renderKPI(merged);
      hint.innerHTML = `ƒêang ƒëƒÉng nh·∫≠p v·ªõi <strong>${user.email || user.phoneNumber || "t√†i kho·∫£n"}</strong>. B·∫°n c√≥ th·ªÉ c·∫≠p nh·∫≠t h·ªì s∆° v√† xem th√†nh t√≠ch t·∫°i ƒë√¢y.`;
    });
  </script>
  <!-- =========================================================
       [H·∫æT] SCRIPT ‚Äî AUTH + FIRESTORE + OTP + TH√ÄNH T√çCH
  ========================================================== -->
</body>
</html>
