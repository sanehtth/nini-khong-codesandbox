<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NiNi ‚Äî H·ªì s∆° & Th√†nh t√≠ch</title>
  <link rel="icon" href="/public/assets/icons/logonini.webp" type="image/webp" />
  <link rel="stylesheet" href="/styles.css?v=21" />
</head>
<body style="--bg-url:url('/public/assets/bg/nini_home.webp')">
  <!-- ===== Header gi·ªëng index ===== -->
  <header class="site-header">
    <a class="brand" href="/#home" aria-label="NiNi ‚Äî Funny">
      <img class="brand__logo" src="/public/assets/icons/logo_text.webp" alt="NiNi Funny" />
      <div class="brand__slogan">Ch∆°i m√™ ly, b·ª©t ph√° t∆∞ duy</div>
    </a>

    <div class="auth-area">
      <!-- CH∆ØA login -->
      <button id="authBtn" class="auth-btn" data-show="out">ƒêƒÉng nh·∫≠p / ƒêƒÉng k√Ω</button>
      <!-- ƒê√É login -->
      <button id="btnLogout" class="auth-btn" data-show="in" style="display:none">
        ƒêƒÉng xu·∫•t <span class="who"></span>
      </button>
      <a class="btn" href="/index.html">V·ªÅ trang ch·ªß</a>
      <a id="adminBtn" class="admin-link is-hidden" href="/admin/login.html" rel="noopener">Admin</a>
    </div>
  </header>

  <!-- ===== Main ===== -->
  <main class="page-hero bg-cover">
    <div class="page-wrap">
      <!-- Th√¥ng tin c√° nh√¢n -->
      <section class="card">
        <h2>Th√¥ng tin c√° nh√¢n</h2>
        <div class="meta" id="authHint">ƒêang ki·ªÉm tra ƒëƒÉng nh·∫≠p‚Ä¶</div>

        <div class="grid-1">
          <div class="avatar-wrap">
            <img id="pf_avatar_img" class="avatar" src="/public/assets/avatar/NV1.webp" alt="Avatar" />
            <div>
              <div class="muted"> Nh·∫•n ‚ÄúCh·ªçn avatar‚Äù ƒë·ªÉ ƒë·ªïi.</div>
              <div class="row">
                <button type="button" class="btn" id="btnPickAvatar">Ch·ªçn avatar</button>
                <span id="owningHint" class="muted"></span>
              </div>
            </div>
          </div>
        </div>

        <form id="profileForm" autocomplete="on">
          <div class="fld"><span>Email</span><input type="email" id="pf_email" readonly placeholder="‚Äî s·∫Ω t·ª± ƒëi·ªÅn ‚Äî" /></div>
          <div class="fld"><span>T√™n hi·ªÉn th·ªã</span><input type="text" id="pf_displayName" placeholder="B√© NiNi" /></div>
          <div class="fld"><span>Gi·ªõi t√≠nh</span>
            <select id="pf_gender">
              <option value="">‚Äî Ch·ªçn ‚Äî</option>
              <option value="male">Nam</option>
              <option value="female">N·ªØ</option>
              <option value="other">Kh√°c</option>
            </select>
          </div>
          <div class="fld"><span>Ng√†y sinh</span><input type="date" id="pf_dob" /></div>
          <div class="fld"><span>Ph·ª• huynh</span><input type="text" id="pf_guardian" placeholder="T√™n ph·ª• huynh (tu·ª≥ ch·ªçn)" /></div>

          <!-- OTP Phone -->
          <div class="fld"><span>S·ªë ƒëi·ªán tho·∫°i</span>
            <div class="row">
              <input type="tel" id="pf_phone" inputmode="tel" placeholder="09xxxxxxxx" style="flex:1; min-width:220px" />
              <button class="btn btn-ghost" type="button" id="btnSendOtp">G·ª≠i OTP</button>
              <input type="text" id="otp_code" inputmode="numeric" placeholder="M√£ 6 s·ªë" style="width:140px" />
              <button class="btn" type="button" id="btnVerifyOtp">X√°c th·ª±c</button>
            </div>
          </div>

          <div class="fld"><span>T·ªânh/Th√†nh</span><input type="text" id="pf_city" placeholder="H√† N·ªôi / TP.HCM ..." /></div>
          <div class="fld"><span>L·ªõp/Kh·ªëi</span><input type="text" id="pf_grade" placeholder="L·ªõp 2, L·ªõp 3..." /></div>

          <div class="row">
            <button class="btn" type="submit">L∆∞u h·ªì s∆°</button>
            <a class="btn btn-ghost" href="/">V·ªÅ trang ch·ªß</a>
            <span id="saveNote" class="note" hidden></span>
          </div>
        </form>

        <!-- ƒê·ªïi m·∫≠t kh·∫©u -->
        <div class="pw-card">
          <h3>ƒê·ªïi m·∫≠t kh·∫©u</h3>
          <div class="muted">√Åp d·ª•ng cho Email/Password. N·∫øu ƒëƒÉng nh·∫≠p Google, b·∫°n c√≥ th·ªÉ <strong>th√™m</strong> m·∫≠t kh·∫©u ƒë·ªÉ ƒëƒÉng nh·∫≠p b·∫±ng email & m·∫≠t kh·∫©u sau n√†y.</div>
          <div class="row">
            <input type="password" id="pw_current" placeholder="M·∫≠t kh·∫©u hi·ªán t·∫°i (n·∫øu ƒë√£ c√≥)" />
            <input type="password" id="pw_new" placeholder="M·∫≠t kh·∫©u m·ªõi (‚â• 8 k√Ω t·ª±)" />
            <input type="password" id="pw_confirm" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi" />
            <button class="btn" id="btnChangePw" type="button">ƒê·ªïi / Th√™m m·∫≠t kh·∫©u</button>
          </div>
          <div id="pwNote" class="note"></div>
        </div>

        <!-- Recaptcha (·∫©n) cho OTP -->
        <div id="recaptcha-container" style="height:0; overflow:hidden"></div>
      </section>

      <!-- Th√†nh t√≠ch -->
      <section class="card">
        <h2>Th√†nh t√≠ch</h2>
        <div class="meta">Theo d√µi ti·∫øn tr√¨nh h·ªçc & ph·∫ßn th∆∞·ªüng</div>

        <div class="kpi">
          <div class="tile"><h3>XP</h3><div class="val" id="valXP">0</div><div class="bar"><i id="barXP" style="width:0%"></i></div></div>
          <div class="tile"><h3>Xu</h3><div class="val" id="valCoins">0</div><div class="bar"><i id="barCoins" style="width:0%"></i></div></div>
          <div class="tile"><h3>R∆∞∆°ng</h3><div class="val"><span id="valChests">0</span> üì¶</div><div class="muted">R∆∞∆°ng m·ªü cho XP/Xu ng·∫´u nhi√™n</div></div>
        </div>

        <div class="reward">
          <div class="chest-row">
            <div class="muted">Nh·∫≠n qu√† khi ho√†n th√†nh nhi·ªám v·ª•/ng√†y ho·∫∑c ƒë·∫°t m·ªëc XP.</div>
            <div><button class="btn" id="btnOpenChest" disabled>üéÅ M·ªü 1 r∆∞∆°ng</button></div>
          </div>
          <div class="row"><span class="pill-ghost" id="lastReward">Ch∆∞a c√≥ ph·∫ßn th∆∞·ªüng n√†o.</span></div>
        </div>

        <div class="row">
          <button class="btn btn-ghost" id="btnRefresh">‚Üª ƒê·ªìng b·ªô l·∫°i</button>
          <span class="note">ƒê·ªìng b·ªô v·ªõi t√†i kho·∫£n tr√≤ ch∆°i (local & cloud).</span>
        </div>
      </section>
    </div>
  </main>
<!-- ====== an nut admin ====== -->
  <script>
  (function adminHotkey(){
    const btn = document.getElementById('adminBtn'); if (!btn) return;
    const KEY = 'nini_admin_btn';
    function apply(){ const on = localStorage.getItem(KEY) === 'on'; btn.classList.toggle('is-hidden', !on); }
    apply();
    window.addEventListener('keydown', (e)=>{
      const hit = (e.altKey && (e.key==='a' || e.key==='A')) || (e.ctrlKey && e.altKey && (e.key==='a' || e.key==='A'));
      if (hit){
        e.preventDefault();
        const on = localStorage.getItem(KEY) === 'on';
        localStorage.setItem(KEY, on ? 'off' : 'on');
        apply();
      }
    });
  })();
</script>

  <!-- ====== MODAL AVATAR SHOP ====== -->
  <div id="shopModal" class="modal" aria-hidden="true">
    <div class="modal__backdrop" data-close></div>
    <section class="modal__panel">
      <div class="shop__head">
        <strong>Avatar c·ªßa t√¥i & C·ª≠a h√†ng</strong>
        <div class="row">
          <span id="shopBalance" class="pill-ghost">Xu: 0 ‚Ä¢ XP: 0</span>
          <button class="btn small" data-close>ƒê√≥ng</button>
        </div>
      </div>
      <div id="shopGrid" class="shop__grid" aria-live="polite"></div>
      <div class="row" style="padding:0 12px 12px 12px">
        <input id="giftInput" class="btn" style="flex:1; text-align:left" placeholder="Nh·∫≠p ID avatar ƒë·ªÉ nh·∫≠n qu√† (v√≠ d·ª•: NV2)" />
        <button id="btnGiftClaim" class="btn small">Nh·∫≠n qu√†</button>
      </div>
    </section>
  </div>

  <!-- ===== Script ===== -->
  <script type="module">
    /* Firebase */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signOut,
      RecaptchaVerifier, signInWithPhoneNumber,
      EmailAuthProvider, reauthenticateWithCredential, updatePassword,
      linkWithCredential, reauthenticateWithPopup, GoogleAuthProvider
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBdaMS7aI03wHLhi1Md2QDitJFkA61IYUU",
      authDomain: "nini-8f3d4.firebaseapp.com",
      projectId: "nini-8f3d4",
      storageBucket: "nini-8f3d4.firebasestorage.app",
      messagingSenderId: "991701821645",
      appId: "1:991701821645:web:fb21c357562c6c801da184"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    /* ===== Helpers ===== */
    const $  = (s, r=document)=>r.querySelector(s);
    const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
    const LS_ACCOUNTS="NINI_ACCOUNTS_V3", LS_ACTIVE="NINI_ACTIVE_USER_V3";

    function readLocalProfile(){
      try{
        const accs=JSON.parse(localStorage.getItem(LS_ACCOUNTS)||"{}");
        const act =JSON.parse(localStorage.getItem(LS_ACTIVE)||"null");
        if(!act||!accs[act]) return null;
        return {uid:act, profile:accs[act]};
      }catch{return null;}
    }
    function writeLocalProfile(uid, profile){
      const accs={}; accs[uid]=profile;
      localStorage.setItem(LS_ACCOUNTS,JSON.stringify(accs));
      localStorage.setItem(LS_ACTIVE,JSON.stringify(uid));
    }
    function setText(id,v){ const el=document.getElementById(id); if(el) el.textContent=v; }
    function setBar(id,p){ const el=document.getElementById(id); if(el) el.style.width=Math.max(0,Math.min(100,p))+"%"; }
    function toast(msg, ok=true){
      const t=document.createElement('div');
      t.textContent=msg;
      t.style.cssText="position:fixed;top:12px;right:12px;padding:8px 12px;border-radius:12px;z-index:9999;backdrop-filter:blur(6px);background:rgba(255,255,255,.22);border:1px solid rgba(17,24,39,.14);color:"+(ok?"#0f5132":"#7f1d1d");
      document.body.appendChild(t); setTimeout(()=>t.remove(),2600);
    }

    async function loadCloudProfile(uid){ const s=await getDoc(doc(db,"users",uid)); return s.exists()?s.data():null; }
    async function saveCloudProfile(uid,data){ await setDoc(doc(db,"users",uid),{...data,updatedAt:Date.now()},{merge:true}); }

    function renderKPI(pf){
      setText("valXP",pf.xp|0); setText("valCoins",pf.coins|0); setText("valChests",pf.chests|0);
      setBar("barXP",Math.min(100,(pf.xp|0)%100)); setBar("barCoins",Math.min(100,(pf.coins|0)%1000));
      const btn = $("#btnOpenChest"); if (btn) btn.disabled = !(pf.chests>0);
      const bal = $("#shopBalance"); if (bal) bal.textContent = `Xu: ${pf.coins|0} ‚Ä¢ XP: ${pf.xp|0}`;
    }

    function readForm(){
      return {
        email: $("#pf_email").value.trim(),
        name: $("#pf_displayName").value.trim(),
        gender: $("#pf_gender").value,
        dob: $("#pf_dob").value||null,
        guardian: $("#pf_guardian").value.trim()||null,
        phone: $("#pf_phone").value.trim()||null,
        city: $("#pf_city").value.trim()||null,
        grade: $("#pf_grade").value.trim()||null
      };
    }
    function fillForm(u,base,cloud){
      const avatar=cloud?.avatarUrl||base?.avatarUrl||"/public/assets/avatar/NV1.webp";
      $("#pf_avatar_img").src=avatar;
      $("#pf_email").value=u.email||u.phoneNumber||"";
      $("#pf_displayName").value=u.displayName||(base&&base.name)||"";
      $("#pf_gender").value=cloud?.gender||"";
      $("#pf_dob").value=cloud?.dob||"";
      $("#pf_guardian").value=cloud?.guardian||"";
      $("#pf_phone").value=(u.phoneNumber||cloud?.phone||"");
      $("#pf_city").value=cloud?.city||"";
      $("#pf_grade").value=cloud?.grade||"";
      $("#owningHint").textContent = base?.avatarId ? `Avatar hi·ªán t·∫°i: ${base.avatarId}` : "";
      const headerAv = $("#avatarImg"); if (headerAv) headerAv.src = avatar;
      const who = $(".who"); if (who) who.textContent = ` ${u.email||u.phoneNumber||""}`;
    }

    /* ===== OTP ===== */
    let recaptcha, confirmationResult;
    function ensureRecaptcha(){ if(recaptcha) return recaptcha; recaptcha = new RecaptchaVerifier(auth,"recaptcha-container",{size:"invisible"}); return recaptcha; }
    async function sendOTP(){ const phone=$("#pf_phone").value.trim(); if(!phone) return toast("Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i tr∆∞·ªõc.",false); try{ ensureRecaptcha(); confirmationResult=await signInWithPhoneNumber(auth,phone,recaptcha); toast("ƒê√£ g·ª≠i OTP.",true);}catch{ toast("G·ª≠i OTP th·∫•t b·∫°i",false);} }
    async function verifyOTP(){ const code=$("#otp_code").value.trim(); if(!confirmationResult||!code) return toast("Ch∆∞a g·ª≠i OTP ho·∫∑c thi·∫øu m√£.",false); try{ await confirmationResult.confirm(code); toast("X√°c th·ª±c s·ªë ƒëi·ªán tho·∫°i th√†nh c√¥ng!",true);}catch{ toast("M√£ OTP sai/h·∫øt h·∫°n.",false);} }

    /* ===== Chest ===== */
    function randomReward(){ const t=Math.random(); if(t<.5) return{type:"coins",amount:50+Math.floor(Math.random()*151)}; if(t<.85) return{type:"xp",amount:20+Math.floor(Math.random()*81)}; return{type:"both",amount:[30+Math.floor(Math.random()*71),80+Math.floor(Math.random()*121)]}; }
    async function openChestHandler(uid){
      const cur=readLocalProfile(); if(!cur||cur.uid!==uid) return; const pf=cur.profile; if(!(pf.chests>0)) return toast("B·∫°n ch∆∞a c√≥ r∆∞∆°ng.",false);
      const rw=randomReward(); pf.chests=(pf.chests|0)-1;
      if(rw.type==="coins"){ pf.coins=(pf.coins|0)+rw.amount; $("#lastReward").textContent=`+${rw.amount} xu`; }
      else if(rw.type==="xp"){ pf.xp=(pf.xp|0)+rw.amount; $("#lastReward").textContent=`+${rw.amount} XP`; }
      else { pf.xp+=rw.amount[0]; pf.coins+=rw.amount[1]; $("#lastReward").textContent=`+${rw.amount[0]} XP, +${rw.amount[1]} xu`; }
      writeLocalProfile(uid,pf); renderKPI(pf); try{ await saveCloudProfile(uid,{xp:pf.xp|0,coins:pf.coins|0,chests:pf.chests|0}); }catch{}
      toast("ƒê√£ m·ªü r∆∞∆°ng!",true);
    }

    async function saveProfile(uid){
      const note=$("#saveNote"); const f=readForm(); note.hidden=false; note.textContent="ƒêang l∆∞u‚Ä¶";
      try{
        await saveCloudProfile(uid,{email:f.email||null,name:f.name||null,gender:f.gender||null,dob:f.dob||null,guardian:f.guardian||null,phone:f.phone||null,city:f.city||null,grade:f.grade||null});
        const cur=readLocalProfile(); if(cur&&cur.uid===uid){ cur.profile={...cur.profile, name:f.name||cur.profile.name}; writeLocalProfile(uid,cur.profile); }
        note.textContent="ƒê√£ l∆∞u h·ªì s∆°."; toast("L∆∞u h·ªì s∆° th√†nh c√¥ng",true);
      }catch{ note.textContent="Kh√¥ng l∆∞u ƒë∆∞·ª£c."; toast("L∆∞u h·ªì s∆° th·∫•t b·∫°i (Firestore Rules?)",false); }
    }

    async function refreshAll(uid){
      const cloud=await loadCloudProfile(uid);
      const local=readLocalProfile();
      const pf=local?.profile||{ name:"Player", coins:300, xp:0, chests:0, avatarId:"NV1", avatarUrl:"/public/assets/avatar/NV1.webp", unlocked:{avatars:{NV1:true}}, createdAt:Date.now() };
      const merged={ ...pf, ...(cloud||{}),
        name: cloud?.name||pf.name,
        coins:(cloud?.coins??pf.coins)|0, xp:(cloud?.xp??pf.xp)|0, chests:(cloud?.chests??pf.chests)|0,
        avatarId:cloud?.avatarId||pf.avatarId||"NV1",
        avatarUrl:cloud?.avatarUrl||pf.avatarUrl||"/public/assets/avatar/NV1.webp",
        unlocked: cloud?.unlocked || pf.unlocked || {avatars:{NV1:true}}
      };
      writeLocalProfile(uid,merged); renderKPI(merged);
      $("#pf_avatar_img").src=merged.avatarUrl; $("#owningHint").textContent = `Avatar hi·ªán t·∫°i: ${merged.avatarId}`;
      const headerAv=$("#avatarImg"); if (headerAv) headerAv.src=merged.avatarUrl;
      return {cloud,merged};
    }

    async function changePassword(){
      const u = auth.currentUser; const note = $("#pwNote");
      note.className = "note"; note.textContent = "";
      if (!u) { note.textContent = "Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc."; return; }
      const hasPasswordProvider = (u.providerData || []).some(p => p.providerId === "password");
      const cur = $("#pw_current").value, pw1 = $("#pw_new").value, pw2 = $("#pw_confirm").value;
      if (!pw1 || pw1.length < 8) { note.textContent = "M·∫≠t kh·∫©u m·ªõi c·∫ßn ‚â• 8 k√Ω t·ª±."; return; }
      if (pw1 !== pw2) { note.textContent = "M·∫≠t kh·∫©u m·ªõi kh√¥ng kh·ªõp."; return; }
      try {
        if (!hasPasswordProvider) {
          try { await reauthenticateWithPopup(u, new GoogleAuthProvider()); } catch(_) {}
          if (!u.email) { note.textContent = "T√†i kho·∫£n Google kh√¥ng c√≥ email x√°c th·ª±c ‚Äî kh√¥ng th·ªÉ th√™m m·∫≠t kh·∫©u."; note.className = "note bad"; return; }
          const cred = EmailAuthProvider.credential(u.email, pw1);
          await linkWithCredential(u, cred);
          note.textContent = "ƒê√£ th√™m m·∫≠t kh·∫©u cho t√†i kho·∫£n."; note.className = "note ok";
        } else {
          if (u.email) {
            if (!cur) { note.textContent = "Nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i ƒë·ªÉ x√°c th·ª±c."; return; }
            const cred = EmailAuthProvider.credential(u.email, cur);
            await reauthenticateWithCredential(u, cred);
          }
          await updatePassword(u, pw1);
          note.textContent = "ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng."; note.className = "note ok";
        }
        ["pw_current","pw_new","pw_confirm"].forEach(id => { const el=$("#"+id); if(el) el.value=""; });
      } catch (e) {
        const msg = (e && e.code ? e.code.replace("auth/","").replace(/-/g," ") : (e?.message||""));
        note.textContent = "Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t: " + msg; note.className = "note bad";
      }
    }

    /* ===== Shop Avatar ===== */
    const REMOTE_AVATAR_MANIFEST = "/public/content/avatar/avatar-manifest.json";
    let AVATAR_LIST = [];
    async function loadAvatarManifest(){
      if (AVATAR_LIST.length) return AVATAR_LIST;
      try{
        const r = await fetch(REMOTE_AVATAR_MANIFEST, { cache: "no-store" });
        const j = await r.json();
        AVATAR_LIST = Array.isArray(j?.avatars) ? j.avatars : (Array.isArray(j) ? j : []);
      }catch{
        AVATAR_LIST = [{ id:"NV1", title_vi:"NiNi b·∫°n nh·ªè", image:"/public/assets/avatar/NV1.webp", rarity:"common", price:0, xp_required:0, tags:["starter"] }];
      }
      return AVATAR_LIST;
    }
    function ensureProfileSkeleton(pf){
      pf.unlocked ??= {}; pf.unlocked.avatars ??= {};
      if (!pf.unlocked.avatars.NV1) pf.unlocked.avatars.NV1 = true;
      pf.avatarId ??= "NV1"; pf.avatarUrl ??= "/public/assets/avatar/NV1.webp";
    }
    function renderShopGrid(pf){
      const grid = $("#shopGrid"); const owned = pf.unlocked?.avatars || {};
      grid.innerHTML = AVATAR_LIST.map(av => {
        const has = !!owned[av.id];
        const needXP = Number(av.xp_required||0), price = Number(av.price||0);
        const canBuy = !has && (pf.coins|0)>=price && (pf.xp|0)>=needXP;
        return `
          <article class="avt-card">
            <img class="avt-card__img" loading="lazy" src="${av.image}" alt="${av.title_vi||av.id}">
            <div class="avt-card__body">
              <div class="avt-card__title">${av.title_vi||av.title_en||av.id}
                <span class="tag">${av.rarity||"common"}</span>
              </div>
              <div class="muted">${price>0?`Gi√°: <b>${price}</b> xu`:`Mi·ªÖn ph√≠`} ‚Ä¢ XP y√™u c·∫ßu: ${needXP|0}</div>
            </div>
            <div class="avt-card__foot">
              <button class="btn small" data-act="use" data-id="${av.id}" ${has?"":"disabled"}>D√πng</button>
              ${ has ? '<span class="pill-ghost">ƒê√£ s·ªü h·ªØu</span>' :
                `<button class="btn small solid" data-act="buy" data-id="${av.id}" ${canBuy?"":"disabled"}>Mua</button>`}
            </div>
          </article>`;
      }).join("");
      grid.querySelectorAll("[data-act='use']").forEach(b=>b.onclick=()=>setActiveAvatar(b.dataset.id));
      grid.querySelectorAll("[data-act='buy']").forEach(b=>b.onclick=()=>buyAvatar(b.dataset.id));
      const bal=$("#shopBalance"); if (bal) bal.textContent=`Xu: ${pf.coins|0} ‚Ä¢ XP: ${pf.xp|0}`;
    }
    async function openShop(){
      const u = auth.currentUser; if(!u) return;
      await loadAvatarManifest();
      const cur = readLocalProfile(); if(!cur||cur.uid!==u.uid) return;
      ensureProfileSkeleton(cur.profile);
      renderShopGrid(cur.profile);
      $("#shopModal").setAttribute("aria-hidden","false");
    }
    function closeShop(){ $("#shopModal").setAttribute("aria-hidden","true"); }
    async function setActiveAvatar(id){
      const u = auth.currentUser; if(!u) return;
      const cur = readLocalProfile(); if(!cur||cur.uid!==u.uid) return;
      ensureProfileSkeleton(cur.profile);
      const av = AVATAR_LIST.find(x=>x.id===id);
      if (!cur.profile.unlocked.avatars[id]) return toast("B·∫°n ch∆∞a s·ªü h·ªØu avatar n√†y.", false);
      cur.profile.avatarId = id;
      cur.profile.avatarUrl = av?.image || cur.profile.avatarUrl;
      writeLocalProfile(u.uid, cur.profile);
      $("#pf_avatar_img").src = cur.profile.avatarUrl;
      $("#owningHint").textContent = `Avatar hi·ªán t·∫°i: ${id}`;
      const headerAv=$("#avatarImg"); if (headerAv) headerAv.src=cur.profile.avatarUrl;
      try{ await saveCloudProfile(u.uid, { avatarId:id, avatarUrl:cur.profile.avatarUrl }); }catch{}
      toast("ƒê√£ ƒë·ªïi avatar!", true);
      renderShopGrid(cur.profile);
    }
    async function buyAvatar(id){
      const u = auth.currentUser; if(!u) return;
      const cur = readLocalProfile(); if(!cur||cur.uid!==u.uid) return;
      ensureProfileSkeleton(cur.profile);
      const av = AVATAR_LIST.find(x=>x.id===id); if(!av) return;
      const price = Number(av.price||0), needXP = Number(av.xp_required||0);
      if ((cur.profile.coins|0) < price || (cur.profile.xp|0) < needXP) return toast("Ch∆∞a ƒë·ªß ƒëi·ªÅu ki·ªán (xu / XP).", false);
      cur.profile.coins = (cur.profile.coins|0) - price;
      cur.profile.unlocked.avatars[id] = true;
      cur.profile.avatarId = id;
      cur.profile.avatarUrl = av.image || cur.profile.avatarUrl;
      writeLocalProfile(u.uid, cur.profile);
      renderKPI(cur.profile);
      $("#pf_avatar_img").src = cur.profile.avatarUrl;
      $("#owningHint").textContent = `Avatar hi·ªán t·∫°i: ${id}`;
      const headerAv=$("#avatarImg"); if (headerAv) headerAv.src=cur.profile.avatarUrl;
      try{
        await saveCloudProfile(u.uid, {
          coins: cur.profile.coins|0,
          avatarId: id,
          avatarUrl: cur.profile.avatarUrl,
          unlocked: cur.profile.unlocked
        });
      }catch{}
      toast("Mua & √°p d·ª•ng avatar th√†nh c√¥ng!", true);
      renderShopGrid(cur.profile);
    }
    async function giftUnlock(id){
      const u = auth.currentUser; if(!u) return;
      const cur = readLocalProfile(); if(!cur||cur.uid!==u.uid) return;
      await loadAvatarManifest(); ensureProfileSkeleton(cur.profile);
      const av = AVATAR_LIST.find(x=>x.id===id);
      if (!av) return toast("M√£ qu√† kh√¥ng h·ª£p l·ªá.", false);
      if (cur.profile.unlocked.avatars[id]) return setActiveAvatar(id);
      cur.profile.unlocked.avatars[id] = true;
      cur.profile.avatarId = id; cur.profile.avatarUrl = av.image || cur.profile.avatarUrl;
      writeLocalProfile(u.uid, cur.profile);
      $("#pf_avatar_img").src = cur.profile.avatarUrl;
      $("#owningHint").textContent = `Avatar hi·ªán t·∫°i: ${id}`;
      const headerAv=$("#avatarImg"); if (headerAv) headerAv.src=cur.profile.avatarUrl;
      try{ await saveCloudProfile(u.uid, { avatarId:id, avatarUrl:cur.profile.avatarUrl, unlocked: cur.profile.unlocked }); }catch{}
      toast("ƒê√£ nh·∫≠n qu√† avatar!", true);
      renderShopGrid(cur.profile);
    }

    /* ===== G·∫Øn s·ª± ki·ªán UI (c√≥ ki·ªÉm tra null) ===== */
    $("#btnSendOtp")   ?.addEventListener("click", sendOTP);
    $("#btnVerifyOtp") ?.addEventListener("click", verifyOTP);
    $("#btnOpenChest") ?.addEventListener("click", async()=>{ const u=auth.currentUser; if(!u) return toast("Vui l√≤ng ƒëƒÉng nh·∫≠p.",false); await openChestHandler(u.uid); });
    $("#btnRefresh")   ?.addEventListener("click", async()=>{ const u=auth.currentUser; if(!u) return; await refreshAll(u.uid); toast("ƒê·ªìng b·ªô xong.",true); });
    $("#btnChangePw")  ?.addEventListener("click", changePassword);
    $("#profileForm")  ?.addEventListener("submit", async e=>{ e.preventDefault(); const u=auth.currentUser; if(!u) return toast("Vui l√≤ng ƒëƒÉng nh·∫≠p.",false); await saveProfile(u.uid); });

    // >>> S·ª¨A L·∫†I ID N√öT ƒêƒÇNG XU·∫§T (ƒë√∫ng l√† #btnLogout)
    $("#btnLogout")?.addEventListener("click", async ()=>{
      try{ await signOut(auth); }catch{} finally{
        localStorage.removeItem(LS_ACCOUNTS);
        localStorage.removeItem(LS_ACTIVE);
        localStorage.setItem("NINI_AUTH_LOGGED_IN", "0");
        localStorage.setItem("NINI_SIGNED_OUT_AT", String(Date.now()));
        location.replace("/");
      }
    });

    // Shop events
    $("#btnPickAvatar")?.addEventListener("click", openShop);
    $("#shopModal")?.addEventListener("click", (e)=>{ if (e.target.matches("[data-close]") || e.target===e.currentTarget) closeShop(); });
    $("#btnGiftClaim")?.addEventListener("click", async ()=>{
      const id = ($("#giftInput").value||"").trim(); if(!id) return; await giftUnlock(id); $("#giftInput").value = "";
    });

    // Inline header toggle (ƒë·ªÉ ·∫©n/hi·ªán nhanh theo flag)
    (function applyHeaderAuthUI(){
      function render(){
        const logged = localStorage.getItem('NINI_AUTH_LOGGED_IN') === '1';
        document.querySelectorAll('[data-show="in"]').forEach(el=>el.style.display = logged ? '' : 'none');
        document.querySelectorAll('[data-show="out"]').forEach(el=>el.style.display = logged ? 'none' : '');
      }
      render(); window.addEventListener('nini:authchange', render);
    })();

    // N·∫øu c√≥ ?gift=AVT_ID th√¨ auto claim
    const giftId = new URLSearchParams(location.search).get("gift");

    // ===== Guard: ch∆∞a login th√¨ tr·∫£ v·ªÅ "/" =====
    onAuthStateChanged(auth, async (user)=>{
      const hint=$("#authHint");
      if(!user){ location.replace("/"); return; }
      $("#profileForm")?.querySelectorAll("input,select,button").forEach(el=>el.disabled=false);
      const { merged } = await refreshAll(user.uid);
      fillForm(user, merged, merged);
      hint.innerHTML=`ƒêƒÉng nh·∫≠p: <strong>${user.email||user.phoneNumber||"t√†i kho·∫£n"}</strong>. B·∫°n c√≥ th·ªÉ c·∫≠p nh·∫≠t h·ªì s∆° v√† xem th√†nh t√≠ch t·∫°i ƒë√¢y.`;
      localStorage.setItem("NINI_AUTH_LOGGED_IN","1");
      window.dispatchEvent(new Event('nini:authchange'));
      if (giftId) { await giftUnlock(giftId); history.replaceState({}, "", location.pathname); }
    });
  </script>
</body>
</html>




