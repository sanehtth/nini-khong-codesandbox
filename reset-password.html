<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NiNi — Đặt lại mật khẩu</title>
  <link rel="stylesheet" href="/public/theme/nini-base.css" />
</head>
<body class="spring">
  <div class="stage">
    <div class="glass" style="max-width:560px; margin:auto; padding:24px;">
      <h2>Đặt lại mật khẩu</h2>
      <p>Nhập mật khẩu mới cho tài khoản của bạn.</p>

      <label class="field">
        <span>Mật khẩu mới</span>
        <input id="pw1" type="password" placeholder="••••••••" autocomplete="new-password" />
      </label>

      <label class="field">
        <span>Nhập lại mật khẩu</span>
        <input id="pw2" type="password" placeholder="••••••••" autocomplete="new-password" />
      </label>

      <div style="display:flex; gap:12px; margin-top:16px;">
        <button id="btnApply" class="btn">Đổi mật khẩu</button>
        <a class="btn ghost" href="/#home">Đóng</a>
      </div>
    </div>
  </div>

  <script src="/public/theme/nini-config.js"></script>
  <script type="module" src="/public/js/nini-fb.mjs"></script>

  <script type="module">
    const qs = new URLSearchParams(location.search);
    const oob = qs.get('oobCode');

    const pw1 = document.getElementById('pw1');
    const pw2 = document.getElementById('pw2');
    const btn = document.getElementById('btnApply');

    function pickResetApi() {
      const fb = window.NINI?.fb || {};
      // Một số dự án đặt tên khác nhau — lần lượt thử:
      return fb.confirmPasswordReset || fb.resetPasswordConfirm || fb.confirmReset || null;
    }

    btn.onclick = async () => {
      try {
        const p1 = pw1.value.trim();
        const p2 = pw2.value.trim();
        if (!p1 || p1.length < 6) return alert('Mật khẩu cần tối thiểu 6 ký tự.');
        if (p1 !== p2) return alert('Mật khẩu nhập lại chưa khớp.');

        if (!oob) throw new Error('Thiếu oobCode.');
        const api = pickResetApi();
        if (!api) throw new Error('FB API missing: confirmPasswordReset');

        await api.call(window.NINI?.fb, oob, p1);
        alert('Đổi mật khẩu thành công. Bạn có thể đăng nhập lại.');
        location.href = '/#home';
      } catch (e) {
        alert('Không đổi được mật khẩu: ' + (e?.message || e));
      }
    };
  </script>
</body>
</html>
