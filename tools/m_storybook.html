<!-- BOOK FIELDS -->
<div class = "app">
<section class="panel">
  <h2>Book</h2>

  <div class="grid grid-2">
    <label>IDBook
      <input id="IDBook" type="text" placeholder="VD: BK001">
    </label>

    <label>L_imageBia (Link ảnh bìa)
      <input id="L_imageBia" type="text" placeholder="https://.../cover.webp">
    </label>

    <label>little_vi (Tên sách tiếng Việt)
      <input id="little_vi" type="text" placeholder="NiNi và khu rừng mùa đông">
    </label>

    <label>little_en (Book title in English)
      <input id="little_en" type="text" placeholder="NiNi in the Winter Forest">
    </label>

    <label>auther
      <input id="auther" type="text" placeholder="Tên tác giả">
    </label>

    <label>design
      <input id="design" type="text" placeholder="Tên họa sĩ/thiết kế">
    </label>
  </section>
<!-- CONTROLS -->
<section class="panel">
  <h2>Actions</h2>
  <div class="row" style="gap:8px; flex-wrap:wrap">
    <button id="btnSave"   class="btn">Lưu</button>
    <button id="btnAdd"    class="btn">Add Page</button>
    <button id="btnDel"    class="btn">Delete Page</button>
    <button id="btnImport" class="btn">Import JSON</button>
    <button id="btnExport" class="btn">Export JSON</button>
    <input id="fileImport" type="file" accept="application/json" style="display:none">
  </div>
</section>
</div>
<!-- PAGES RENDERED HERE -->
<section class="panel">
  <h2>Pages</h2>
  <div id="pagesWrap"></div>
</section>
<script>
</div>  
/* ===== Helpers ===== */
const $ = (id) => document.getElementById(id);
const download = (name, data) => {
  const blob = new Blob([data], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = name;
  a.click();
  URL.revokeObjectURL(a.href);
};

/* ===== State ===== */
let book = {
  IDBook: "", little_vi: "", little_en: "",
  auther: "", design: "", L_imageBia: "",
  pages: []
};

/* ===== Bind BOOK inputs -> state ===== */
function bindBookInputs(){
  const map = ["IDBook","little_vi","little_en","auther","design","L_imageBia"];
  map.forEach(k=>{
    $(k).value = book[k] || "";
    $(k).addEventListener('input', e => { book[k] = e.target.value; autosave(); });
  });
}

/* ===== Render Pages ===== */
function renderPages(){
  const wrap = $("pagesWrap");
  wrap.innerHTML = "";

  if (!book.pages || book.pages.length === 0){
    const first = {TDBook:"", IDPage:"", noidung_vi:"", noidung_en:"", L_image_P:"", L_sound_vi:"", L_sound_en:""};
    book.pages = [first];
  }

  book.pages.forEach((p, idx) => {
    const card = document.createElement('div');
    card.className = 'card';
    card.style.marginBottom = '12px';
    card.innerHTML = `
      <div class="row" style="justify-content:space-between; align-items:center">
        <strong>Page #${idx+1}</strong>
        <div class="row" style="gap:6px">
          <button class="btn btn-sm" data-act="up">↑</button>
          <button class="btn btn-sm" data-act="down">↓</button>
        </div>
      </div>

      <div class="grid grid-2" style="margin-top:8px">
        <label>TDBook
          <input data-f="TDBook" type="text" placeholder="Tiêu đề trang">
        </label>
        <label>IDPage
          <input data-f="IDPage" type="text" placeholder="VD: P001">
        </label>

        <label>noidung_vi
          <textarea data-f="noidung_vi" rows="3" placeholder="Nội dung tiếng Việt"></textarea>
        </label>
        <label>noidung_en
          <textarea data-f="noidung_en" rows="3" placeholder="English content"></textarea>
        </label>

        <label>L_image_P (Link ảnh trang)
          <input data-f="L_image_P" type="text" placeholder="https://.../page.webp">
        </label>
        <label>L_sound_vi (Link audio VI)
          <input data-f="L_sound_vi" type="text" placeholder="https://.../voice-vi.mp3">
        </label>

        <label>L_sound_en (Link audio EN)
          <input data-f="L_sound_en" type="text" placeholder="https://.../voice-en.mp3">
        </label>
      </div>
    `;
    wrap.appendChild(card);

    // fill values
    card.querySelectorAll('[data-f]').forEach(inp=>{
      const key = inp.dataset.f;
      inp.value = p[key] || "";
      inp.addEventListener('input', e=>{
        book.pages[idx][key] = e.target.value;
        autosave();
      });
    });

    // up / down
    const btnUp = card.querySelector('[data-act="up"]');
    const btnDn = card.querySelector('[data-act="down"]');
    btnUp.disabled = (idx === 0);
    btnDn.disabled = (idx === book.pages.length-1);

    btnUp.addEventListener('click', ()=>{
      if (idx === 0) return;
      [book.pages[idx-1], book.pages[idx]] = [book.pages[idx], book.pages[idx-1]];
      renderPages(); autosave();
    });
    btnDn.addEventListener('click', ()=>{
      if (idx === book.pages.length-1) return;
      [book.pages[idx+1], book.pages[idx]] = [book.pages[idx], book.pages[idx+1]];
      renderPages(); autosave();
    });
  });
}

/* ===== Actions ===== */
$("btnAdd").addEventListener('click', ()=>{
  book.pages.push({TDBook:"", IDPage:"", noidung_vi:"", noidung_en:"", L_image_P:"", L_sound_vi:"", L_sound_en:""});
  renderPages(); autosave();
});

$("btnDel").addEventListener('click', ()=>{
  if (!book.pages.length) return;
  if (!confirm("Xoá trang cuối cùng?")) return;
  book.pages.pop();
  renderPages(); autosave();
});

$("btnSave").addEventListener('click', ()=>{
  localStorage.setItem('storybook_draft_full', JSON.stringify(book));
  alert("Đã lưu bản nháp (localStorage).");
});

$("btnExport").addEventListener('click', ()=>{
  const json = JSON.stringify(book, null, 2);
  download((book.IDBook || 'book') + '.json', json);
});

$("btnImport").addEventListener('click', ()=> $("fileImport").click());
$("fileImport").addEventListener('change', async (e)=>{
  const file = e.target.files[0]; if (!file) return;
  try{
    const text = await file.text();
    const data = JSON.parse(text);

    // Ghép dữ liệu vào state (cho phép import thiếu field)
    book = {
      IDBook: data.IDBook || "",
      little_vi: data.little_vi || "",
      little_en: data.little_en || "",
      auther: data.auther || "",
      design: data.design || "",
      L_imageBia: data.L_imageBia || "",
      pages: Array.isArray(data.pages) ? data.pages.map(p => ({
        TDBook: p.TDBook || "",
        IDPage: p.IDPage || "",
        noidung_vi: p.noidung_vi || "",
        noidung_en: p.noidung_en || "",
        L_image_P: p.L_image_P || "",
        L_sound_vi: p.L_sound_vi || "",
        L_sound_en: p.L_sound_en || ""
      })) : []
    };

    bindBookInputs();
    renderPages();
    autosave();
  }catch(err){
    alert("Import lỗi: " + err.message);
  } finally {
    e.target.value = "";
  }
});

/* ===== Autosave ===== */
let autosaveTimer;
function autosave(){
  clearTimeout(autosaveTimer);
  autosaveTimer = setTimeout(()=>{
    localStorage.setItem('storybook_draft_full', JSON.stringify(book));
  }, 400);
}

/* ===== Boot from localStorage (nếu có) ===== */
(function init(){
  const saved = localStorage.getItem('storybook_draft_full');
  if (saved){
    try{ book = {...book, ...JSON.parse(saved)} }catch{}
  }
  bindBookInputs();
  renderPages();
})();
</script>
