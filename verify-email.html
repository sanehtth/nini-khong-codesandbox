<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NiNi — Xác nhận email</title>
  <link rel="stylesheet" href="/public/theme/nini-base.css" />
</head>
<body class="spring">
  <div class="stage">
    <div class="glass" style="max-width:560px; margin:auto; padding:24px;">
      <h2>Xác nhận email</h2>
      <p id="status">Đang xác nhận email của bạn…</p>
      <div style="margin-top:16px;">
        <a id="btnBack" class="btn" href="/#home" style="display:none;">Về trang chủ</a>
      </div>
    </div>
  </div>

  <script src="/public/theme/nini-config.js"></script>
  <script type="module" src="/public/js/nini-fb.mjs"></script>

  <script type="module">
    const statusEl = document.getElementById('status');
    const btnBack  = document.getElementById('btnBack');

    const qs = new URLSearchParams(location.search);
    const oob = qs.get('oobCode');
    const email = qs.get('email'); // nếu bạn có đính kèm email trong continueUrl

    function pickVerifyApi() {
      const fb = window.NINI?.fb || {};
      // Các dự án có thể đặt tên khác nhau cho hàm xác nhận:
      return fb.applyActionCode || fb.verifyEmail || fb.confirmEmail || null;
    }

    async function sendResetIfPossible() {
      if (!email) return;
      try {
        if (window.NINI?.fb?.sendReset) {
          await window.NINI.fb.sendReset(email);
        } else {
          await fetch('/.netlify/functions/send-reset', {
            method:'POST',
            headers:{'content-type':'application/json'},
            body: JSON.stringify({
              email,
              continueUrl: location.origin + '/auth-action.html'
            })
          });
        }
      } catch (_) { /* ignore, không chặn flow */ }
    }

    (async () => {
      try {
        if (!oob) throw new Error('Thiếu oobCode.');
        const api = pickVerifyApi();
        if (!api) throw new Error('FB API missing: applyActionCode');

        await api.call(window.NINI?.fb, oob);
        statusEl.textContent = 'Email của bạn đã được xác nhận thành công.';

        // Nếu đây là flow đăng ký, bạn muốn gửi tiếp email reset để user đặt mật khẩu:
        await sendResetIfPossible();

        btnBack.style.display = '';
      } catch (e) {
        statusEl.textContent = 'Xác nhận thất bại: ' + (e?.message || e);
        btnBack.style.display = '';
      }
    })();
  </script>
</body>
</html>
